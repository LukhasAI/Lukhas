# Hidden Gems Integration Automation Makefile
# Usage: make -f Makefile.hidden_gems <target>

.PHONY: help status fix-issues integrate-batch validate-all report clean

# Colors for output
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
BLUE := \033[0;34m
PURPLE := \033[0;35m
CYAN := \033[0;36m
RESET := \033[0m

help: ## Show this help message
	@echo "$(CYAN)Hidden Gems Integration Commands:$(RESET)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  $(GREEN)%-20s$(RESET) %s\n", $$1, $$2}'

status: ## Show current integration status
	@echo "$(CYAN)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(RESET)"
	@echo "$(CYAN)    Hidden Gems Integration Status$(RESET)"
	@echo "$(CYAN)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(RESET)"
	@echo ""
	@echo "$(YELLOW)Checking module counts...$(RESET)"
	@find candidate -name "*.py" -type f | wc -l | xargs echo "  Candidate modules:"
	@find labs -name "*.py" -type f 2>/dev/null | wc -l | xargs echo "  Labs modules:"
	@find matriz -name "*.py" -type f | wc -l | xargs echo "  MATRIZ modules:"
	@find core -name "*.py" -type f | wc -l | xargs echo "  Core modules:"
	@echo ""
	@echo "$(YELLOW)Running import test...$(RESET)"
	@python3 -m pytest tests/integration/test_top25_hidden_gems_integration.py::TestTop25HiddenGemsIntegration::test_all_modules_importable_smoke -q 2>&1 | \
		grep -E "(passed|failed)" || echo "  Test not found"
	@echo ""
	@echo "$(YELLOW)MATRIZ Schemas:$(RESET)"
	@find matriz/schemas -name "*_schema.json" | wc -l | xargs echo "  Schema files:"

fix-logger-issues: ## Fix logger keyword argument issues
	@echo "$(CYAN)Fixing logger issues in reflection modules...$(RESET)"
	@for file in matriz/consciousness/reflection/*.py; do \
		echo "  Fixing $$file"; \
		sed -i '' 's/logger\.\([a-z]*\)(\(.*\), \([a-z_]*\)=\([^,)]*\))/logger.\1(\2 + ": \3=%s", \4)/g' $$file; \
	done
	@echo "$(GREEN)âœ“ Logger issues fixed$(RESET)"

fix-import-issues: ## Fix common import issues
	@echo "$(CYAN)Fixing import issues...$(RESET)"
	@find . -name "*.py" -type f -exec sed -i '' 's/from MATRIZ\./from matriz\./g' {} \;
	@find . -name "*.py" -type f -exec sed -i '' 's/import MATRIZ/import matriz/g' {} \;
	@find . -name "*.py" -type f -exec sed -i '' 's/from candidate\./from /g' {} \;
	@find . -name "*.py" -type f -exec sed -i '' 's/from labs\./from /g' {} \;
	@echo "$(GREEN)âœ“ Import issues fixed$(RESET)"

generate-schema: ## Generate MATRIZ schema for a module (use MODULE=path/to/module.py)
	@if [ -z "$(MODULE)" ]; then \
		echo "$(RED)Error: MODULE not specified. Use: make generate-schema MODULE=path/to/module.py$(RESET)"; \
		exit 1; \
	fi
	@echo "$(CYAN)Generating schema for $(MODULE)...$(RESET)"
	@python3 scripts/generate_matriz_schema.py $(MODULE)
	@echo "$(GREEN)âœ“ Schema generated$(RESET)"

validate-module: ## Validate MATRIZ readiness for a module (use MODULE=module_name)
	@if [ -z "$(MODULE)" ]; then \
		echo "$(RED)Error: MODULE not specified. Use: make validate-module MODULE=module_name$(RESET)"; \
		exit 1; \
	fi
	@echo "$(CYAN)Validating $(MODULE)...$(RESET)"
	@python3 -c "from scripts.validate_readiness import MatrizReadinessValidator; \
		validator = MatrizReadinessValidator('$(MODULE)'); \
		report = validator.validate(); \
		print(f'  Score: {report[\"readiness_score\"]}%'); \
		print(f'  Ready: {report[\"ready\"]}'); \
		import json; \
		print(json.dumps(report, indent=2))"

integrate-next-batch: ## Integrate next batch of 25 modules
	@echo "$(CYAN)Integrating next batch of hidden gems...$(RESET)"
	@python3 -c "from scripts.integrate_batch import integrate_next_batch; integrate_next_batch()"
	@echo "$(GREEN)âœ“ Batch integration complete$(RESET)"

validate-all: ## Validate all integrated modules
	@echo "$(CYAN)Validating all modules...$(RESET)"
	@python3 scripts/validate_all_modules.py
	@echo "$(GREEN)âœ“ Validation complete$(RESET)"

test-imports: ## Test all module imports
	@echo "$(CYAN)Testing module imports...$(RESET)"
	@python3 -m pytest tests/integration/test_hidden_gems_imports.py -v

test-matriz: ## Test MATRIZ compliance
	@echo "$(CYAN)Testing MATRIZ compliance...$(RESET)"
	@python3 -m pytest tests/integration/test_matriz_compliance.py -v

generate-batch-schemas: ## Generate schemas for current batch
	@echo "$(CYAN)Generating schemas for current batch...$(RESET)"
	@for file in $$(cat .lukhas_runs/current_batch.txt); do \
		echo "  Generating schema for $$file"; \
		python3 scripts/generate_matriz_schema.py $$file || true; \
	done
	@echo "$(GREEN)âœ“ Batch schemas generated$(RESET)"

create-batch-tests: ## Create tests for current batch
	@echo "$(CYAN)Creating tests for current batch...$(RESET)"
	@for file in $$(cat .lukhas_runs/current_batch.txt); do \
		module=$$(basename $$file .py); \
		echo "  Creating test for $$module"; \
		python3 scripts/create_module_test.py $$module || true; \
	done
	@echo "$(GREEN)âœ“ Batch tests created$(RESET)"

report: ## Generate comprehensive integration report
	@echo "$(CYAN)Generating integration report...$(RESET)"
	@python3 scripts/generate_integration_report.py
	@echo ""
	@echo "$(CYAN)Integration Summary:$(RESET)"
	@python3 -c "import json; \
		with open('hidden_gems_integration_report.json') as f: \
			r = json.load(f); \
			print(f'  Total modules: {r.get(\"total_modules\", 0)}'); \
			print(f'  Integrated: {r.get(\"integrated\", 0)}'); \
			print(f'  Failed: {r.get(\"failed\", 0)}'); \
			print(f'  Success rate: {r.get(\"success_rate\", 0):.1f}%')"

batch-move: ## Move next batch from candidate to production
	@echo "$(CYAN)Moving batch to production...$(RESET)"
	@python3 -c "from scripts.batch_move import move_next_batch; move_next_batch()"

batch-fix: ## Apply all fixes to current batch
	@echo "$(CYAN)Applying fixes to current batch...$(RESET)"
	@make -f Makefile.hidden_gems fix-logger-issues
	@make -f Makefile.hidden_gems fix-import-issues
	@echo "$(GREEN)âœ“ All fixes applied$(RESET)"

batch-integrate: ## Complete integration pipeline for next batch
	@echo "$(PURPLE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(RESET)"
	@echo "$(PURPLE)    Starting Batch Integration Pipeline$(RESET)"
	@echo "$(PURPLE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(RESET)"
	@echo ""
	@make -f Makefile.hidden_gems batch-move
	@make -f Makefile.hidden_gems batch-fix
	@make -f Makefile.hidden_gems generate-batch-schemas
	@make -f Makefile.hidden_gems create-batch-tests
	@make -f Makefile.hidden_gems validate-all
	@make -f Makefile.hidden_gems report
	@echo ""
	@echo "$(GREEN)âœ… Batch integration complete!$(RESET)"

quick-check: ## Quick health check of integration
	@echo "$(CYAN)Quick Integration Check$(RESET)"
	@echo "$(CYAN)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(RESET)"
	@python3 -c "import sys; sys.path.insert(0, '.'); \
		success = 0; failed = 0; \
		modules = ['matriz.consciousness.reflection.dreamseed_unified', \
			'matriz.consciousness.reflection.id_reasoning_engine', \
			'core.governance.consent_ledger', \
			'core.guardian_system_integration']; \
		for m in modules: \
			try: \
				__import__(m); \
				print(f'  âœ… {m}'); \
				success += 1; \
			except: \
				print(f'  âŒ {m}'); \
				failed += 1; \
		print(f'\n  Success: {success}/{success+failed}')"

clean-pycache: ## Clean Python cache files
	@echo "$(CYAN)Cleaning Python cache...$(RESET)"
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@echo "$(GREEN)âœ“ Cache cleaned$(RESET)"

commit-batch: ## Commit current batch integration
	@echo "$(CYAN)Committing batch integration...$(RESET)"
	@git add -A
	@git commit -m "feat(hidden-gems): integrate batch of hidden gems modules" \
		-m "Problem: Modules scattered in candidate/labs need production integration" \
		-m "Solution: Move modules to production, fix imports, generate schemas" \
		-m "Impact: Increased module availability for MATRIZ ecosystem"
	@echo "$(GREEN)âœ“ Batch committed$(RESET)"

# Advanced targets

full-integration: ## Run complete integration pipeline for all remaining modules
	@echo "$(PURPLE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(RESET)"
	@echo "$(PURPLE)    FULL INTEGRATION PIPELINE$(RESET)"
	@echo "$(PURPLE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(RESET)"
	@while [ -f .lukhas_runs/next_batch.txt ]; do \
		echo "$(CYAN)Processing next batch...$(RESET)"; \
		make -f Makefile.hidden_gems batch-integrate; \
		sleep 2; \
	done
	@echo "$(GREEN)ðŸŽ‰ ALL MODULES INTEGRATED!$(RESET)"

doctor: ## Diagnose integration issues
	@echo "$(CYAN)Running integration diagnostics...$(RESET)"
	@python3 scripts/diagnose_integration.py

rollback-batch: ## Rollback last batch integration
	@echo "$(YELLOW)Rolling back last batch...$(RESET)"
	@git reset --hard HEAD~1
	@echo "$(GREEN)âœ“ Rollback complete$(RESET)"

# Utilities

.lukhas_runs/current_batch.txt: ## Generate current batch file
	@mkdir -p .lukhas_runs
	@python3 -c "from scripts.batch_manager import get_current_batch; \
		batch = get_current_batch(); \
		with open('.lukhas_runs/current_batch.txt', 'w') as f: \
			f.write('\n'.join(batch))"

scripts/%.py: ## Ensure script exists
	@if [ ! -f $@ ]; then \
		echo "$(RED)Error: Script $@ not found$(RESET)"; \
		echo "$(YELLOW)Creating stub script...$(RESET)"; \
		mkdir -p scripts; \
		echo '#!/usr/bin/env python3' > $@; \
		echo 'print("Script not implemented")' >> $@; \
		chmod +x $@; \
	fi

# Default target
all: status

# Include main Makefile if it exists
-include Makefile