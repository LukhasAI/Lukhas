import pytest
import subprocess
import sys

def test_vulnerability_scan():
    """
    Tests that there are no known vulnerabilities in the installed packages
    by running pip-audit as a subprocess.
    """
    # Note: This test requires network access to fetch the vulnerability database.
    # It might be slow and is probably best run in a separate CI job.

    try:
        # We run pip-audit as a subprocess to avoid any potential import issues
        # or conflicts with the test runner.
        result = subprocess.run(
            [sys.executable, "-m", "pip_audit"],
            capture_output=True,
            text=True,
            check=False  # We don't want to raise an exception on non-zero exit codes
        )

        # pip-audit exits with a non-zero status code if vulnerabilities are found.
        assert result.returncode == 0, f"pip-audit found vulnerabilities:\n{result.stdout}\n{result.stderr}"

    except FileNotFoundError:
        pytest.skip("pip-audit not found, skipping vulnerability scan.")
    except Exception as e:
        pytest.fail(f"An unexpected error occurred during vulnerability scan: {e}")
