{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://lukhas.ai/schemas/guardian_schema.json",
  "title": "LUKHAS Guardian Decision Envelope",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema_version",
    "decision",
    "subject",
    "context",
    "metrics",
    "enforcement",
    "audit",
    "integrity"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "pattern": "^2\\.\\d+\\.\\d+$",
      "description": "Semver for schema; major=2 for Constellation era."
    },
    "decision": { "$ref": "#/$defs/DecisionBlock" },
    "subject": { "$ref": "#/$defs/Subject" },
    "context": { "$ref": "#/$defs/Context" },
    "metrics": { "$ref": "#/$defs/Metrics" },
    "enforcement": { "$ref": "#/$defs/Enforcement" },
    "audit": { "$ref": "#/$defs/Audit" },
    "reasons": {
      "type": "array",
      "minItems": 0,
      "items": { "$ref": "#/$defs/Reason" },
      "description": "Machine-parsable reasons for decision."
    },
    "rule_evaluations": {
      "type": "array",
      "minItems": 0,
      "items": { "$ref": "#/$defs/RuleEval" },
      "description": "Per-rule evaluation trace for audit."
    },
    "approvals": {
      "type": "array",
      "minItems": 0,
      "items": { "$ref": "#/$defs/Approval" },
      "description": "Dual-approval (four-eyes) metadata for overrides."
    },
    "redactions": {
      "type": "object",
      "additionalProperties": { "type": "string" },
      "description": "Map of path->reason for redacted fields."
    },
    "extensions": {
      "type": "object",
      "additionalProperties": true,
      "description": "Forward-compatible vendor or experiment fields. Must not conflict with core."
    },
    "integrity": { "$ref": "#/$defs/Integrity" },
    "debug": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "trace_id": { "type": "string", "minLength": 8, "maxLength": 128 },
        "span_id": { "type": "string", "minLength": 8, "maxLength": 128 }
      }
    }
  },
  "$defs": {
    "DecisionBlock": {
      "type": "object",
      "additionalProperties": false,
      "required": ["status", "policy", "timestamp"],
      "properties": {
        "status": {
          "type": "string",
          "enum": ["allow", "deny", "challenge", "quarantine", "error"],
          "description": "Effective decision; 'error' must be treated as deny (fail-closed)."
        },
        "policy": {
          "type": "string",
          "minLength": 1,
          "description": "Canonical policy/DSL package and version, e.g. ethics/v4.3.1"
        },
        "severity": {
          "type": "string",
          "enum": ["low", "medium", "high", "critical"],
          "default": "low"
        },
        "confidence": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "UTC ISO-8601 with 'Z'."
        },
        "ttl_seconds": {
          "type": "integer",
          "minimum": 0,
          "description": "How long this decision can be cached."
        }
      }
    },
    "Subject": {
      "type": "object",
      "additionalProperties": false,
      "required": ["correlation_id", "actor", "operation"],
      "properties": {
        "correlation_id": {
          "type": "string",
          "pattern": "^[a-f0-9\\-]{16,64}$"
        },
        "lane": {
          "type": "string",
          "enum": ["candidate", "lukhas", "MATRIZ", "integration", "production", "canary", "experimental"]
        },
        "canary_percent": {
          "type": "number",
          "minimum": 0,
          "maximum": 100
        },
        "actor": {
          "type": "object",
          "additionalProperties": false,
          "required": ["type", "id"],
          "properties": {
            "type": { "type": "string", "enum": ["user", "service", "system"] },
            "id": { "type": "string", "minLength": 1 },
            "tier": { "type": "string", "enum": ["T1","T2","T3","T4","T5"] }
          }
        },
        "operation": {
          "type": "object",
          "additionalProperties": false,
          "required": ["name"],
          "properties": {
            "name": { "type": "string", "minLength": 1 },
            "resource": { "type": "string" },
            "parameters": { "type": "object", "additionalProperties": true }
          }
        }
      }
    },
    "Context": {
      "type": "object",
      "additionalProperties": false,
      "required": ["environment", "features"],
      "properties": {
        "environment": {
          "type": "object",
          "additionalProperties": false,
          "required": ["region", "runtime"],
          "properties": {
            "region": { "type": "string" },
            "runtime": { "type": "string", "enum": ["dev","ci","staging","prod"] },
            "version": { "type": "string" }
          }
        },
        "features": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enforcement_enabled": { "type": "boolean", "default": true },
            "emergency_active": { "type": "boolean", "default": false },
            "kill_switch_path": { "type": "string" }
          }
        }
      }
    },
    "Metrics": {
      "type": "object",
      "additionalProperties": false,
      "required": ["latency_ms"],
      "properties": {
        "latency_ms": { "type": "number", "minimum": 0 },
        "risk_score": { "type": "number", "minimum": 0, "maximum": 1 },
        "drift_score": { "type": "number", "minimum": 0, "maximum": 1 },
        "quota_remaining": { "type": "integer", "minimum": 0 },
        "counters": {
          "type": "object",
          "additionalProperties": { "type": "integer" }
        }
      }
    },
    "Enforcement": {
      "type": "object",
      "additionalProperties": false,
      "required": ["mode"],
      "properties": {
        "mode": { "type": "string", "enum": ["dark", "canary", "enforced"] },
        "actions": {
          "type": "array",
          "items": { "type": "string", "enum": ["block","mask","redact","rate_limit","quarantine","log_only"] }
        }
      }
    },
    "Audit": {
      "type": "object",
      "additionalProperties": false,
      "required": ["event_id", "timestamp"],
      "properties": {
        "event_id": { "type": "string", "pattern": "^[a-f0-9\\-]{16,64}$" },
        "timestamp": { "type": "string", "format": "date-time" },
        "source_system": { "type": "string" },
        "audit_trail": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["step", "timestamp"],
            "properties": {
              "step": { "type": "string" },
              "timestamp": { "type": "string", "format": "date-time" },
              "duration_ms": { "type": "number", "minimum": 0 },
              "metadata": { "type": "object", "additionalProperties": true }
            }
          }
        }
      }
    },
    "Reason": {
      "type": "object",
      "additionalProperties": false,
      "required": ["code", "message"],
      "properties": {
        "code": { "type": "string", "pattern": "^[A-Z0-9_\\.\\-]{2,64}$" },
        "message": { "type": "string" },
        "docs": { "type": "string", "format": "uri", "nullable": true }
      }
    },
    "RuleEval": {
      "type": "object",
      "additionalProperties": false,
      "required": ["rule_id", "result"],
      "properties": {
        "rule_id": { "type": "string" },
        "result": { "type": "string", "enum": ["pass","fail","error","skip"] },
        "duration_ms": { "type": "number", "minimum": 0 },
        "inputs_hash": { "type": "string", "pattern": "^[a-f0-9]{64}$" }
      }
    },
    "Approval": {
      "type": "object",
      "additionalProperties": false,
      "required": ["approver", "timestamp", "scope"],
      "properties": {
        "approver": { "type": "string" },
        "timestamp": { "type": "string", "format": "date-time" },
        "scope": { "type": "string", "enum": ["temporary_override","policy_exception"] },
        "ticket": { "type": "string" }
      }
    },
    "Integrity": {
      "type": "object",
      "additionalProperties": false,
      "required": ["content_sha256"],
      "properties": {
        "content_sha256": { "type": "string", "pattern": "^[a-f0-9]{64}$" },
        "signature": {
          "type": "object",
          "additionalProperties": false,
          "required": ["alg","kid","sig"],
          "properties": {
            "alg": { "type": "string", "enum": ["ed25519","es256","rs256"] },
            "kid": { "type": "string" },
            "sig": { "type": "string", "pattern": "^[A-Za-z0-9_\\-]+$" }
          }
        }
      }
    }
  }
}