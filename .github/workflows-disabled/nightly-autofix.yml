name: Nightly T4 Autofix

on:
  schedule:
    # Run at 2:17 AM UTC daily (avoid common CI peak hours)
    - cron: '17 2 * * *'
  workflow_dispatch: # Allow manual triggering
    inputs:
      create_pr:
        description: 'Create PR for significant changes'
        required: false
        default: 'false'
        type: boolean

jobs:
  nightly-autofix:
    runs-on: ubuntu-latest
    if: github.repository_owner == 'LukhasAI'

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          # Install additional tools for nightly automation
          pip install bandit jq ruff libcst

      - name: Configure git
        run: |
          git config --global user.name 'T4 Autofix Bot'
          git config --global user.email 'autofix@lukhas.ai'

      - name: Run nightly autofix
        env:
          CREATE_NIGHTLY_PR: ${{ inputs.create_pr || 'false' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SELF_HEALING_DISABLED: 1  # Enable CI safety mode
          CI: true
        run: |
          chmod +x tools/ci/nightly_autofix.sh
          ./tools/ci/nightly_autofix.sh

      - name: Needs-golden label
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BR="autofix/$(date +%Y%m%d)"
          python tools/ci/needs_golden.py > /tmp/ng.json || true
          PR_NUMBER=$(gh pr list --head "$BR" --json number --jq '.[0].number' 2>/dev/null || echo "")
          NEED=$(jq -r '.needs_golden | length' /tmp/ng.json 2>/dev/null || echo 0)
          if [ "$NEED" != "0" ] && [ -n "$PR_NUMBER" ]; then
            gh pr edit "$PR_NUMBER" --add-label "needs-golden" || true
          fi

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: nightly-autofix-reports
          path: |
            data/nightly_autofix_*.log
            data/security_scan.json
            reports/todos/summary.md
            reports/dashboard/would-change-report.json
            reports/dashboard/change-budget.json
            reports/dashboard/dashboard_state.json
          retention-days: 30

      - name: Comment on recent PRs if issues found
        if: failure()
        run: |
          echo "Nightly autofix failed. Consider adding autofix-pending labels to recent PRs."
          # This could be extended to actually comment on PRs
