name: Python Syntax Monitor

on:
  push:
    branches: [main, develop]
  pull_request:
    types: [opened, synchronize, reopened]
  schedule:
    # Run daily at 3:30 AM UTC
    - cron: '30 3 * * *'
  workflow_dispatch:
    inputs:
      auto_fix:
        description: 'Automatically fix syntax errors'
        required: false
        default: 'true'
        type: boolean

jobs:
  syntax-check:
    name: Check Python Syntax
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install ruff black isort
          # Install AST-based tools for deep syntax analysis
          pip install libcst parso autopep8

      - name: Run custom syntax fixer (dry-run)
        id: syntax_check
        run: |
          echo "ðŸ” Scanning for syntax errors..."
          python tools/fix_syntax_errors.py . --dry-run --json > syntax_report.json || true

          # Extract metrics
          TOTAL_FILES=$(jq -r '.total_files_scanned' syntax_report.json)
          FILES_WITH_ERRORS=$(jq -r '.files_with_errors' syntax_report.json)
          FIXES_NEEDED=$(jq -r '.fixes_applied' syntax_report.json)

          echo "files_scanned=$TOTAL_FILES" >> $GITHUB_OUTPUT
          echo "files_with_errors=$FILES_WITH_ERRORS" >> $GITHUB_OUTPUT
          echo "fixes_needed=$FIXES_NEEDED" >> $GITHUB_OUTPUT

          # Create summary
          echo "## ðŸ“Š Syntax Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Files Scanned:** $TOTAL_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- **Files with Errors:** $FILES_WITH_ERRORS" >> $GITHUB_STEP_SUMMARY
          echo "- **Fixes Needed:** $FIXES_NEEDED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$FILES_WITH_ERRORS" -gt 0 ]; then
            echo "### ðŸ”§ Fix Types Needed:" >> $GITHUB_STEP_SUMMARY
            jq -r '.fixes_by_type | to_entries[] | "- **\(.key)**: \(.value)"' syntax_report.json >> $GITHUB_STEP_SUMMARY
          fi

      - name: Run Ruff syntax check
        id: ruff_check
        run: |
          echo "ðŸ” Running Ruff syntax validation..."
          ruff check . --output-format json > ruff_report.json || true

          # Count issues
          RUFF_ERRORS=$(jq 'length' ruff_report.json)
          echo "ruff_errors=$RUFF_ERRORS" >> $GITHUB_OUTPUT

          if [ "$RUFF_ERRORS" -gt 0 ]; then
            echo "### ðŸ› Ruff Issues Found:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            ruff check . --output-format text | head -20 >> $GITHUB_STEP_SUMMARY || true
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Apply fixes if requested
        if: |
          (github.event_name == 'workflow_dispatch' && github.event.inputs.auto_fix == 'true') ||
          (github.event_name == 'schedule')
        run: |
          echo "ðŸ”§ Applying automatic syntax fixes..."

          # Apply custom syntax fixes
          python tools/fix_syntax_errors.py . --report fixed_syntax_report.json

          # Apply ruff fixes
          ruff check . --fix --exit-zero

          # Format with black
          black . --quiet || true

          # Check if there are changes
          if [[ -n $(git status --porcelain) ]]; then
            echo "changes_made=true" >> $GITHUB_ENV

            # Generate detailed change report
            echo "### âœ… Fixes Applied:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            git diff --stat >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "changes_made=false" >> $GITHUB_ENV
            echo "### âœ… No fixes needed!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create fix commit
        if: env.changes_made == 'true' && github.event_name == 'schedule'
        run: |
          git config --global user.name 'Syntax Monitor Bot'
          git config --global user.email 'syntax-bot@lukhas.ai'

          git add .
          git commit -m "fix: automated syntax fixes $(date +%Y-%m-%d)

          Applied automatic syntax fixes:
          - Fixed curly quotes and encoding issues
          - Corrected invalid imports
          - Fixed docstring formatting
          - Resolved indentation problems

          Generated by: .github/workflows/syntax-monitor.yml"

          git push

      - name: Create PR with fixes
        if: |
          env.changes_made == 'true' &&
          github.event_name == 'pull_request'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix: automated syntax fixes for PR #${{ github.event.pull_request.number }}"
          title: "ðŸ”§ Automated Syntax Fixes for PR #${{ github.event.pull_request.number }}"
          body: |
            ## ðŸ¤– Automated Syntax Fixes

            This PR contains automated syntax fixes for PR #${{ github.event.pull_request.number }}.

            ### Fixes Applied:
            - âœ… Corrected quote issues (curly quotes â†’ straight quotes)
            - âœ… Fixed invalid module imports
            - âœ… Resolved docstring formatting
            - âœ… Fixed indentation and whitespace issues

            ### Next Steps:
            1. Review the changes
            2. Merge if satisfied
            3. Close if not needed

            ---
            *Generated by Python Syntax Monitor*
          branch: "auto-fix/syntax-pr-${{ github.event.pull_request.number }}"
          delete-branch: true
          labels: |
            automated
            syntax-fix

      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.syntax_check.outputs.files_with_errors > 0
        uses: actions/github-script@v6
        with:
          script: |
            const filesWithErrors = '${{ steps.syntax_check.outputs.files_with_errors }}';
            const fixesNeeded = '${{ steps.syntax_check.outputs.fixes_needed }}';

            const comment = `## ðŸ” Python Syntax Check Results

            Found **${filesWithErrors} files** with syntax issues requiring **${fixesNeeded} fixes**.

            ### Recommended Actions:
            1. Run \`python tools/fix_syntax_errors.py .\` locally
            2. Run \`ruff check . --fix\`
            3. Commit the fixes

            Or trigger the automated fix workflow to create a fix PR.

            ---
            *Python Syntax Monitor*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: syntax-reports
          path: |
            syntax_report.json
            fixed_syntax_report.json
            ruff_report.json
          retention-days: 30

      - name: Fail if errors and not auto-fixing
        if: |
          steps.syntax_check.outputs.files_with_errors > 0 &&
          github.event_name == 'pull_request' &&
          !(github.event_name == 'workflow_dispatch' && github.event.inputs.auto_fix == 'true')
        run: |
          echo "âŒ Syntax errors found. Please fix them before merging."
          exit 1

  syntax-metrics:
    name: Track Syntax Health Metrics
    runs-on: ubuntu-latest
    needs: syntax-check
    if: github.event_name == 'schedule' || github.event_name == 'push'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate metrics
        run: |
          mkdir -p metrics

          # Create metrics file
          cat > metrics/syntax_health.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "files_scanned": ${{ needs.syntax-check.outputs.files_scanned || 0 }},
            "files_with_errors": ${{ needs.syntax-check.outputs.files_with_errors || 0 }},
            "fixes_needed": ${{ needs.syntax-check.outputs.fixes_needed || 0 }},
            "ruff_errors": ${{ needs.syntax-check.outputs.ruff_errors || 0 }},
            "branch": "${{ github.ref_name }}",
            "commit": "${{ github.sha }}"
          }
          EOF

          # Append to historical metrics
          cat metrics/syntax_health.json >> metrics/syntax_health_history.jsonl

      - name: Upload metrics
        uses: actions/upload-artifact@v3
        with:
          name: syntax-metrics
          path: metrics/
          retention-days: 90
