name: Claude Code PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  claude-review:
    name: AI-Assisted Code Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Get PR diff
        id: pr-diff
        run: |
          # Get PR number from event
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            PR_NUMBER=${{ github.event.issue.number }}
          else
            PR_NUMBER=${{ github.event.pull_request.number }}
          fi

          gh pr diff $PR_NUMBER > pr-diff.txt
          gh pr view $PR_NUMBER --json title,body,files > pr-metadata.json
          echo "Diff size: $(wc -l < pr-diff.txt) lines"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Check for review trigger
        id: check-trigger
        run: |
          TRIGGER=false
          # Check PR body for @claude mention
          if echo '${{ github.event.pull_request.body }}' | grep -qi '@claude'; then
            TRIGGER=true
          fi
          # Check issue comment (general PR comment)
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            if echo '${{ github.event.comment.body }}' | grep -qi '@claude'; then
              # Only trigger on PR comments, not issues
              if [ "${{ github.event.issue.pull_request }}" != "" ]; then
                TRIGGER=true
              fi
            fi
          fi
          # Check review comment (line-specific comment)
          if [ "${{ github.event_name }}" = "pull_request_review_comment" ]; then
            if echo '${{ github.event.comment.body }}' | grep -qi '@claude'; then
              TRIGGER=true
            fi
          fi
          echo "trigger=$TRIGGER" >> $GITHUB_OUTPUT

      - name: Detect requested model
        if: steps.check-trigger.outputs.trigger == 'true'
        id: detect-model
        run: |
          # Default to Claude Sonnet 4.0
          MODEL="claude-3-5-sonnet-20241022"

          # Check for model specification in PR body or comment
          PR_TEXT="${{ github.event.pull_request.body }}"
          COMMENT_TEXT="${{ github.event.comment.body }}"

          if echo "$PR_TEXT $COMMENT_TEXT" | grep -qi "sonnet.*3\.7\|3\.7.*sonnet"; then
            MODEL="claude-3-7-sonnet-20250219"
          elif echo "$PR_TEXT $COMMENT_TEXT" | grep -qi "sonnet.*4\.5\|4\.5.*sonnet"; then
            MODEL="claude-sonnet-4-5-20250929"
          elif echo "$PR_TEXT $COMMENT_TEXT" | grep -qi "sonnet.*4\.0\|4\.0.*sonnet"; then
            MODEL="claude-3-5-sonnet-20241022"
          fi

          echo "model=$MODEL" >> $GITHUB_OUTPUT
          echo "Using model: $MODEL"

      - name: Claude Code Review via Perplexity API
        if: steps.check-trigger.outputs.trigger == 'true'
        id: claude-review
        env:
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          CLAUDE_MODEL: ${{ steps.detect-model.outputs.model }}
        run: |
          DIFF=$(cat pr-diff.txt | head -c 40000)
          PR_FILES=$(jq -r '.files[].filename' pr-metadata.json | head -20 | tr '\n' ', ')

          REVIEW_PROMPT="You are an expert code reviewer for the LUKHAS AI platform. Review this pull request:

          **PR Title**: ${PR_TITLE}

          **Files Changed**: ${PR_FILES}

          **Diff**:
          \`\`\`diff
          ${DIFF}
          \`\`\`

          Provide a comprehensive review covering:
          1. **Architecture Review**: Check alignment with LUKHAS lane-based architecture (candidate/, core/, lukhas/)
          2. **Code Quality**: Identify bugs, security issues, and code smells
          3. **Lane Boundary Compliance**: Ensure no invalid imports across lanes
          4. **Best Practices**: Suggest improvements following LUKHAS standards
          5. **Security**: Flag any security concerns

          Format as markdown with specific line references where applicable. Be concise but thorough."

          cat > perplexity-request.json <<REQEOF
          {
            "model": "${CLAUDE_MODEL}",
            "messages": [
              {
                "role": "user",
                "content": $(echo "$REVIEW_PROMPT" | jq -Rs .)
              }
            ],
            "max_tokens": 4096,
            "temperature": 0.2,
            "stream": false
          }
          REQEOF

          echo "Requesting review with model: ${CLAUDE_MODEL}"

          curl -X POST https://api.perplexity.ai/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${PERPLEXITY_API_KEY}" \
            -d @perplexity-request.json \
            -o response.json

          if jq -e '.error' response.json > /dev/null; then
            ERROR=$(jq -r '.error.message // .error' response.json)
            echo "‚ùå API Error: $ERROR"
            echo "Error calling Perplexity API. Check logs for details." > claude-review.md
            exit 1
          fi

          jq -r '.choices[0].message.content // "Error: Unable to generate review"' response.json > claude-review.md

          echo "‚úì Review generated successfully with ${CLAUDE_MODEL}"

      - name: Post Claude Review as Comment
        if: steps.check-trigger.outputs.trigger == 'true'
        uses: actions/github-script@v7
        env:
          CLAUDE_MODEL: ${{ steps.detect-model.outputs.model }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('claude-review.md', 'utf8');
            const model = process.env.CLAUDE_MODEL;

            const modelName = model.includes('3-7') ? 'Claude Sonnet 3.7' :
                            model.includes('4-5') ? 'Claude Sonnet 4.5' :
                            'Claude Sonnet 4.0';

            const comment = `## ü§ñ Claude Code Review

            ${review}

            ---

            <details>
            <summary>‚ÑπÔ∏è Review Details</summary>

            - **Model**: ${modelName} (\`${model}\`)
            - **API**: Perplexity AI
            - **Triggered by**: @claude mention

            To request a specific model version, mention it in your request:
            - \`@claude review with 3.7\` ‚Üí Claude Sonnet 3.7
            - \`@claude review with 4.0\` ‚Üí Claude Sonnet 4.0 (default)
            - \`@claude review with 4.5\` ‚Üí Claude Sonnet 4.5

            </details>

            *Powered by [Claude via Perplexity](https://docs.perplexity.ai/)*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Add claude-reviewed label
        if: steps.check-trigger.outputs.trigger == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['claude-reviewed', 'ai-assisted']
            });

      - name: Skip notice
        if: steps.check-trigger.outputs.trigger != 'true'
        run: echo "Claude review not triggered. Add @claude to PR description or comment to request review."
