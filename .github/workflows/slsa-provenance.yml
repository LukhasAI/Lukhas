name: SLSA Provenance

on:
  push:
    branches: [main]
  release:
    types: [created]

permissions:
  contents: read
  id-token: write  # For cosign
  packages: write

jobs:
  build-provenance:
    runs-on: ubuntu-latest
    outputs:
      artifact_hashes: ${{ steps.build_artifacts.outputs.hashes }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build in-toto cosign

      - name: Build artifacts for SLSA modules
        id: build_artifacts
        run: |
          # Build wheel for distribution
          python -m build

          # Create checksums and store them as a JSON string in an output variable
          cd dist
          hashes_json=$(python -c "import json, hashlib, glob; print(json.dumps({f: hashlib.sha256(open(f, 'rb').read()).hexdigest() for f in glob.glob('*.whl')}))")
          echo "hashes=$hashes_json" >> "$GITHUB_OUTPUT"
          cd ..

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Generate SLSA provenance
        id: generate_provenance
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Generate in-toto provenance for first 10 modules
          python3 scripts/slsa/generate_provenance.py \
            --modules "matriz,lukhas.identity,lukhas.memory,core.governance,bridge.llm_wrappers,lukhas.consciousness,candidate.core,core.orchestration,lukhas.api,tools.ci" \
            --output provenance.json \
            --artifact-hashes '${{ steps.build_artifacts.outputs.hashes }}'

      - name: Sign provenance with Cosign
        run: |
          # Keyless signing with GitHub OIDC
          cosign sign-blob \
            --bundle provenance.cosign.bundle \
            provenance.json

      - name: Upload provenance
        uses: actions/upload-artifact@v3
        with:
          name: slsa-provenance
          path: |
            provenance.json
            provenance.cosign.bundle
            dist/

      - name: Verify provenance (self-check)
        run: |
          cosign verify-blob \
            --bundle provenance.cosign.bundle \
            --certificate-identity-regexp="^https://github.com/LukhasAI/Lukhas" \
            --certificate-oidc-issuer="https://token.actions.githubusercontent.com" \
            provenance.json

  slsa-verification:
    runs-on: ubuntu-latest
    needs: build-provenance

    steps:
      - name: Download provenance
        uses: actions/download-artifact@v3
        with:
          name: slsa-provenance

      - name: Display provenance
        run: |
          echo "SLSA Provenance generated and signed"
          cat provenance.json | jq .

      - name: Check SLSA level
        run: |
          # Verify we meet SLSA Level 2
          python3 -c "
import json, sys
with open('provenance.json') as f:
    prov = json.load(f)
    print(f'Build type: {prov.get("buildType")}')
    print(f'Builder ID: {prov.get("builder", {}).get("id")}')
    # Check that the subject digest is not the placeholder
    for subject in prov.get('subject', []):
        digest = subject.get('digest', {}).get('sha256')
        if not digest or digest == '...':
            print(f'❌ ERROR: Invalid subject digest found for {subject.get("name")}')
            sys.exit(1)
    print('✅ SLSA Level 2 requirements met')
          "
