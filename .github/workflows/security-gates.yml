name: üîí Security Gates - T4/0.01% Excellence

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened, ready_for_review]
  schedule:
    # Run comprehensive security audit daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      security_level:
        description: 'Security audit level'
        required: false
        default: 'standard'
        type: choice
        options:
          - 'standard'
          - 'strict'
          - 't4-excellence'
      fail_on_warnings:
        description: 'Fail on warnings (T4/0.01% strict mode)'
        required: false
        default: false
        type: boolean

# Security-focused environment variables
env:
  # T4/0.01% Excellence Configuration
  T4_EXCELLENCE_REQUIRED: true
  SECURITY_AUDIT_TIMEOUT: 1800  # 30 minutes
  GUARDIAN_MODE: production
  LUKHAS_SECURITY_LEVEL: maximum

  # Failure Thresholds for T4/0.01% Excellence
  MAX_CRITICAL_VULNERABILITIES: 0
  MAX_HIGH_VULNERABILITIES: 0
  MAX_MEDIUM_VULNERABILITIES: 1  # 0.01% tolerance
  MAX_CRYPTO_FAILURES: 0
  MIN_EXCELLENCE_SCORE: 99.99

  # Security Tool Configuration
  SEMGREP_TIMEOUT: 300
  CRYPTO_TEST_TIMEOUT: 600
  DEPENDENCY_SCAN_TIMEOUT: 300

# Ensure security gates run on secure runners
concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: false  # Never cancel security audits

jobs:
  # =============================================================================
  # Pre-Security Validation
  # =============================================================================
  pre-security-checks:
    name: üîç Pre-Security Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      should-run-security: ${{ steps.validate.outputs.should-run }}
      security-level: ${{ steps.validate.outputs.security-level }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for security analysis

      - name: Validate security requirements
        id: validate
        run: |
          echo "üîí Validating security requirements..."

          # Check if this is a security-sensitive change
          SECURITY_PATHS=(
            "lukhas/identity/"
            "lukhas/governance/"
            "lukhas/consciousness/"
            ".semgrep/"
            "scripts/security"
            "tests/security/"
          )

          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD || echo "")
          SECURITY_CHANGE=false

          for path in "${SECURITY_PATHS[@]}"; do
            if echo "$CHANGED_FILES" | grep -q "$path"; then
              SECURITY_CHANGE=true
              echo "Security-sensitive change detected in: $path"
              break
            fi
          done

          # Determine security level
          SECURITY_LEVEL="standard"
          if [[ "${{ github.event.inputs.security_level }}" != "" ]]; then
            SECURITY_LEVEL="${{ github.event.inputs.security_level }}"
          elif [[ "$SECURITY_CHANGE" == "true" ]] || [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            SECURITY_LEVEL="t4-excellence"
          fi

          echo "should-run=true" >> $GITHUB_OUTPUT
          echo "security-level=$SECURITY_LEVEL" >> $GITHUB_OUTPUT

          echo "‚úÖ Security validation complete"
          echo "  Security Level: $SECURITY_LEVEL"
          echo "  Security Change: $SECURITY_CHANGE"

  # =============================================================================
  # Static Security Analysis with Semgrep
  # =============================================================================
  semgrep-security-scan:
    name: üîç Semgrep Security Analysis
    runs-on: ubuntu-latest
    needs: pre-security-checks
    timeout-minutes: 15

    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python for security tools
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Semgrep
        run: |
          pip install semgrep==1.45.0
          semgrep --version

      - name: Run comprehensive Semgrep security scan
        id: semgrep
        run: |
          echo "üîí Running Semgrep security analysis..."

          # Create output directory
          mkdir -p security-reports

          # Run Semgrep with comprehensive rules
          semgrep \
            --config=.semgrep.yml \
            --config=.semgrep/lukhas-security.yaml \
            --json \
            --output=security-reports/semgrep-results.json \
            --timeout=${{ env.SEMGREP_TIMEOUT }} \
            --verbose \
            --strict \
            . || SEMGREP_EXIT_CODE=$?

          # Process results
          if [[ -f "security-reports/semgrep-results.json" ]]; then
            # Count findings by severity
            CRITICAL_COUNT=$(jq '[.results[] | select(.extra.severity == "ERROR")] | length' security-reports/semgrep-results.json)
            HIGH_COUNT=$(jq '[.results[] | select(.extra.severity == "WARNING")] | length' security-reports/semgrep-results.json)
            MEDIUM_COUNT=$(jq '[.results[] | select(.extra.severity == "INFO")] | length' security-reports/semgrep-results.json)
            TOTAL_COUNT=$(jq '.results | length' security-reports/semgrep-results.json)

            echo "üìä Semgrep Security Results:"
            echo "  Critical/High: $CRITICAL_COUNT"
            echo "  Medium: $HIGH_COUNT"
            echo "  Low/Info: $MEDIUM_COUNT"
            echo "  Total: $TOTAL_COUNT"

            # Check T4/0.01% thresholds
            FAILED=false
            if [[ $CRITICAL_COUNT -gt ${{ env.MAX_CRITICAL_VULNERABILITIES }} ]]; then
              echo "‚ùå CRITICAL: $CRITICAL_COUNT critical vulnerabilities found (max: ${{ env.MAX_CRITICAL_VULNERABILITIES }})"
              FAILED=true
            fi

            if [[ $HIGH_COUNT -gt ${{ env.MAX_HIGH_VULNERABILITIES }} ]]; then
              echo "‚ùå HIGH: $HIGH_COUNT high vulnerabilities found (max: ${{ env.MAX_HIGH_VULNERABILITIES }})"
              FAILED=true
            fi

            if [[ $MEDIUM_COUNT -gt ${{ env.MAX_MEDIUM_VULNERABILITIES }} ]]; then
              echo "‚ö†Ô∏è  MEDIUM: $MEDIUM_COUNT medium vulnerabilities found (max: ${{ env.MAX_MEDIUM_VULNERABILITIES }})"
            fi

            # Save metrics
            echo "critical-count=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
            echo "high-count=$HIGH_COUNT" >> $GITHUB_OUTPUT
            echo "medium-count=$MEDIUM_COUNT" >> $GITHUB_OUTPUT
            echo "total-count=$TOTAL_COUNT" >> $GITHUB_OUTPUT
            echo "failed=$FAILED" >> $GITHUB_OUTPUT

            if [[ "$FAILED" == "true" ]]; then
              echo "‚ùå Semgrep security scan failed T4/0.01% requirements"
              exit 1
            fi
          else
            echo "‚ö†Ô∏è  No Semgrep results file generated"
            echo "failed=true" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "‚úÖ Semgrep security scan completed successfully"

      - name: Upload Semgrep results to GitHub Security
        if: always() && steps.semgrep.outputs.failed != 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: security-reports/semgrep-results.json
          category: semgrep

      - name: Upload Semgrep artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-security-results
          path: security-reports/
          retention-days: 30

  # =============================================================================
  # Cryptographic Hygiene Tests
  # =============================================================================
  crypto-hygiene-tests:
    name: üîê Cryptographic Hygiene Validation
    runs-on: ubuntu-latest
    needs: pre-security-checks
    timeout-minutes: 20

    strategy:
      matrix:
        python-version: ['3.9', '3.11']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio pytest-timeout
          pip install cryptography PyJWT bcrypt
          pip install -e .

      - name: Run cryptographic hygiene tests
        id: crypto-tests
        run: |
          echo "üîê Running cryptographic hygiene tests..."

          # Create test results directory
          mkdir -p test-reports

          # Run crypto hygiene tests with strict requirements
          python -m pytest \
            tests/security/test_crypto_hygiene.py \
            -v \
            --tb=short \
            --timeout=${{ env.CRYPTO_TEST_TIMEOUT }} \
            --junitxml=test-reports/crypto-hygiene.xml \
            --disable-warnings \
            -x || CRYPTO_EXIT_CODE=$?

          if [[ ${CRYPTO_EXIT_CODE:-0} -eq 0 ]]; then
            echo "‚úÖ All cryptographic hygiene tests passed"
            echo "crypto-tests-passed=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Cryptographic hygiene tests failed"
            echo "crypto-tests-passed=false" >> $GITHUB_OUTPUT

            # For T4/0.01% excellence, crypto failures are critical
            if [[ "${{ needs.pre-security-checks.outputs.security-level }}" == "t4-excellence" ]]; then
              echo "‚ùå CRITICAL: Crypto hygiene failure in T4/0.01% mode"
              exit 1
            fi
          fi

      - name: Upload crypto test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crypto-hygiene-results-${{ matrix.python-version }}
          path: test-reports/
          retention-days: 30

  # =============================================================================
  # Dependency Security Scanning
  # =============================================================================
  dependency-security-scan:
    name: üì¶ Dependency Security Analysis
    runs-on: ubuntu-latest
    needs: pre-security-checks
    timeout-minutes: 15

    permissions:
      security-events: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install security scanning tools
        run: |
          pip install --upgrade pip
          pip install safety bandit pip-audit

      - name: Run Safety dependency check
        id: safety
        continue-on-error: true
        run: |
          echo "üîí Running Safety dependency security scan..."

          mkdir -p security-reports

          # Generate requirements file if not exists
          if [[ ! -f requirements.txt ]]; then
            pip freeze > requirements.txt
          fi

          # Run Safety scan
          safety check \
            --json \
            --output security-reports/safety-report.json \
            --file requirements.txt || SAFETY_EXIT_CODE=$?

          # Process Safety results
          if [[ -f "security-reports/safety-report.json" ]]; then
            VULN_COUNT=$(jq '.vulnerabilities | length' security-reports/safety-report.json 2>/dev/null || echo "0")
            echo "üìä Safety scan found $VULN_COUNT vulnerabilities"
            echo "safety-vulnerabilities=$VULN_COUNT" >> $GITHUB_OUTPUT

            if [[ $VULN_COUNT -gt 0 ]]; then
              echo "‚ö†Ô∏è  Dependencies with known vulnerabilities found"
              echo "safety-passed=false" >> $GITHUB_OUTPUT
            else
              echo "‚úÖ No known vulnerable dependencies found"
              echo "safety-passed=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "safety-passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Run pip-audit
        id: pip-audit
        continue-on-error: true
        run: |
          echo "üîí Running pip-audit vulnerability scan..."

          pip-audit \
            --format=json \
            --output=security-reports/pip-audit.json \
            --require requirements.txt || PIP_AUDIT_EXIT_CODE=$?

          if [[ -f "security-reports/pip-audit.json" ]]; then
            echo "‚úÖ pip-audit scan completed"
          fi

      - name: Run Bandit SAST scan
        id: bandit
        continue-on-error: true
        run: |
          echo "üîí Running Bandit static security analysis..."

          bandit \
            -r lukhas/ scripts/ \
            -f json \
            -o security-reports/bandit-report.json \
            -ll \
            --exclude=tests/ || BANDIT_EXIT_CODE=$?

          if [[ -f "security-reports/bandit-report.json" ]]; then
            HIGH_ISSUES=$(jq '[.results[] | select(.issue_severity == "HIGH")] | length' security-reports/bandit-report.json)
            MEDIUM_ISSUES=$(jq '[.results[] | select(.issue_severity == "MEDIUM")] | length' security-reports/bandit-report.json)

            echo "üìä Bandit found $HIGH_ISSUES high and $MEDIUM_ISSUES medium severity issues"
            echo "bandit-high=$HIGH_ISSUES" >> $GITHUB_OUTPUT
            echo "bandit-medium=$MEDIUM_ISSUES" >> $GITHUB_OUTPUT

            if [[ $HIGH_ISSUES -gt 0 ]]; then
              echo "bandit-passed=false" >> $GITHUB_OUTPUT
            else
              echo "bandit-passed=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "bandit-passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload dependency scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-security-results
          path: security-reports/
          retention-days: 30

  # =============================================================================
  # Comprehensive Security Audit
  # =============================================================================
  comprehensive-security-audit:
    name: üõ°Ô∏è Comprehensive Security Audit
    runs-on: ubuntu-latest
    needs: [pre-security-checks, semgrep-security-scan, crypto-hygiene-tests, dependency-security-scan]
    if: always()
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML requests structlog
          pip install -e .

      - name: Run comprehensive security audit
        id: security-audit
        env:
          SECURITY_LEVEL: ${{ needs.pre-security-checks.outputs.security-level }}
          FAIL_ON_WARNINGS: ${{ github.event.inputs.fail_on_warnings || 'false' }}
        run: |
          echo "üõ°Ô∏è Running comprehensive security audit..."

          # Make audit script executable
          chmod +x scripts/security_audit.py

          # Run security audit with appropriate strictness
          AUDIT_ARGS=""
          if [[ "$SECURITY_LEVEL" == "t4-excellence" ]] || [[ "$FAIL_ON_WARNINGS" == "true" ]]; then
            AUDIT_ARGS="--fail-on-warnings"
          fi

          # Run the audit
          python scripts/security_audit.py \
            --project-root . \
            --output security-audit-report.json \
            --format json \
            $AUDIT_ARGS || AUDIT_EXIT_CODE=$?

          # Also generate human-readable report
          python scripts/security_audit.py \
            --project-root . \
            --output security-audit-report.txt \
            --format text \
            $AUDIT_ARGS || true

          # Process audit results
          if [[ -f "security-audit-report.json" ]]; then
            EXCELLENCE_SCORE=$(jq -r '.summary.excellence_score' security-audit-report.json)
            T4_COMPLIANCE=$(jq -r '.summary.t4_compliance' security-audit-report.json)
            CRITICAL_FAILURES=$(jq -r '.summary.critical_failures' security-audit-report.json)
            TOTAL_FAILURES=$(jq -r '.summary.failures' security-audit-report.json)

            echo "üìä Security Audit Results:"
            echo "  Excellence Score: ${EXCELLENCE_SCORE}%"
            echo "  T4/0.01% Compliance: $T4_COMPLIANCE"
            echo "  Critical Failures: $CRITICAL_FAILURES"
            echo "  Total Failures: $TOTAL_FAILURES"

            # Save outputs
            echo "excellence-score=$EXCELLENCE_SCORE" >> $GITHUB_OUTPUT
            echo "t4-compliance=$T4_COMPLIANCE" >> $GITHUB_OUTPUT
            echo "critical-failures=$CRITICAL_FAILURES" >> $GITHUB_OUTPUT
            echo "total-failures=$TOTAL_FAILURES" >> $GITHUB_OUTPUT

            # Check T4/0.01% requirements
            if [[ "$T4_COMPLIANCE" == "false" ]]; then
              echo "‚ùå FAILED: T4/0.01% excellence requirements not met"
              echo "audit-passed=false" >> $GITHUB_OUTPUT

              # Display summary from text report
              if [[ -f "security-audit-report.txt" ]]; then
                echo "üìÑ Security Audit Summary:"
                head -50 security-audit-report.txt
              fi

              exit 1
            else
              echo "‚úÖ T4/0.01% excellence requirements met!"
              echo "audit-passed=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ùå Security audit failed to generate report"
            echo "audit-passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Upload security audit reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: comprehensive-security-audit
          path: |
            security-audit-report.json
            security-audit-report.txt
          retention-days: 30

  # =============================================================================
  # Security Gates Summary and Enforcement
  # =============================================================================
  security-gates-summary:
    name: üéØ Security Gates - Final Validation
    runs-on: ubuntu-latest
    needs: [
      pre-security-checks,
      semgrep-security-scan,
      crypto-hygiene-tests,
      dependency-security-scan,
      comprehensive-security-audit
    ]
    if: always()

    steps:
      - name: Evaluate security gates
        id: evaluate
        run: |
          echo "üéØ Evaluating security gates for T4/0.01% excellence..."

          # Collect results from all jobs
          SEMGREP_FAILED="${{ needs.semgrep-security-scan.outputs.failed }}"
          CRYPTO_PASSED="${{ needs.crypto-hygiene-tests.outputs.crypto-tests-passed }}"
          AUDIT_PASSED="${{ needs.comprehensive-security-audit.outputs.audit-passed }}"
          T4_COMPLIANCE="${{ needs.comprehensive-security-audit.outputs.t4-compliance }}"
          EXCELLENCE_SCORE="${{ needs.comprehensive-security-audit.outputs.excellence-score }}"

          # Summary
          echo "üìä Security Gates Summary:"
          echo "  Semgrep Analysis: $([ "$SEMGREP_FAILED" == "true" ] && echo "‚ùå FAILED" || echo "‚úÖ PASSED")"
          echo "  Crypto Hygiene: $([ "$CRYPTO_PASSED" == "true" ] && echo "‚úÖ PASSED" || echo "‚ùå FAILED")"
          echo "  Security Audit: $([ "$AUDIT_PASSED" == "true" ] && echo "‚úÖ PASSED" || echo "‚ùå FAILED")"
          echo "  Excellence Score: ${EXCELLENCE_SCORE:-0}%"
          echo "  T4/0.01% Compliance: $T4_COMPLIANCE"

          # Determine overall status
          OVERALL_PASSED=true
          FAILURE_REASONS=()

          if [[ "$SEMGREP_FAILED" == "true" ]]; then
            OVERALL_PASSED=false
            FAILURE_REASONS+=("Static security analysis failed")
          fi

          if [[ "$CRYPTO_PASSED" != "true" ]]; then
            OVERALL_PASSED=false
            FAILURE_REASONS+=("Cryptographic hygiene tests failed")
          fi

          if [[ "$AUDIT_PASSED" != "true" ]]; then
            OVERALL_PASSED=false
            FAILURE_REASONS+=("Comprehensive security audit failed")
          fi

          if [[ "$T4_COMPLIANCE" != "true" ]]; then
            OVERALL_PASSED=false
            FAILURE_REASONS+=("T4/0.01% excellence requirements not met")
          fi

          # Final verdict
          if [[ "$OVERALL_PASSED" == "true" ]]; then
            echo ""
            echo "üéâ SUCCESS: All security gates passed!"
            echo "‚úÖ T4/0.01% Excellence Standard Achieved"
            echo "üîí LUKHAS security validation complete"
            echo ""
            echo "overall-passed=true" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "‚ùå FAILURE: Security gates failed"
            echo "üö® T4/0.01% Excellence Standard NOT MET"
            echo ""
            echo "Failure reasons:"
            for reason in "${FAILURE_REASONS[@]}"; do
              echo "  - $reason"
            done
            echo ""
            echo "overall-passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Create security gates summary comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const semgrepFailed = '${{ needs.semgrep-security-scan.outputs.failed }}' === 'true';
            const cryptoPassed = '${{ needs.crypto-hygiene-tests.outputs.crypto-tests-passed }}' === 'true';
            const auditPassed = '${{ needs.comprehensive-security-audit.outputs.audit-passed }}' === 'true';
            const t4Compliance = '${{ needs.comprehensive-security-audit.outputs.t4-compliance }}' === 'true';
            const excellenceScore = '${{ needs.comprehensive-security-audit.outputs.excellence-score }}' || '0';
            const overallPassed = '${{ steps.evaluate.outputs.overall-passed }}' === 'true';

            const statusIcon = overallPassed ? '‚úÖ' : '‚ùå';
            const complianceIcon = t4Compliance ? 'üéØ' : 'üö®';

            const comment = `## ${statusIcon} LUKHAS Security Gates Report

            ### ${complianceIcon} T4/0.01% Excellence Status
            - **Excellence Score**: ${excellenceScore}%
            - **T4/0.01% Compliance**: ${t4Compliance ? '‚úÖ ACHIEVED' : '‚ùå NOT MET'}

            ### üîí Security Gate Results
            | Gate | Status | Details |
            |------|--------|---------||
            | Static Analysis (Semgrep) | ${semgrepFailed ? '‚ùå' : '‚úÖ'} | ${semgrepFailed ? 'Security vulnerabilities detected' : 'No security issues found'} |
            | Cryptographic Hygiene | ${cryptoPassed ? '‚úÖ' : '‚ùå'} | ${cryptoPassed ? 'All crypto tests passed' : 'Crypto security issues detected'} |
            | Comprehensive Audit | ${auditPassed ? '‚úÖ' : '‚ùå'} | ${auditPassed ? 'Security audit passed' : 'Security audit failed'} |

            ${overallPassed ?
              'üéâ **All security gates passed! Ready for deployment.**' :
              'üö® **Security gates failed. Review and fix security issues before merging.**'
            }

            ---
            *Security validation powered by LUKHAS T4/0.01% Excellence Standards*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # =============================================================================
  # Security Notification and Alerting
  # =============================================================================
  security-notifications:
    name: üö® Security Notifications
    runs-on: ubuntu-latest
    needs: [security-gates-summary]
    if: failure() || needs.security-gates-summary.outputs.overall-passed != 'true'

    steps:
      - name: Send security alert
        run: |
          echo "üö® SECURITY ALERT: T4/0.01% excellence standards not met"
          echo ""
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo ""
          echo "Please review security findings and resolve all issues before proceeding."
          echo ""

          # In a real implementation, this would integrate with:
          # - Slack/Teams notifications
          # - PagerDuty alerts
          # - Security incident management systems
          # - Email notifications to security team