name: üõ°Ô∏è Security Gates - T4/0.01%
on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]

env:
  GUARDIAN_MODE: production
  LUKHAS_MODE: test

jobs:
  # Semgrep Security Scanning
  semgrep-security:
    name: üîç Semgrep Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Semgrep
        run: pip install semgrep

      - name: Run LUKHAS Custom Security Rules
        run: |
          semgrep --config .semgrep/rules/guardian-security.yml \
                  --config .semgrep/rules/production-security.yml \
                  --json --output semgrep-results.json \
                  lukhas/ || true

      - name: Check for MockGuardian in Production
        run: |
          if semgrep --config .semgrep/rules/guardian-security.yml lukhas/ | grep -q "mock-guardian-production-usage"; then
            echo "‚ùå MockGuardian detected in production code path"
            echo "::error::MockGuardian found - use ProductionGuardian for production"
            exit 1
          else
            echo "‚úÖ No MockGuardian found in production code paths"
          fi

      - name: Upload Semgrep Results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: semgrep-security-results
          path: semgrep-results.json

  # Guardian Validation
  guardian-validation:
    name: üõ°Ô∏è Guardian System Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate Guardian Production Mode
        run: |
          python -c "
          import os
          os.environ['GUARDIAN_MODE'] = 'production'
          from lukhas.governance.guardian import get_guardian
          guardian = get_guardian()
          assert guardian.__class__.__name__ == 'ProductionGuardian', f'Expected ProductionGuardian, got {guardian.__class__.__name__}'
          print('‚úÖ Guardian correctly configured for production')
          "

      - name: Test Guardian Policy Enforcement
        run: |
          python -c "
          import os
          os.environ['GUARDIAN_MODE'] = 'production'
          from lukhas.governance.guardian import get_guardian
          guardian = get_guardian()

          # Test policy validation
          test_policy = {'action': 'test', 'resource': 'test'}
          result = guardian.validate_policy(test_policy, {'user': 'test'})
          assert result['allowed'] == False, 'Production Guardian should be restrictive by default'
          print('‚úÖ Guardian policy enforcement validated')
          "

  # Rate Limiting Security Test
  rate-limiting-security:
    name: ‚ö° Rate Limiting Security Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Test Rate Limiting Implementation
        run: |
          python -c "
          import asyncio
          from lukhas.identity.rate_limiting import get_rate_limiter, RateLimitType

          async def test_rate_limiting():
              rate_limiter = get_rate_limiter()

              # Test normal request
              allowed, metadata = await rate_limiter.check_rate_limit(
                  'test-client',
                  RateLimitType.WEBAUTHN_REGISTRATION
              )
              assert allowed == True, 'First request should be allowed'

              # Test rate limit enforcement
              for i in range(10):
                  allowed, metadata = await rate_limiter.check_rate_limit(
                      'test-client',
                      RateLimitType.WEBAUTHN_REGISTRATION
                  )

              # Should be rate limited now
              allowed, metadata = await rate_limiter.check_rate_limit(
                  'test-client',
                  RateLimitType.WEBAUTHN_REGISTRATION
              )
              assert allowed == False, 'Should be rate limited after exceeding threshold'
              print('‚úÖ Rate limiting security validated')

          asyncio.run(test_rate_limiting())
          "

  # Token Security Validation
  token-security:
    name: üîê Token Security Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Test OWASP Token Validation
        run: |
          python -c "
          import asyncio
          import jwt
          import time
          from lukhas.identity.auth_service import verify_token

          async def test_token_security():
              # Test expired token rejection
              expired_token = jwt.encode({
                  'sub': 'test-user',
                  'exp': int(time.time()) - 3600  # Expired 1 hour ago
              }, 'test-secret', algorithm='HS256')

              try:
                  await verify_token(expired_token)
                  assert False, 'Expired token should be rejected'
              except Exception:
                  print('‚úÖ Expired token properly rejected')

              # Test clock skew tolerance
              future_token = jwt.encode({
                  'sub': 'test-user',
                  'exp': int(time.time()) + 3600,
                  'iat': int(time.time()) + 120  # 2 minutes in future
              }, 'test-secret', algorithm='HS256')

              try:
                  await verify_token(future_token)
                  print('‚úÖ Clock skew tolerance working')
              except Exception:
                  print('‚ö†Ô∏è Clock skew rejection (acceptable)')

          asyncio.run(test_token_security())
          "

  # Security Gate Summary
  security-gate-summary:
    name: üìã Security Gate Summary
    runs-on: ubuntu-latest
    needs: [semgrep-security, guardian-validation, rate-limiting-security, token-security]
    if: always()
    steps:
      - name: Security Gate Results
        run: |
          echo "## üõ°Ô∏è T4/0.01% Security Gates Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Security Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Semgrep Security Scan | ${{ needs.semgrep-security.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Guardian Validation | ${{ needs.guardian-validation.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Rate Limiting Security | ${{ needs.rate-limiting-security.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Token Security | ${{ needs.token-security.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }} |" >> $GITHUB_STEP_SUMMARY

          # Fail if any security gate failed
          if [[ "${{ needs.semgrep-security.result }}" != "success" ||
                "${{ needs.guardian-validation.result }}" != "success" ||
                "${{ needs.rate-limiting-security.result }}" != "success" ||
                "${{ needs.token-security.result }}" != "success" ]]; then
            echo ""
            echo "‚ùå **Security gates failed - deployment blocked**"
            exit 1
          else
            echo ""
            echo "‚úÖ **All security gates passed - ready for production**"
          fi