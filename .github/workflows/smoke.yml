name: Smoke Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install minimal deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ensure tools and output dir
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          mkdir -p out

      - name: Run smoke check (JSON artifact)
        run: |
          python smoke_check.py --json out/smoke.json

      - name: Upload smoke artifact
        uses: actions/upload-artifact@v4
        with:
          name: smoke-results
          path: out/smoke.json

      - name: Enforce thresholds (gate)
        run: |
          echo "-- Raw results --"
          cat out/smoke.json | jq '.'

          APP_OK=$(jq -r '.ok' out/smoke.json)
          ROUTES=$(jq -r '.routes.count // .app.route_count' out/smoke.json)
          IMPORT_MS=$(jq -r '.timings.import_app_ms' out/smoke.json)
          HEALTH_MS=$(jq -r '.timings.feedback_health_ms' out/smoke.json)
          INCIDENTS=$(jq -r '.offline_governance.incidents' out/smoke.json)
          TIGHTENED=$(jq -r '.offline_governance.tightened' out/smoke.json)

          FAIL=0
          [[ "$APP_OK" == "true" ]] || { echo "❌ ok=false"; FAIL=1; }
          [[ "$ROUTES" -ge 1 ]] || { echo "❌ routes < 1"; FAIL=1; }
          awk "BEGIN { exit !($IMPORT_MS <= 1500) }" || { echo "❌ import_app_ms > 1500"; FAIL=1; }
          awk "BEGIN { exit !($HEALTH_MS <= 50) }" || { echo "❌ feedback_health_ms > 50"; FAIL=1; }
          [[ "$INCIDENTS" -eq 1 ]] || { echo "❌ offline_governance.incidents != 1"; FAIL=1; }
          [[ "$TIGHTENED" == "true" ]] || { echo "❌ offline_governance.tightened != true"; FAIL=1; }

          if [[ $FAIL -ne 0 ]]; then
            exit 1
          fi

      - name: Job summary
        if: always()
        run: |
          echo "## LUKHAS Smoke Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ok: $(jq -r '.ok' out/smoke.json)" >> $GITHUB_STEP_SUMMARY
          echo "- routes: $(jq -r '.routes.count // .app.route_count' out/smoke.json)" >> $GITHUB_STEP_SUMMARY
          echo "- import_app_ms: $(jq -r '.timings.import_app_ms' out/smoke.json) (<= 1500)" >> $GITHUB_STEP_SUMMARY
          echo "- feedback_health_ms: $(jq -r '.timings.feedback_health_ms' out/smoke.json) (<= 50)" >> $GITHUB_STEP_SUMMARY
          echo "- offline_governance.incidents: $(jq -r '.offline_governance.incidents' out/smoke.json) (== 1)" >> $GITHUB_STEP_SUMMARY
          echo "- offline_governance.tightened: $(jq -r '.offline_governance.tightened' out/smoke.json) (== true)" >> $GITHUB_STEP_SUMMARY

      - name: Sticky PR comment (optional)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'out/smoke.json';
            const body = `### LUKHAS Smoke Results\n\n` +
              `- ok: ${require('./' + path).ok}\n` +
              `- routes: ${require('./' + path).routes?.count ?? require('./' + path).app?.route_count}\n` +
              `- import_app_ms: ${require('./' + path).timings?.import_app_ms} (<= 1500)\n` +
              `- feedback_health_ms: ${require('./' + path).timings?.feedback_health_ms} (<= 50)\n` +
              `- offline_governance.incidents: ${require('./' + path).offline_governance?.incidents} (== 1)\n` +
              `- offline_governance.tightened: ${require('./' + path).offline_governance?.tightened} (== true)`;

            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;

            // Find existing bot comment
            const { data: comments } = await github.rest.issues.listComments({
              owner, repo, issue_number
            });
            const marker = '<!-- LUKHAS_SMOKE -->';
            const previous = comments.find(c => c.user.type === 'Bot' && c.body?.includes(marker));
            const newBody = `${marker}\n${body}`;
            if (previous) {
              await github.rest.issues.updateComment({
                owner, repo,
                comment_id: previous.id,
                body: newBody,
              });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number, body: newBody });
            }
