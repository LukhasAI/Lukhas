name: Smoke Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install minimal deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ensure tools and output dir
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          mkdir -p out

      - name: Run smoke check (JSON artifact)
        run: |
          python smoke_check.py --json out/smoke.json

      - name: Upload smoke artifact
        uses: actions/upload-artifact@v4
        with:
          name: smoke-results
          path: out/smoke.json

      - name: Export OpenAPI (local uvicorn)
        run: |
          uvicorn lukhas.api.app:app --port 8000 & echo $! > .pid
          sleep 2
          curl -s http://127.0.0.1:8000/openapi.json -o out/openapi.json
          kill $(cat .pid)

      - name: Start API for k6
        env:
          FLAG_OPS_PERF_INGEST: 'true'
          LUKHAS_API_KEY: ${{ secrets.LUKHAS_API_KEY }}
        run: |
          uvicorn lukhas.api.app:app --port 8000 & echo $! > .apid
          sleep 2

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: k6 performance smoke
        env:
          BASE_URL: http://127.0.0.1:8000
          SUMMARY_JSON: out/k6_summary.json
        run: |
          mkdir -p out
          k6 run perf/k6_smoke.js

      - name: Push k6 p95 to API (optional)
        env:
          LUKHAS_API_KEY: ${{ secrets.LUKHAS_API_KEY }}
        run: |
          # Ingest summary to local API for Admin sparkline trends if key is provided
          if [ -n "$LUKHAS_API_KEY" ] && [ -f out/k6_summary.json ]; then
            curl -s -H "x-api-key: $LUKHAS_API_KEY" \
                 -H "content-type: application/json" \
                 -X POST http://127.0.0.1:8000/ops/perf/k6 \
                 --data-binary @out/k6_summary.json | tee out/k6_ingest_result.json
          else
            echo "Skipping ingestion (no API key or no k6_summary.json)"
          fi

      - name: Stop API (k6)
        if: always()
        run: |
          kill $(cat .apid) || true
          rm -f .apid

      - name: Upload k6 summary
        uses: actions/upload-artifact@v4
        with:
          name: k6-summary
          path: out/k6_summary.json

      - name: Upload k6 ingest result (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-ingest-result
          path: out/k6_ingest_result.json

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lukhas-openapi-and-smoke
          path: |
            out/openapi.json
            out/smoke.json

      - name: Enforce thresholds (gate)
        run: |
          echo "-- Raw results --"
          cat out/smoke.json | jq '.'

          APP_OK=$(jq -r '.ok' out/smoke.json)
          ROUTES=$(jq -r '.routes.count // .app.route_count' out/smoke.json)
          IMPORT_MS=$(jq -r '.timings.import_app_ms' out/smoke.json)
          HEALTH_MS=$(jq -r '.timings.feedback_health_ms' out/smoke.json)
          INCIDENTS=$(jq -r '.offline_governance.incidents' out/smoke.json)
          TIGHTENED=$(jq -r '.offline_governance.tightened' out/smoke.json)

          FAIL=0
          [[ "$APP_OK" == "true" ]] || { echo "❌ ok=false"; FAIL=1; }
          [[ "$ROUTES" -ge 1 ]] || { echo "❌ routes < 1"; FAIL=1; }
          awk "BEGIN { exit !($IMPORT_MS <= 1500) }" || { echo "❌ import_app_ms > 1500"; FAIL=1; }
          awk "BEGIN { exit !($HEALTH_MS <= 50) }" || { echo "❌ feedback_health_ms > 50"; FAIL=1; }
          [[ "$INCIDENTS" -eq 1 ]] || { echo "❌ offline_governance.incidents != 1"; FAIL=1; }
          [[ "$TIGHTENED" == "true" ]] || { echo "❌ offline_governance.tightened != true"; FAIL=1; }

          if [[ $FAIL -ne 0 ]]; then
            exit 1
          fi

      - name: Job summary
        if: always()
        run: |
          echo "## LUKHAS Smoke Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ok: $(jq -r '.ok' out/smoke.json)" >> $GITHUB_STEP_SUMMARY
          echo "- routes: $(jq -r '.routes.count // .app.route_count' out/smoke.json)" >> $GITHUB_STEP_SUMMARY
          echo "- import_app_ms: $(jq -r '.timings.import_app_ms' out/smoke.json) (<= 1500)" >> $GITHUB_STEP_SUMMARY
          echo "- feedback_health_ms: $(jq -r '.timings.feedback_health_ms' out/smoke.json) (<= 50)" >> $GITHUB_STEP_SUMMARY
          echo "- offline_governance.incidents: $(jq -r '.offline_governance.incidents' out/smoke.json) (== 1)" >> $GITHUB_STEP_SUMMARY
          echo "- offline_governance.tightened: $(jq -r '.offline_governance.tightened' out/smoke.json) (== true)" >> $GITHUB_STEP_SUMMARY
          if [ -f out/k6_summary.json ]; then \
            echo "\n### k6 Performance Smoke" >> $GITHUB_STEP_SUMMARY; \
            HEALTH=$(jq -r '.metrics["http_req_duration{endpoint:health}"].values["p(95)"]' out/k6_summary.json 2>/dev/null || echo "n/a"); \
            TOOLS=$(jq -r '.metrics["http_req_duration{endpoint:tools}"].values["p(95)"]' out/k6_summary.json 2>/dev/null || echo "n/a"); \
            OPENAPI=$(jq -r '.metrics["http_req_duration{endpoint:openapi}"].values["p(95)"]' out/k6_summary.json 2>/dev/null || echo "n/a"); \
            echo "| Endpoint | p95 (ms) |" >> $GITHUB_STEP_SUMMARY; \
            echo "|---|---|" >> $GITHUB_STEP_SUMMARY; \
            echo "| /feedback/health | $HEALTH |" >> $GITHUB_STEP_SUMMARY; \
            echo "| /tools/registry  | $TOOLS  |" >> $GITHUB_STEP_SUMMARY; \
            echo "| /openapi.json    | $OPENAPI |" >> $GITHUB_STEP_SUMMARY; \
          fi

      - name: Sticky PR comment (optional)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'out/smoke.json';
            const body = `### LUKHAS Smoke Results\n\n` +
              `- ok: ${require('./' + path).ok}\n` +
              `- routes: ${require('./' + path).routes?.count ?? require('./' + path).app?.route_count}\n` +
              `- import_app_ms: ${require('./' + path).timings?.import_app_ms} (<= 1500)\n` +
              `- feedback_health_ms: ${require('./' + path).timings?.feedback_health_ms} (<= 50)\n` +
              `- offline_governance.incidents: ${require('./' + path).offline_governance?.incidents} (== 1)\n` +
              `- offline_governance.tightened: ${require('./' + path).offline_governance?.tightened} (== true)`;

            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;

            // Find existing bot comment
            const { data: comments } = await github.rest.issues.listComments({
              owner, repo, issue_number
            });
            const marker = '<!-- LUKHAS_SMOKE -->';
            const previous = comments.find(c => c.user.type === 'Bot' && c.body?.includes(marker));
            const newBody = `${marker}\n${body}`;
            if (previous) {
              await github.rest.issues.updateComment({
                owner, repo,
                comment_id: previous.id,
                body: newBody,
              });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number, body: newBody });
            }
