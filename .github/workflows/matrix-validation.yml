name: Matrix Validation

on:
  pull_request:
    paths:
      - '**/matrix_*.json'
      - 'matrix.schema.template.json'
      - 'policies/matrix/**'
      - 'tools/**'
      - 'tests/**'
      - 'contracts/**'
  push:
    branches: [ main ]

jobs:
  validate-matrix:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }
      - run: pip install jsonschema pyyaml pytest opentelemetry-api opentelemetry-sdk

      - name: Presence Gate
        run: python3 tools/validate_contract_presence.py --enforce --quiet

      - name: Schema + Identity Lint
        run: |
          mkdir -p artifacts
          python3 tools/validate_all_matrix.py \
            --schema matrix.schema.template.json \
            --pattern "**/matrix_*.json" \
            --identity \
            --output-json artifacts/matrix_validation_results.json

      - name: v3 Upgrade Idempotency Check
        run: |
          echo "Checking that all contracts already have v3 placeholders..."
          output=$(python3 tools/matrix_upgrade_v3.py --pattern "contracts/matrix_*.json" --dry-run)
          echo "$output"
          if echo "$output" | grep -q "Files would be updated: [1-9]"; then
            echo "❌ Some contracts are missing v3 placeholders. Run 'make matrix-v3-upgrade' locally."
            exit 1
          fi
          echo "✅ All contracts have v3 placeholders"

      - name: OPA Policy
        run: |
          # Install OPA if not available
          if ! command -v opa &> /dev/null; then
            echo "Installing OPA..."
            curl -L -o opa https://openpolicyagent.org/downloads/v0.57.0/opa_linux_amd64_static
            chmod +x opa
            sudo mv opa /usr/local/bin/
          fi
          opa fmt policies/matrix -w
          opa test policies/matrix -v
          python3 tools/check_policy_bundle_checksum.py

      - name: AuthZ Runner
        run: |
          python3 tools/run_matrix_tests.py \
            --fixtures tests/authz \
            --output artifacts/authz_results.json \
            --min-pass-rate 0.95

      - name: Telemetry Smoke
        run: pytest -xvs tests/test_telemetry_authz_smoke.py

      - name: Coverage Report
        run: |
          python3 - << 'PY'
          import json, pathlib
          from datetime import datetime
          root = pathlib.Path('.')

          # Load validation results
          val_file = root / 'artifacts/matrix_validation_results.json'
          if val_file.exists():
              val = json.loads(val_file.read_text())
          else:
              val = {'modules': {}}

          # Load authorization results
          authz_file = root / 'artifacts/authz_results.json'
          if authz_file.exists():
              authz = json.loads(authz_file.read_text())
          else:
              authz = {'summary': {'passed': 0, 'total_tests': 0, 'pass_rate': 0}, 'modules': {}}

          # Calculate summary statistics
          modules = val.get('modules', {})
          ok = sum(1 for m in modules.values() if m.get('valid', False))
          tot = len(modules)
          pass_rate = f"{authz['summary']['passed']}/{authz['summary']['total_tests']} ({authz['summary']['pass_rate']*100:.1f}%)"

          # Generate markdown report
          md = ["# Matrix Identity Coverage Report",
                f"_Generated: {datetime.utcnow().isoformat()}Z_",
                "",
                f"**Contracts:** {ok}/{tot} valid",
                f"**AuthZ:** {pass_rate}",
                ""]
          md.append("| Module | Schema | Identity | AuthZ Passed/Total |")
          md.append("|---|---:|---:|---:|")

          for m in sorted(modules.keys()):
              row = modules[m]
              a = authz.get('modules', {}).get(m, {"passed":0,"total":0})
              md.append(f"| `{m}` | {'✅' if row.get('schema_ok', False) else '❌'} | {'✅' if row.get('identity_ok', False) else '❌'} | {a['passed']}/{a['total']} |")

          # Write report
          report_path = root / 'tests/matrix_coverage_report.md'
          report_path.write_text("\n".join(md)+"\n")
          print('WROTE tests/matrix_coverage_report.md')

          # Exit with error if validation failed
          if ok < tot:
              print(f"❌ Validation failed: {ok}/{tot} contracts valid")
              exit(1)
          if authz['summary']['pass_rate'] < 0.95:
              print(f"❌ AuthZ pass rate below 95%: {authz['summary']['pass_rate']:.1%}")
              exit(1)
          print("✅ All validation checks passed")
          PY

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: matrix-validation-artifacts
          path: |
            artifacts/**
            tests/matrix_coverage_report.md

