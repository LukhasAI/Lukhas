# .github/workflows/slsa-attest.yml
name: SLSA Attestation (Weekly)

on:
  schedule:
    # Runs at 00:00 UTC on Sunday
    - cron: '0 0 * * 0'
  workflow_dispatch: # Allows manual triggering

permissions:
  id-token: write
  contents: read
  actions: read

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      digest: ${{ steps.hash.outputs.digest }}
    steps:
      - uses: actions/checkout@v4
      - name: Placeholder Build Step
        run: |
          echo "This is a placeholder build step." > artifact.txt
      - name: Hash artifact
        id: hash
        run: |
          # The SLSA generator needs a hash of the artifact.
          # We'll generate a sha256sum of the artifact.
          echo "digest=$(sha256sum artifact.txt | base64 -w0)" >> "$GITHUB_OUTPUT"
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: artifact
          path: artifact.txt

  provenance:
    needs: [build]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      id-token: write # Required for signing.
      actions: read # Required for retrieving workflow history.
      contents: write # Required for uploading attestations.
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: artifact
          path: .
      - name: Generate SLSA Provenance
        uses: slsa-framework/slsa-github-generator@v1.10.0
        with:
          subject-path: "artifact.txt"
          subject-digest: "${{ needs.build.outputs.digest }}"
          # The SLSA generator will automatically create and upload the attestation.
