name: Registry Smoke (PR)

on:
  pull_request:
    paths:
      - 'services/registry/**'
      - 'scripts/**'
      - 'docs/schemas/**'
      - '.github/workflows/registry-smoke.yml'

jobs:
  registry_smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y netcat jq
      - name: Check dev stub flag
        id: check_stub
        run: |
          if [ "${REGISTRY_DEV_STUB:-0}" = "1" ]; then
            echo "mode=dev-stub" >> $GITHUB_OUTPUT
            echo "✓ Dev stub mode enabled (REGISTRY_DEV_STUB=1)"
          else
            echo "mode=skip" >> $GITHUB_OUTPUT
            echo "ℹ️  Dev stub mode disabled (set REGISTRY_DEV_STUB=1 to enable)"
          fi
        env:
          REGISTRY_DEV_STUB: "1"  # Set to "1" to enable dev stub in CI

      - name: Install python deps (dev stub only)
        if: steps.check_stub.outputs.mode == 'dev-stub'
        run: |
          python -m pip install --upgrade pip
          pip install fastapi uvicorn httpx

      - name: Start registry dev stub
        if: steps.check_stub.outputs.mode == 'dev-stub'
        run: |
          export REGISTRY_DEV_STUB=1
          nohup uvicorn services.registry.dev_stub_app:app --host 127.0.0.1 --port 8080 > uvicorn.log 2>&1 &
          echo $! > uvicorn.pid
          echo "Dev stub registry started on port 8080"
      - name: Wait for registry port
        if: steps.check_stub.outputs.mode == 'dev-stub'
        run: ./scripts/wait_for_port.sh 127.0.0.1 8080 30

      - name: Run registry smoke (dev stub)
        if: steps.check_stub.outputs.mode == 'dev-stub'
        env:
          REGISTRY_BASE_URL: http://127.0.0.1:8080
        run: ./scripts/ci_verify_registry.sh

      - name: Skip registry smoke (no dev stub)
        if: steps.check_stub.outputs.mode == 'skip'
        run: |
          echo "::notice::Registry smoke skipped - dev stub not enabled"
          echo "Set REGISTRY_DEV_STUB=1 in workflow to enable dev stub mode"
          echo "This is expected behavior when fastapi dependencies are not available"
          exit 78  # Exit code 78 = intentional skip
      - name: Upload uvicorn log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: uvicorn-log
          path: uvicorn.log
      - name: Teardown
        if: always()
        run: |
          kill $(cat uvicorn.pid) || true
          rm -f uvicorn.pid
