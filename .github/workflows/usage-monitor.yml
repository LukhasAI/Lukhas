name: ðŸ“Š Actions Usage Monitor

on:
  schedule:
    # Run every Monday at 9am UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  actions: read
  issues: write

jobs:
  monitor-usage:
    runs-on: ubuntu-latest
    steps:
      - name: Check GitHub Actions usage
        id: usage
        run: |
          # Get current billing cycle usage
          USAGE=$(gh api /repos/${{ github.repository }}/actions/billing/usage)

          # Extract minutes used
          TOTAL_MIN=$(echo "$USAGE" | jq '.total_minutes_used // 0')
          INCLUDED_MIN=$(echo "$USAGE" | jq '.included_minutes // 3000')

          # Calculate percentage and remaining
          PERCENT=$((TOTAL_MIN * 100 / INCLUDED_MIN))
          REMAINING=$((INCLUDED_MIN - TOTAL_MIN))

          echo "total_minutes=$TOTAL_MIN" >> $GITHUB_OUTPUT
          echo "included_minutes=$INCLUDED_MIN" >> $GITHUB_OUTPUT
          echo "percent_used=$PERCENT" >> $GITHUB_OUTPUT
          echo "remaining_minutes=$REMAINING" >> $GITHUB_OUTPUT

          # Determine alert level
          if [ $PERCENT -ge 90 ]; then
            echo "alert_level=ðŸ”´ CRITICAL" >> $GITHUB_OUTPUT
            echo "should_alert=true" >> $GITHUB_OUTPUT
          elif [ $PERCENT -ge 75 ]; then
            echo "alert_level=ðŸŸ¡ WARNING" >> $GITHUB_OUTPUT
            echo "should_alert=true" >> $GITHUB_OUTPUT
          elif [ $PERCENT -ge 50 ]; then
            echo "alert_level=ðŸŸ¢ NOTICE" >> $GITHUB_OUTPUT
            echo "should_alert=false" >> $GITHUB_OUTPUT
          else
            echo "alert_level=âœ… HEALTHY" >> $GITHUB_OUTPUT
            echo "should_alert=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get workflow statistics
        id: workflow-stats
        run: |
          # Get top 5 most expensive workflows this month
          gh api "/repos/${{ github.repository }}/actions/runs?per_page=100" \
            --jq '.workflow_runs | group_by(.name) |
                  map({name: .[0].name, count: length,
                       avg_duration: (map(.run_duration_ms) | add / length / 60000)}) |
                  sort_by(.avg_duration) | reverse | .[0:5]' > top_workflows.json

          echo "Top 5 most expensive workflows:"
          cat top_workflows.json | jq -r '.[] | "\(.name): \(.count) runs, avg \(.avg_duration | floor)min"'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post usage summary
        uses: actions/github-script@v7
        if: steps.usage.outputs.should_alert == 'true'
        env:
          ALERT_LEVEL: ${{ steps.usage.outputs.alert_level }}
          TOTAL_MIN: ${{ steps.usage.outputs.total_minutes }}
          INCLUDED_MIN: ${{ steps.usage.outputs.included_minutes }}
          PERCENT: ${{ steps.usage.outputs.percent_used }}
          REMAINING: ${{ steps.usage.outputs.remaining_minutes }}
        with:
          script: |
            const fs = require('fs');
            const topWorkflows = JSON.parse(fs.readFileSync('top_workflows.json', 'utf8'));

            const workflowTable = topWorkflows.map((w, i) =>
              `${i+1}. **${w.name}**: ${w.count} runs, avg ${Math.floor(w.avg_duration)}min`
            ).join('\n');

            const body = `## ${process.env.ALERT_LEVEL} GitHub Actions Usage Alert

            **Current Usage**: ${process.env.TOTAL_MIN} / ${process.env.INCLUDED_MIN} minutes (${process.env.PERCENT}%)
            **Remaining**: ${process.env.REMAINING} minutes this billing cycle

            ### Top 5 Most Expensive Workflows
            ${workflowTable}

            ### Recommendations
            ${process.env.PERCENT >= 90 ?
              '- ðŸ”´ **URGENT**: Disable non-essential workflows immediately\n- Consider moving heavy tests to scheduled runs\n- Review path filters to avoid unnecessary runs' :
              '- ðŸŸ¡ Monitor usage closely\n- Consider optimizing heavy workflows\n- Review upcoming PR plans'}

            ### Quick Actions
            \`\`\`bash
            # Check detailed usage
            gh api /repos/${{ github.repository }}/actions/billing/usage

            # Disable heavy workflows
            cd .github/workflows
            mv expensive-workflow.yml ../workflows-disabled/

            # See simplification plan
            cat SIMPLIFIED_CI_PLAN.md
            \`\`\`

            ---
            *Automated usage monitoring - runs weekly on Mondays*`;

            // Create or update issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'ci-usage-alert',
              state: 'open'
            });

            if (issues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: body
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `${process.env.ALERT_LEVEL} GitHub Actions Usage: ${process.env.PERCENT}% of monthly limit`,
                body: body,
                labels: ['ci-usage-alert', 'priority-high']
              });
            }

      - name: Log usage summary
        run: |
          echo "=== GitHub Actions Usage Summary ==="
          echo "Total minutes used: ${{ steps.usage.outputs.total_minutes }}"
          echo "Included minutes: ${{ steps.usage.outputs.included_minutes }}"
          echo "Percentage used: ${{ steps.usage.outputs.percent_used }}%"
          echo "Remaining minutes: ${{ steps.usage.outputs.remaining_minutes }}"
          echo "Alert level: ${{ steps.usage.outputs.alert_level }}"
