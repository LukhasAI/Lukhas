name: File Organization

on:
  schedule:
    # Run every Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (no changes)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write
  pull-requests: write

jobs:
  organize-files:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        pip install pyyaml
    
    - name: Run file organization
      id: organize
      run: |
        if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
          python scripts/file-organizer.py organize --dry-run
        else
          python scripts/file-organizer.py organize
        fi
        
        # Check if files were moved
        if [ -f .file_organization_log.json ]; then
          MOVES=$(python -c "import json; log=json.load(open('.file_organization_log.json')); print(len([m for m in log[-50:] if 'dry_run' not in m]))")
          echo "moves_count=$MOVES" >> $GITHUB_OUTPUT
        else
          echo "moves_count=0" >> $GITHUB_OUTPUT
        fi
    
    - name: Cleanup old files
      if: github.event.inputs.dry_run != 'true'
      run: |
        python scripts/file-organizer.py cleanup
    
    - name: Generate suggestions
      run: |
        python scripts/file-organizer.py suggest > suggestions.txt
        
        if [ -s suggestions.txt ]; then
          echo "## üí° Organization Suggestions" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat suggestions.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Create Pull Request
      if: steps.organize.outputs.moves_count != '0' && github.event.inputs.dry_run != 'true'
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          chore: Organize root directory files
          
          Automated file organization moving ${{ steps.organize.outputs.moves_count }} files
          to their appropriate directories according to .file-organization.yaml rules.
        branch: auto-file-organization-${{ github.run_number }}
        delete-branch: true
        title: 'üßπ [Auto] Organize root directory files'
        body: |
          ## üßπ Automated File Organization
          
          This PR automatically organizes files in the root directory according to the rules in `.file-organization.yaml`.
          
          ### üìä Summary
          - **Files moved**: ${{ steps.organize.outputs.moves_count }}
          - **Organization report**: See `docs/organization_summary.md`
          
          ### üìÅ Organization Rules Applied
          - Agent reports ‚Üí `docs/agent_reports/`
          - Completion reports ‚Üí `docs/completion_reports/`
          - Implementation docs ‚Üí `docs/implementation/`
          - Analysis docs ‚Üí `docs/analysis/`
          - Backup files ‚Üí `backups/`
          - One-off scripts ‚Üí `scripts/one_off/`
          
          ### ‚úÖ Review Checklist
          - [ ] Verify no critical files were moved incorrectly
          - [ ] Check that build and tests still pass
          - [ ] Review the organization report
          
          ---
          *This PR was automatically generated by the LUKHAS File Organization system.*
        labels: |
          chore
          automated
          organization