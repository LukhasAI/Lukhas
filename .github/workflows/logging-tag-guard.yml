name: Logging Tag Guard

on:
  push:
    branches: [ main ]
    paths:
      - 'serve/**'
      - 'tests/contract/**'
      - '.github/workflows/logging-tag-guard.yml'
      - 'Makefile'
  schedule:
    - cron: '55 3 * * *'
  workflow_dispatch: {}

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
        with:
          fetch-depth: 0
      - name: Install ripgrep
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep
      - name: Detect disallowed logging kwargs (ΛTAG)
        shell: bash
        run: |
          set -euo pipefail
          BASE="${{ github.event.pull_request.base.sha || github.event.before || 'HEAD~1' }}"
          HEAD="${{ github.sha }}"
          git fetch --no-tags --depth=2 origin "${{ github.base_ref || 'main' }}" || true
          CHANGED="$(git diff --name-only "${BASE}...${HEAD}" || true)"
          if [ -z "$CHANGED" ]; then
            CHANGED=$(printf "%s\n" serve tests/contract)
          fi
          echo "$CHANGED" | tr ' ' '\n' | sed '/^$/d' | while read -r f; do
            case "$f" in
              *.py|*.md|*.yaml|*.yml|*.txt|serve/*|tests/contract/*) ;;
              *) continue ;;
            esac
            if rg -n 'logger\.(info|warning|error|debug)\(.*ΛTAG=' -S -- "$f"; then
              echo "Disallowed logging kwarg 'ΛTAG=' found in $f; use formatted fields instead." >&2
              exit 1
            fi
          done
          echo "No disallowed logging kwargs detected in changed files."
