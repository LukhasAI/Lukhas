name: f401-unused-imports
on:
  pull_request:
    types: [opened, synchronize, edited]
  workflow_dispatch:

jobs:
  f401:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
      - uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d
        with:
          python-version: "3.11"
      - name: Install ruff
        run: python -m pip install ruff
      - name: F401 audit
        run: |
          mkdir -p reports/audit
          python3 -m ruff check --select F401 --output-format json > reports/audit/f401.json || true
          python3 tools/ci/f401_trend.py
      - name: F401 summary
        run: |
          python - <<'PY'
import json
import sys

try:
    with open("reports/audit/f401.json") as f:
        data = json.load(f)
    
    totals = {"core": 0, "candidate": 0, "other": 0}
    for rec in data:
        path = str(rec.get("filename", ""))
        if path.startswith(("consciousness/", "identity/", "governance/", "memory/", "core/", "bio/", "MATRIZ/")):
            totals["core"] += 1
        elif path.startswith("candidate/"):
            totals["candidate"] += 1
        else:
            totals["other"] += 1
    
    total = sum(totals.values())
    print(f"## F401 Unused Import Summary")
    print(f"")
    print(f"| Category | Count |")
    print(f"|----------|-------|")
    print(f"| Core (consciousness/, identity/, governance/, memory/, core/, bio/, MATRIZ/) | {totals['core']} |")
    print(f"| Candidate | {totals['candidate']} |")  
    print(f"| Other | {totals['other']} |")
    print(f"| **Total** | **{total}** |")
    
    # Exit with error if core has unused imports (optional enforcement)
    if totals["core"] > 0:
        print(f"")
        print(f"‚ùå Core directories have {totals['core']} unused imports")
        # Uncomment to enforce: sys.exit(1)
    
except Exception as e:
    print(f"Error processing F401 results: {e}")
    sys.exit(1)
PY
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a
        with:
          name: f401-report
          path: |
            reports/audit/f401.json
            reports/audit/f401_trends.csv