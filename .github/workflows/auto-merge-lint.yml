name: Auto-Merge Lint PRs

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
    branches: [ main ]

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  check-lint-only:
    runs-on: ubuntu-latest
    outputs:
      is-lint-only: ${{ steps.check.outputs.is-lint-only }}
      is-dependabot: ${{ steps.check.outputs.is-dependabot }}
    steps:
      - name: Check if PR is lint-only or dependabot
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            // Check if PR is from dependabot
            const isDependabot = pr.user.login === 'dependabot[bot]';
            
            // Get PR files to check if lint-only
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            // Check if title/branch indicates lint-only changes
            const title = pr.title.toLowerCase();
            const branch = pr.head.ref.toLowerCase();
            const isLintBranch = branch.includes('lint') || branch.includes('ruff') || branch.includes('mypy');
            const isLintTitle = title.includes('lint') || title.includes('ruff') || title.includes('chore(lint');
            
            // Check if all files are in acceptable directories for auto-merge
            const autoMergeableDirs = [
              '.github/workflows/',
              'tools/',
              'lukhas/',
              'serve/',
              'enterprise/security/',
              'candidate/bridge/orchestration/',
              'candidate/memory/protection/'
            ];
            
            const allFilesAutoMergeable = files.every(file => 
              autoMergeableDirs.some(dir => file.filename.startsWith(dir)) ||
              file.filename.endsWith('.py') ||
              file.filename.endsWith('.yml') ||
              file.filename.endsWith('.yaml')
            );
            
            const isLintOnly = (isLintBranch || isLintTitle) && allFilesAutoMergeable;
            
            core.setOutput('is-lint-only', isLintOnly);
            core.setOutput('is-dependabot', isDependabot);
            
            console.log(`PR #${context.issue.number}:`);
            console.log(`- Title: ${title}`);
            console.log(`- Branch: ${branch}`);
            console.log(`- Is Dependabot: ${isDependabot}`);
            console.log(`- Is Lint Only: ${isLintOnly}`);
            console.log(`- All Files Auto-mergeable: ${allFilesAutoMergeable}`);

  wait-for-checks:
    runs-on: ubuntu-latest
    needs: check-lint-only
    if: needs.check-lint-only.outputs.is-lint-only == 'true' || needs.check-lint-only.outputs.is-dependabot == 'true'
    steps:
      - name: Wait for status checks
        uses: actions/github-script@v7
        with:
          script: |
            const maxWaitTime = 10 * 60 * 1000; // 10 minutes
            const startTime = Date.now();
            
            while (Date.now() - startTime < maxWaitTime) {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number
              });
              
              // Get status checks
              const { data: combinedStatus } = await github.rest.repos.getCombinedStatusForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: pr.head.sha
              });
              
              // Check if all required checks passed
              const requiredChecks = ['lint', 'guard'];
              const allChecksPassed = requiredChecks.every(checkName => {
                const check = combinedStatus.statuses.find(s => s.context.includes(checkName));
                return check && check.state === 'success';
              });
              
              if (allChecksPassed && combinedStatus.state === 'success') {
                console.log('All checks passed! Proceeding with auto-merge...');
                return;
              }
              
              if (combinedStatus.state === 'failure') {
                core.setFailed('Status checks failed - will not auto-merge');
                return;
              }
              
              console.log(`Waiting for checks... Current state: ${combinedStatus.state}`);
              await new Promise(resolve => setTimeout(resolve, 30000)); // Wait 30 seconds
            }
            
            core.setFailed('Timeout waiting for status checks');

  auto-approve-and-merge:
    runs-on: ubuntu-latest
    needs: [check-lint-only, wait-for-checks]
    if: needs.check-lint-only.outputs.is-lint-only == 'true' || needs.check-lint-only.outputs.is-dependabot == 'true'
    steps:
      - name: Auto-approve PR
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                body: 'ðŸ¤– Auto-approving lint-only changes with green checks',
                event: 'APPROVE'
              });
            } catch (error) {
              console.log('PR might already be approved:', error.message);
            }

      - name: Enable auto-merge
        uses: actions/github-script@v7
        with:
          script: |
            const mutation = `
              mutation($pullRequestId: ID!) {
                enablePullRequestAutoMerge(input: {
                  pullRequestId: $pullRequestId,
                  mergeMethod: SQUASH
                }) {
                  pullRequest {
                    autoMergeRequest {
                      enabledAt
                    }
                  }
                }
              }
            `;
            
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            try {
              const result = await github.graphql(mutation, {
                pullRequestId: pr.node_id
              });
              
              console.log('Auto-merge enabled successfully');
              
              // Add comment to PR
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `ðŸš€ **Autonomous Execution Activated**\n\nThis lint-only PR has been auto-approved and will merge automatically when all checks pass.\n\nâœ… All required checks: **PASSED**\nðŸ¤– Auto-merge: **ENABLED**\nðŸ“‹ Merge method: **SQUASH**`
              });
              
            } catch (error) {
              console.error('Failed to enable auto-merge:', error);
              core.setFailed(`Auto-merge failed: ${error.message}`);
            }
