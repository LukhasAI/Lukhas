name: Plugin Discovery Smoke Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run nightly at 3:30 AM UTC to catch discovery drift
    - cron: '30 3 * * *'
  workflow_dispatch:

jobs:
  plugin-discovery-smoke:
    name: ðŸ” Plugin Discovery Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    strategy:
      matrix:
        discovery-mode: ['auto', 'explicit', 'disabled']
        python-version: ['3.11', '3.12']
      fail-fast: false

    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332

    - name: ðŸ Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@39cd14951b08e74b54015e9e001cdefcf80e669f
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: ðŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pytest

    - name: ðŸ” Test Plugin Discovery - ${{ matrix.discovery-mode }}
      env:
        LUKHAS_PLUGIN_DISCOVERY: ${{ matrix.discovery-mode }}
      run: |
        echo "ðŸ” Testing plugin discovery in ${{ matrix.discovery-mode }} mode..."

        # Create test script to validate discovery
        cat > test_discovery_smoke.py << 'EOF'
        #!/usr/bin/env python3
        import os
        import sys
        import json
        from pathlib import Path

        def test_plugin_discovery():
            """Smoke test for plugin discovery system"""
            discovery_mode = os.getenv("LUKHAS_PLUGIN_DISCOVERY", "disabled")
            print(f"Testing discovery mode: {discovery_mode}")

            discovered_plugins = []
            errors = []

            try:
                # Test core registry functionality
                sys.path.insert(0, str(Path.cwd()))

                # Test 1: Basic registry import
                try:
                    from lukhas.core.registry import PluginRegistry
                    registry = PluginRegistry()
                    print("âœ… Registry imported successfully")
                except ImportError as e:
                    errors.append(f"Registry import failed: {e}")
                    print(f"âŒ Registry import failed: {e}")

                # Test 2: Discovery based on mode
                if discovery_mode == "auto":
                    try:
                        # Should auto-discover available plugins
                        plugins = registry.discover_plugins()
                        discovered_plugins.extend(plugins)
                        print(f"âœ… Auto-discovery found {len(plugins)} plugins")
                    except Exception as e:
                        errors.append(f"Auto-discovery failed: {e}")
                        print(f"âŒ Auto-discovery failed: {e}")

                elif discovery_mode == "explicit":
                    try:
                        # Should only load explicitly registered plugins
                        known_plugins = ["facts", "math", "validator"]
                        for plugin_name in known_plugins:
                            try:
                                plugin = registry.resolve(plugin_name)
                                if plugin:
                                    discovered_plugins.append(plugin_name)
                            except Exception:
                                pass  # Expected for explicit mode
                        print(f"âœ… Explicit mode tested with {len(discovered_plugins)} plugins")
                    except Exception as e:
                        errors.append(f"Explicit mode failed: {e}")
                        print(f"âŒ Explicit mode failed: {e}")

                elif discovery_mode == "disabled":
                    try:
                        # Should have minimal/no plugin discovery
                        plugins = registry.list_registered()
                        discovered_plugins.extend(plugins)
                        print(f"âœ… Disabled mode has {len(plugins)} registered plugins")
                    except Exception as e:
                        errors.append(f"Disabled mode failed: {e}")
                        print(f"âŒ Disabled mode failed: {e}")

                # Test 3: Basic plugin resolution
                try:
                    test_plugin = registry.resolve("facts")
                    if test_plugin:
                        print("âœ… Plugin resolution working")
                    else:
                        print("âš ï¸ No plugins resolved (may be expected)")
                except Exception as e:
                    print(f"âš ï¸ Plugin resolution test: {e}")

            except Exception as e:
                errors.append(f"Discovery test framework error: {e}")
                print(f"âŒ Framework error: {e}")

            # Generate results
            results = {
                "discovery_mode": discovery_mode,
                "discovered_plugins": discovered_plugins,
                "plugin_count": len(discovered_plugins),
                "errors": errors,
                "test_passed": len(errors) == 0,
                "discovery_functional": len(errors) == 0 and (
                    discovery_mode == "disabled" or len(discovered_plugins) > 0
                )
            }

            # Write results for CI
            with open("plugin_discovery_results.json", "w") as f:
                json.dump(results, f, indent=2)

            print(f"\nðŸ“Š Discovery Results:")
            print(f"   Mode: {discovery_mode}")
            print(f"   Plugins Found: {len(discovered_plugins)}")
            print(f"   Errors: {len(errors)}")
            print(f"   Test Status: {'âœ… PASS' if results['test_passed'] else 'âŒ FAIL'}")

            if errors:
                print("\nðŸš¨ Errors:")
                for error in errors:
                    print(f"   - {error}")

            return results["test_passed"]

        if __name__ == "__main__":
            success = test_plugin_discovery()
            sys.exit(0 if success else 1)
        EOF

        python test_discovery_smoke.py

    - name: ðŸ“‹ Validate Discovery Results
      run: |
        echo "ðŸ“‹ Validating plugin discovery results..."

        if [ -f plugin_discovery_results.json ]; then
          echo "âœ… Discovery results generated"
          cat plugin_discovery_results.json

          # Extract key metrics
          PLUGIN_COUNT=$(jq -r '.plugin_count // 0' plugin_discovery_results.json)
          ERROR_COUNT=$(jq -r '.errors | length' plugin_discovery_results.json)
          TEST_PASSED=$(jq -r '.test_passed // false' plugin_discovery_results.json)

          echo ""
          echo "ðŸ“Š Summary:"
          echo "   Discovery Mode: ${{ matrix.discovery-mode }}"
          echo "   Plugins Found: $PLUGIN_COUNT"
          echo "   Errors: $ERROR_COUNT"
          echo "   Result: $TEST_PASSED"

          # Mode-specific validation
          case "${{ matrix.discovery-mode }}" in
            "auto")
              if [ "$PLUGIN_COUNT" -eq 0 ] && [ "$ERROR_COUNT" -eq 0 ]; then
                echo "âš ï¸ Auto mode found no plugins but no errors - acceptable"
              elif [ "$ERROR_COUNT" -gt 0 ]; then
                echo "âŒ Auto mode had errors - needs investigation"
                exit 1
              else
                echo "âœ… Auto mode working correctly"
              fi
              ;;
            "explicit")
              if [ "$ERROR_COUNT" -eq 0 ]; then
                echo "âœ… Explicit mode working correctly"
              else
                echo "âŒ Explicit mode had errors"
                exit 1
              fi
              ;;
            "disabled")
              if [ "$ERROR_COUNT" -eq 0 ]; then
                echo "âœ… Disabled mode working correctly"
              else
                echo "âŒ Disabled mode had errors"
                exit 1
              fi
              ;;
          esac
        else
          echo "âŒ No discovery results file found"
          exit 1
        fi

    - name: ðŸ” Lane Guard Integration Test
      run: |
        echo "ðŸ” Testing plugin discovery with lane guard..."

        # Test that discovery respects lane boundaries
        cat > test_lane_discovery.py << 'EOF'
        import os
        import sys
        from pathlib import Path

        def test_lane_discovery():
            """Test plugin discovery respects lane isolation"""
            try:
                sys.path.insert(0, str(Path.cwd()))

                # Set test lane
                os.environ["LUKHAS_LANE"] = "candidate"

                from lukhas.core.registry import PluginRegistry
                registry = PluginRegistry()

                # Should only discover plugins appropriate for candidate lane
                plugins = registry.discover_plugins()

                print(f"âœ… Lane-aware discovery found {len(plugins)} plugins")

                # Test cross-lane import protection
                try:
                    # This should be blocked by lane guard
                    from production.sensitive_module import SecretPlugin
                    print("âŒ Cross-lane import not blocked!")
                    return False
                except (ImportError, ModuleNotFoundError):
                    print("âœ… Cross-lane import properly blocked")

                return True

            except Exception as e:
                print(f"âŒ Lane discovery test failed: {e}")
                return False

        if __name__ == "__main__":
            success = test_lane_discovery()
            sys.exit(0 if success else 1)
        EOF

        python test_lane_discovery.py || echo "âš ï¸ Lane discovery test failed (may be expected if no lane system)"

    - name: ðŸ“Š Upload Discovery Artifacts
      uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a
      if: always()
      with:
        name: plugin-discovery-results-${{ matrix.discovery-mode }}-py${{ matrix.python-version }}
        path: |
          plugin_discovery_results.json
          test_discovery_smoke.py
          test_lane_discovery.py

  discovery-summary:
    name: ðŸ“‹ Discovery Test Summary
    runs-on: ubuntu-latest
    needs: plugin-discovery-smoke
    if: always()

    steps:
    - name: ðŸ“¥ Download All Artifacts
      uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16
      with:
        path: discovery-results

    - name: ðŸ“Š Generate Summary Report
      run: |
        echo "ðŸ“Š PLUGIN DISCOVERY SMOKE TEST SUMMARY"
        echo "======================================"

        TOTAL_TESTS=0
        PASSED_TESTS=0
        FAILED_TESTS=0

        for result_dir in discovery-results/*/; do
          if [ -f "$result_dir/plugin_discovery_results.json" ]; then
            TOTAL_TESTS=$((TOTAL_TESTS + 1))

            MODE=$(jq -r '.discovery_mode // "unknown"' "$result_dir/plugin_discovery_results.json")
            PASSED=$(jq -r '.test_passed // false' "$result_dir/plugin_discovery_results.json")
            PLUGIN_COUNT=$(jq -r '.plugin_count // 0' "$result_dir/plugin_discovery_results.json")
            ERROR_COUNT=$(jq -r '.errors | length' "$result_dir/plugin_discovery_results.json")

            if [ "$PASSED" = "true" ]; then
              PASSED_TESTS=$((PASSED_TESTS + 1))
              STATUS="âœ… PASS"
            else
              FAILED_TESTS=$((FAILED_TESTS + 1))
              STATUS="âŒ FAIL"
            fi

            echo "Mode: $MODE | Plugins: $PLUGIN_COUNT | Errors: $ERROR_COUNT | $STATUS"
          fi
        done

        echo ""
        echo "ðŸ“Š Overall Results:"
        echo "   Total Tests: $TOTAL_TESTS"
        echo "   Passed: $PASSED_TESTS"
        echo "   Failed: $FAILED_TESTS"
        echo "   Success Rate: $(( PASSED_TESTS * 100 / TOTAL_TESTS ))%"

        if [ $FAILED_TESTS -gt 0 ]; then
          echo ""
          echo "ðŸš¨ Some plugin discovery tests failed!"
          echo "   This may indicate issues with:"
          echo "   - Plugin registry implementation"
          echo "   - Discovery mode configuration"
          echo "   - Lane isolation boundaries"
          echo "   - Import path resolution"
          exit 1
        else
          echo ""
          echo "ðŸŽ‰ All plugin discovery tests passed!"
          echo "   Plugin discovery system is operational"
        fi