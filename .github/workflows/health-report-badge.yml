name: Health Report Badge

on:
  pull_request:
    paths:
      - '**.py'
      - 'pyproject.toml'
      - 'pytest.ini'
      - 'scripts/system_health_audit.py'

jobs:
  health-audit:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -U pip
          pip install -r requirements.txt
          pip install pytest pytest-cov ruff

      - name: Run health audit
        id: health
        run: |
          export LUKHAS_POLICY_MODE=permissive
          python3 scripts/system_health_audit.py || true

          # Extract metrics from health report
          if [ -f docs/audits/health/latest.json ]; then
            SMOKE_PASSED=$(python3 -c "import json; d=json.load(open('docs/audits/health/latest.json')); print(d.get('summary',{}).get('tests',{}).get('smoke',{}).get('passed',0))")
            SMOKE_FAILED=$(python3 -c "import json; d=json.load(open('docs/audits/health/latest.json')); print(d.get('summary',{}).get('tests',{}).get('smoke',{}).get('failed',0))")
            SMOKE_TOTAL=$((SMOKE_PASSED + SMOKE_FAILED))
            RUFF_TOTAL=$(python3 -c "import json; d=json.load(open('docs/audits/health/latest.json')); print(d.get('summary',{}).get('ruff',{}).get('count',{}).get('total',0))")

            # Calculate smoke percentage
            if [ "$SMOKE_TOTAL" -gt 0 ]; then
              SMOKE_PCT=$(python3 -c "passed=${SMOKE_PASSED}; total=${SMOKE_TOTAL}; print(f'{(passed/total*100):.1f}')")
            else
              SMOKE_PCT="0.0"
            fi

            echo "smoke_passed=$SMOKE_PASSED" >> $GITHUB_OUTPUT
            echo "smoke_total=$SMOKE_TOTAL" >> $GITHUB_OUTPUT
            echo "smoke_pct=$SMOKE_PCT" >> $GITHUB_OUTPUT
            echo "ruff_total=$RUFF_TOTAL" >> $GITHUB_OUTPUT
          else
            echo "smoke_passed=0" >> $GITHUB_OUTPUT
            echo "smoke_total=0" >> $GITHUB_OUTPUT
            echo "smoke_pct=0.0" >> $GITHUB_OUTPUT
            echo "ruff_total=0" >> $GITHUB_OUTPUT
          fi

      - name: Get ruff budgets (Phase A & B)
        id: ruff_budgets
        run: |
          # Phase A: candidate/ labs/ (permissive)
          RUFF_PHASE_A=$(python3 -m ruff check candidate/ labs/ --output-format=concise 2>&1 | wc -l || echo "0")
          echo "ruff_phase_a=$RUFF_PHASE_A" >> $GITHUB_OUTPUT

          # Phase B: Hot paths (lukhas/adapters, lukhas/core/reliability)
          RUFF_PHASE_B=$(python3 -m ruff check lukhas/adapters/ lukhas/core/reliability/ --output-format=concise 2>&1 | wc -l || echo "0")
          echo "ruff_phase_b=$RUFF_PHASE_B" >> $GITHUB_OUTPUT

          # Budget ceilings (target vs gate)
          echo "budget_phase_a=5000" >> $GITHUB_OUTPUT
          echo "budget_phase_b_target=50" >> $GITHUB_OUTPUT
          echo "budget_phase_b_gate=120" >> $GITHUB_OUTPUT

      - name: Check OpenAPI headers guard
        id: openapi_guard
        run: |
          # Check if OpenAPI spec has required rate-limit headers
          if [ -f docs/openapi/lukhas-openapi.json ]; then
            HAS_HEADERS=$(python3 -c "
import json
spec = json.load(open('docs/openapi/lukhas-openapi.json'))
paths = spec.get('paths', {})
# Check if any endpoint documents x-ratelimit headers
has_rl = False
for path, methods in paths.items():
    for method, details in methods.items():
        if isinstance(details, dict):
            responses = details.get('responses', {})
            for code, resp in responses.items():
                if isinstance(resp, dict):
                    headers = resp.get('headers', {})
                    if any('ratelimit' in h.lower() for h in headers.keys()):
                        has_rl = True
                        break
print('pass' if has_rl else 'warn')
" || echo "fail")
            echo "openapi_headers=$HAS_HEADERS" >> $GITHUB_OUTPUT
          else
            echo "openapi_headers=not_found" >> $GITHUB_OUTPUT
          fi

      - name: Post PR comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const smokePassed = parseInt('${{ steps.health.outputs.smoke_passed }}');
            const smokeTotal = parseInt('${{ steps.health.outputs.smoke_total }}');
            const smokePct = parseFloat('${{ steps.health.outputs.smoke_pct }}');
            const ruffTotal = parseInt('${{ steps.health.outputs.ruff_total }}');

            const ruffPhaseA = parseInt('${{ steps.ruff_budgets.outputs.ruff_phase_a }}');
            const ruffPhaseB = parseInt('${{ steps.ruff_budgets.outputs.ruff_phase_b }}');
            const budgetA = parseInt('${{ steps.ruff_budgets.outputs.budget_phase_a }}');
            const budgetBTarget = parseInt('${{ steps.ruff_budgets.outputs.budget_phase_b_target }}');
            const budgetBGate = parseInt('${{ steps.ruff_budgets.outputs.budget_phase_b_gate }}');

            const openapiHeaders = '${{ steps.openapi_guard.outputs.openapi_headers }}';

            // Determine overall badge emoji
            const pct = parseFloat(smokePct);
            let badge = 'ðŸ”´';
            if (pct >= 95) badge = 'âœ…';
            else if (pct >= 85) badge = 'ðŸŸ¢';
            else if (pct >= 70) badge = 'ðŸŸ¡';
            else if (pct >= 50) badge = 'ðŸŸ ';

            // Ruff budget status (gate enforcement)
            const ruffAStatus = ruffPhaseA <= budgetA ? 'âœ…' : 'ðŸ”´';
            const ruffBStatus = ruffPhaseB <= budgetBGate ? 'âœ…' : 'ðŸ”´';
            const ruffBProgress = ruffPhaseB <= budgetBTarget ? 'âœ…' : 'ðŸŸ¡';

            // OpenAPI guard status
            let openapiStatus = 'â“';
            if (openapiHeaders === 'pass') openapiStatus = 'âœ…';
            else if (openapiHeaders === 'warn') openapiStatus = 'âš ï¸';
            else if (openapiHeaders === 'fail') openapiStatus = 'ðŸ”´';
            else if (openapiHeaders === 'not_found') openapiStatus = 'âšª';

            const comment = `## ${badge} Health Report Badge (GA Guard Pack)

| Metric | Value | Status |
|--------|-------|--------|
| **Smoke Tests (permissive)** | ${smokePassed}/${smokeTotal} passing | ${smokePct}% |
| **Ruff Phase A** (candidate/labs) | ${ruffPhaseA}/${budgetA} | ${ruffAStatus} |
| **Ruff Phase B** (hot paths) | ${ruffPhaseB} (target ${budgetBTarget}, gate ${budgetBGate}) | ${ruffBProgress} ${ruffBStatus} |
| **OpenAPI Headers Guard** | Rate-limit headers | ${openapiStatus} |

### Thresholds & Budgets
- **Smoke:** âœ… â‰¥95% Â· ðŸŸ¢ â‰¥85% Â· ðŸŸ¡ â‰¥70% Â· ðŸŸ  â‰¥50% Â· ðŸ”´ <50%
- **Ruff Phase A:** Budget â‰¤${budgetA} (candidate/labs, permissive)
- **Ruff Phase B:** Target â‰¤${budgetBTarget}, Gate â‰¤${budgetBGate} (lukhas/adapters, lukhas/core/reliability)
  - ðŸŸ¡ = between target and gate (acceptable, needs improvement)
  - âœ… = at or below target (excellent)
  - ðŸ”´ = exceeds gate (fails CI)
- **OpenAPI Guard:** âœ… Headers documented Â· âš ï¸ Partial Â· ðŸ”´ Missing

<details>
<summary>ðŸ“‹ Full Health Report</summary>

See [\`docs/audits/health/latest.md\`](../blob/${{ github.sha }}/docs/audits/health/latest.md) for complete health audit including:
- Guardian PDP decision counts
- Rate limiter backend status
- Test coverage details
- Dependency scan results

</details>

<details>
<summary>ðŸ’¡ About This Badge</summary>

**Purpose:** Provides reviewer-aid visibility into PR health without blocking merge.

**Metrics:**
- **Smoke %**: Permissive smoke test pass rate (informational)
- **Ruff Budgets**: Lint issue counts vs. phase-specific ceilings
- **OpenAPI Guard**: Validates rate-limit header documentation

**Not a gate:** This badge is informational; CI gates control merge eligibility.

</details>

---
*Generated by health-report-badge.yml Â· Non-blocking reviewer aid*
`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Health Report Badge')
            );

            if (botComment) {
              // Update existing comment (non-spam behavior)
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Upload health artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: health-report
          path: |
            docs/audits/health/latest.json
            docs/audits/health/latest.md
          retention-days: 30
