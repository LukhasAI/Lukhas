name: Health Report Badge

on:
  pull_request:
    paths:
      - '**.py'
      - 'pyproject.toml'
      - 'pytest.ini'
      - 'scripts/system_health_audit.py'

jobs:
  health-audit:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -U pip
          pip install -r requirements.txt
          pip install pytest pytest-cov ruff

      - name: Run health audit
        id: health
        run: |
          export LUKHAS_POLICY_MODE=permissive
          python3 scripts/system_health_audit.py || true

          # Extract metrics from health report
          if [ -f docs/audits/health/latest.json ]; then
            SMOKE_PASSED=$(python3 -c "import json; d=json.load(open('docs/audits/health/latest.json')); print(d.get('smoke',{}).get('parsed',{}).get('passed',0))")
            SMOKE_TOTAL=$(python3 -c "import json; d=json.load(open('docs/audits/health/latest.json')); print(d.get('smoke',{}).get('parsed',{}).get('total',0))")
            RUFF_COUNT=$(python3 -c "import json; d=json.load(open('docs/audits/health/latest.json')); print(d.get('ruff_stats',{}).get('parsed',{}).get('total_issues',0))")

            # Calculate percentages
            if [ "$SMOKE_TOTAL" -gt 0 ]; then
              SMOKE_PCT=$(python3 -c "print(f'{($SMOKE_PASSED/$SMOKE_TOTAL*100):.1f}')")
            else
              SMOKE_PCT="0.0"
            fi

            echo "smoke_passed=$SMOKE_PASSED" >> $GITHUB_OUTPUT
            echo "smoke_total=$SMOKE_TOTAL" >> $GITHUB_OUTPUT
            echo "smoke_pct=$SMOKE_PCT" >> $GITHUB_OUTPUT
            echo "ruff_count=$RUFF_COUNT" >> $GITHUB_OUTPUT
          else
            echo "smoke_passed=0" >> $GITHUB_OUTPUT
            echo "smoke_total=0" >> $GITHUB_OUTPUT
            echo "smoke_pct=0.0" >> $GITHUB_OUTPUT
            echo "ruff_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Get failing test names
        id: failures
        run: |
          export LUKHAS_POLICY_MODE=permissive
          FAILED=$(pytest tests/smoke/ --co -q 2>/dev/null | grep "test_" | head -10 | tr '\n' ',' || echo "")
          echo "failed_tests=$FAILED" >> $GITHUB_OUTPUT

      - name: Post PR comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const smokePassed = '${{ steps.health.outputs.smoke_passed }}';
            const smokeTotal = '${{ steps.health.outputs.smoke_total }}';
            const smokePct = '${{ steps.health.outputs.smoke_pct }}';
            const ruffCount = '${{ steps.health.outputs.ruff_count }}';

            // Determine badge emoji
            const pct = parseFloat(smokePct);
            let badge = 'ðŸ”´';
            if (pct >= 95) badge = 'âœ…';
            else if (pct >= 85) badge = 'ðŸŸ¢';
            else if (pct >= 70) badge = 'ðŸŸ¡';
            else if (pct >= 50) badge = 'ðŸŸ ';

            const comment = `## ${badge} Health Report Badge

            | Metric | Value | Status |
            |--------|-------|--------|
            | **Smoke Tests** | ${smokePassed}/${smokeTotal} passing | ${smokePct}% |
            | **Ruff Issues** | ${ruffCount} | ${ruffCount < 1000 ? 'ðŸŸ¢' : ruffCount < 5000 ? 'ðŸŸ¡' : 'ðŸ”´'} |

            ### Thresholds
            - âœ… â‰¥95% (Excellent)
            - ðŸŸ¢ â‰¥85% (Good)
            - ðŸŸ¡ â‰¥70% (Acceptable)
            - ðŸŸ  â‰¥50% (Needs Work)
            - ðŸ”´ <50% (Critical)

            <details>
            <summary>ðŸ“‹ Full Health Report</summary>

            See [latest health report](../blob/${{ github.sha }}/docs/audits/health/latest.md) for details.

            </details>

            ---
            *Generated by health-report-badge.yml*
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Health Report Badge')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Upload health artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: health-report
          path: |
            docs/audits/health/latest.json
            docs/audits/health/latest.md
          retention-days: 30
