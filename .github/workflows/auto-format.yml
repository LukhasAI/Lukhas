name: Auto-Format Code

on:
  push:
    branches: [ main, develop ]
  pull_request:
    types: [ opened, synchronize ]
  workflow_dispatch:
    inputs:
      fix_level:
        description: 'Fix level (safe, aggressive, all)'
        required: false
        default: 'safe'
        type: choice
        options:
          - safe
          - aggressive
          - all

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-format:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'

    - name: Install formatters
      run: |
        python -m pip install --upgrade pip
        pip install black ruff isort autopep8 autoflake

    - name: Run autoflake (remove unused imports)
      if: github.event.inputs.fix_level == 'aggressive' || github.event.inputs.fix_level == 'all'
      run: |
        autoflake --in-place --remove-all-unused-imports --remove-unused-variables \
          --recursive --exclude="__pycache__,*.pyc,*.pyo,.git,.venv,venv" .

    - name: Run isort (sort imports)
      run: |
        isort . --profile black --skip-glob="**/venv/**" --skip-glob="**/.venv/**"

    - name: Run black (format code)
      run: |
        black . --exclude="/(\.git|\.venv|venv|__pycache__|build|dist)/"

    - name: Run ruff with safe fixes
      if: github.event.inputs.fix_level == 'safe' || github.event.inputs.fix_level == ''
      run: |
        ruff check . --fix --select E,W,F401,UP --exclude ".venv,venv,__pycache__"

    - name: Run ruff with aggressive fixes
      if: github.event.inputs.fix_level == 'aggressive' || github.event.inputs.fix_level == 'all'
      run: |
        ruff check . --fix --exclude ".venv,venv,__pycache__"

    - name: Check for changes
      id: verify_changes
      run: |
        git diff --name-only --exit-code || echo "changes=true" >> $GITHUB_OUTPUT

    - name: Commit and push changes
      if: steps.verify_changes.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Stage changes
        git add -A
        
        # Create commit message
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          COMMIT_MSG="style: Auto-format code in PR #${{ github.event.pull_request.number }}"
        else
          COMMIT_MSG="style: Auto-format code"
        fi
        
        # Add fix level to commit message if specified
        if [ "${{ github.event.inputs.fix_level }}" != "" ]; then
          COMMIT_MSG="$COMMIT_MSG (level: ${{ github.event.inputs.fix_level }})"
        fi
        
        git commit -m "$COMMIT_MSG

        - Removed unused imports and variables
        - Sorted imports with isort
        - Formatted with black
        - Applied ruff fixes
        
        Auto-formatted by GitHub Actions"
        
        # Push changes
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          git push origin HEAD:${{ github.head_ref }}
        else
          git push
        fi

    - name: Comment on PR
      if: github.event_name == 'pull_request' && steps.verify_changes.outputs.changes == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'âœ¨ **Auto-formatting applied!**\n\nI\'ve automatically formatted the code in this PR using:\n- ðŸ§¹ autoflake (removed unused imports)\n- ðŸ“¦ isort (sorted imports)\n- âš« black (code formatting)\n- ðŸ”§ ruff (additional fixes)\n\nPlease review the changes.'
          })

  code-quality-report:
    runs-on: ubuntu-latest
    needs: auto-format
    if: always()
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install analysis tools
      run: |
        python -m pip install --upgrade pip
        pip install ruff pylint radon

    - name: Generate quality report
      run: |
        echo "# Code Quality Report" > quality_report.md
        echo "" >> quality_report.md
        
        # Count remaining issues
        echo "## Remaining Issues" >> quality_report.md
        ruff check . --statistics --exclude ".venv,venv" | head -20 >> quality_report.md || true
        
        # Complexity analysis
        echo "" >> quality_report.md
        echo "## Complexity Analysis" >> quality_report.md
        radon cc . -s -e ".venv,venv,__pycache__" | head -30 >> quality_report.md || true
        
        # Maintainability index
        echo "" >> quality_report.md
        echo "## Maintainability Index" >> quality_report.md
        radon mi . -s -e ".venv,venv,__pycache__" | head -20 >> quality_report.md || true

    - name: Upload quality report
      uses: actions/upload-artifact@v4
      with:
        name: code-quality-report
        path: quality_report.md

    - name: Post quality summary
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('quality_report.md', 'utf8');
          
          // Truncate if too long
          const maxLength = 60000;
          const truncatedReport = report.length > maxLength 
            ? report.substring(0, maxLength) + '\n\n... (truncated)'
            : report;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ðŸ“Š **Code Quality Report**\n\n${truncatedReport}`
          })