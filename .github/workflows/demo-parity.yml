name: Matrix Tracks Demo Parity Check

on:
  pull_request:
    paths:
      - 'examples/matrix_tracks/**'
      - 'tools/generate_car.py'
      - 'tools/collect_attestation.py'
      - 'models/memory/cascade.pm'
      - 'rats/policy-*.yaml'
      - '.github/workflows/demo-parity.yml'
  push:
    branches: [main]
    paths:
      - 'examples/matrix_tracks/**'
      - 'tools/generate_car.py'
      - 'tools/collect_attestation.py'
  schedule:
    # Run weekly to catch drift
    - cron: '0 6 * * 2'  # Tuesday 6 AM UTC
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  demo-parity:
    name: Check Demo-Production Parity
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install jsonschema pyyaml

      - name: Install PRISM (if available)
        run: |
          # Try to install PRISM for verification track validation
          # Note: This is optional - demo should work with or without PRISM
          echo "üîÆ Attempting to install PRISM model checker..."

          # Try different installation methods
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y openjdk-11-jre-headless

            # Download PRISM (simplified - in production use official installer)
            wget -q https://github.com/prismmodelchecker/prism/releases/download/v4.8.1/prism-4.8.1-linux64-x86.tar.gz || true
            if [ -f "prism-4.8.1-linux64-x86.tar.gz" ]; then
              tar -xzf prism-4.8.1-linux64-x86.tar.gz
              sudo mv prism-4.8.1-linux64-x86/bin/prism /usr/local/bin/ || true
            fi
          fi

          # Check if PRISM is available
          if command -v prism >/dev/null 2>&1; then
            echo "‚úÖ PRISM available: $(prism -version | head -1)"
          else
            echo "‚ö†Ô∏è PRISM not available - verification track will use mock validation"
          fi

      - name: Run Demo Parity Checks
        id: parity_check
        run: |
          echo "üîç Running Matrix Tracks demo-production parity checks..."

          # Run parity checker
          python3 tools/demo_parity_check.py --output reports/demo_parity_report.md

          # Extract results for GitHub Actions
          PARITY_STATUS=$(python3 tools/demo_parity_check.py --json-only | jq -r '.overall_status')
          TOTAL_ISSUES=$(python3 tools/demo_parity_check.py --json-only | jq -r '.total_issues')

          echo "parity_status=$PARITY_STATUS" >> $GITHUB_OUTPUT
          echo "total_issues=$TOTAL_ISSUES" >> $GITHUB_OUTPUT

          # Create summary for step summary
          echo "### üîÑ Demo-Production Parity Results" >> $GITHUB_STEP_SUMMARY

          if [ "$PARITY_STATUS" = "passing" ]; then
            echo "‚úÖ **Status:** All demos maintain parity with production tools" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Status:** $TOTAL_ISSUES parity issue(s) found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Track | Status | Issues |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|---------|--------|" >> $GITHUB_STEP_SUMMARY

          # Add track details
          python3 -c "
          import json
          import subprocess
          result = subprocess.run(['python3', 'tools/demo_parity_check.py', '--json-only'],
                                capture_output=True, text=True)
          data = json.loads(result.stdout)
          for track, details in data['tracks'].items():
              status_emoji = '‚úÖ' if details['status'] == 'passing' else '‚ùå'
              print(f'| {track} | {status_emoji} {details[\"status\"]} | {len(details[\"issues\"])} |')
          " >> $GITHUB_STEP_SUMMARY

      - name: Test Demo Scripts
        run: |
          echo "üß™ Testing demo scripts are executable and runnable..."

          # Test verification demo
          cd examples/matrix_tracks/verification
          chmod +x run_prism.sh
          echo "Testing verification demo..."
          timeout 30 ./run_prism.sh || echo "Verification demo completed (may show mock output)"

          # Test provenance demo
          cd ../provenance
          chmod +x generate_car.sh verify_car.sh
          echo "Testing provenance demo..."
          timeout 30 ./generate_car.sh || echo "Provenance generate completed"
          timeout 30 ./verify_car.sh || echo "Provenance verify completed"

          # Test attestation demo
          cd ../attestation
          chmod +x verify_evidence.sh
          echo "Testing attestation demo..."
          timeout 30 ./verify_evidence.sh || echo "Attestation demo completed"

      - name: Upload Parity Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: demo-parity-report
          path: |
            reports/demo_parity_report.md
            reports/demo_parity_report.json

      - name: Comment PR (if parity issues found)
        if: github.event_name == 'pull_request' && steps.parity_check.outputs.total_issues != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let reportContent = '';
            try {
              reportContent = fs.readFileSync('reports/demo_parity_report.md', 'utf8');
            } catch (e) {
              reportContent = 'Parity report not available';
            }

            const comment = `## ‚ö†Ô∏è Demo-Production Parity Issues Detected

**Found ${{ steps.parity_check.outputs.total_issues }} parity issue(s)** in Matrix Tracks demos.

${reportContent}

### üîß What This Means

Demo scripts may not accurately represent production tool capabilities. This can mislead teams trying to understand Matrix Tracks functionality.

### üéØ Action Required

Please review and fix the parity issues before merging to ensure demos remain reliable learning tools.

---

*This check runs automatically to prevent demo drift. See [demo parity docs](docs/MATRIX_TRACKS.md#demo-production-parity) for more information.*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail if Parity Issues (PR only)
        if: github.event_name == 'pull_request' && steps.parity_check.outputs.total_issues != '0'
        run: |
          echo "‚ùå Demo parity check failed with ${{ steps.parity_check.outputs.total_issues }} issue(s)"
          echo "Demos must maintain parity with production tools to prevent misleading users"
          exit 1

      - name: Success Summary
        if: steps.parity_check.outputs.parity_status == 'passing'
        run: |
          echo "‚úÖ All Matrix Tracks demos maintain parity with production tools!"
          echo "Demos accurately represent production capabilities and can be trusted for learning."