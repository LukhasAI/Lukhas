name: PQC Sign & Verify (Dilithium2)

on:
  push:
    paths:
      - 'services/registry/**'
      - '.github/workflows/pqc-sign-verify.yml'
  pull_request:
    paths:
      - 'services/registry/**'

jobs:
  pqc_check:
    runs-on: ubuntu-latest
    env:
      OQS_INSTALL_PREFIX: ${{ github.workspace }}/.oqs
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            libssl-dev \
            pkg-config \
            jq \
            bc

      - name: Configure liboqs environment
        run: |
          mkdir -p "$OQS_INSTALL_PREFIX"
          echo "OQS_INSTALL_PREFIX=$OQS_INSTALL_PREFIX" >> "$GITHUB_ENV"
          echo "LD_LIBRARY_PATH=$OQS_INSTALL_PREFIX/lib:${LD_LIBRARY_PATH}" >> "$GITHUB_ENV"
          echo "PKG_CONFIG_PATH=$OQS_INSTALL_PREFIX/lib/pkgconfig:${PKG_CONFIG_PATH}" >> "$GITHUB_ENV"
          echo "CMAKE_PREFIX_PATH=$OQS_INSTALL_PREFIX:${CMAKE_PREFIX_PATH}" >> "$GITHUB_ENV"
          echo "PATH=$OQS_INSTALL_PREFIX/bin:${PATH}" >> "$GITHUB_ENV"

      - name: Restore cached liboqs build
        id: cache-liboqs
        uses: actions/cache@v4
        with:
          path: ${{ env.OQS_INSTALL_PREFIX }}
          key: liboqs-0.9.2-${{ runner.os }}

      - name: Build liboqs from source
        if: steps.cache-liboqs.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 --branch 0.9.2 https://github.com/open-quantum-safe/liboqs.git /tmp/liboqs
          cmake -S /tmp/liboqs -B /tmp/liboqs/build \
            -GNinja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX="$OQS_INSTALL_PREFIX" \
            -DBUILD_SHARED_LIBS=ON \
            -DOQS_BUILD_ONLY_LIB=ON \
            -DOQS_DIST_BUILD=ON
          cmake --build /tmp/liboqs/build
          cmake --install /tmp/liboqs/build
          rm -rf /tmp/liboqs

      - name: Install python-oqs bindings
        run: |
          python -m pip install --upgrade pip
          python -m pip install liboqs-python==0.9.0

      - name: Verify liboqs availability
        run: |
          python -c "import oqs; print('liboqs version:', oqs.__oqs_version__); print('python-oqs version:', oqs.__version__)"

      - name: Run PQC Benchmark
        run: |
          echo "Running PQC benchmark..."
          mkdir -p tmp
          if python scripts/pqc/pqc_bench.py --json --output tmp/pqc_bench.json; then
            cat tmp/pqc_bench.json
          else
            echo "⚠️ pqc-bench failed, creating fallback marker"
            echo '{"status":"fallback","message":"PQC bench not available"}' > tmp/pqc_bench.json
            touch tmp/pqc_fallback_marker.txt
          fi

      - name: Validate PQC Performance
        run: |
          if [ -f tmp/pqc_fallback_marker.txt ]; then
            echo "::error::PQC benchmark entered fallback mode - required dependencies missing"
            exit 1
          fi

          # Check sign/verify latency thresholds
          sign_p95=$(jq -r '.sign_p95' tmp/pqc_bench.json)
          verify_p95=$(jq -r '.verify_p95' tmp/pqc_bench.json)

          echo "Sign p95: ${sign_p95}ms (threshold: <50ms)"
          echo "Verify p95: ${verify_p95}ms (threshold: <10ms)"

          # Validate thresholds (convert ms to comparison-friendly format)
          if (( $(echo "$sign_p95 > 50" | bc -l) )); then
            echo "::error::Sign latency ${sign_p95}ms exceeds 50ms threshold"
            exit 1
          fi

          if (( $(echo "$verify_p95 > 10" | bc -l) )); then
            echo "::error::Verify latency ${verify_p95}ms exceeds 10ms threshold"
            exit 1
          fi

          echo "✓ PQC performance within SLO targets"

      - name: Upload PQC Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pqc-bench-results
          path: |
            tmp/pqc_bench.json
            tmp/pqc_fallback_marker.txt
          if-no-files-found: ignore
