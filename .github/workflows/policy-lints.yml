name: Brand Policy Enforcement

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'lukhas_website/**'
      - 'branding/**'
      - '**/*.md'
      - '**/*.tsx'
      - '**/*.jsx'
      - '**/*.html'
  schedule:
    # Weekly brand scan every Monday at 9 AM UTC
    - cron: '0 9 * * 1'

jobs:
  policy-enforcement:
    runs-on: ubuntu-latest
    name: Brand, Tone & Accessibility Enforcement

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for comprehensive scanning

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: lukhas_website/package-lock.json

    - name: Install dependencies
      run: |
        cd lukhas_website
        npm ci

    - name: Run Comprehensive Policy Linting
      id: policy-lint
      run: |
        cd lukhas_website
        npm run lint:policy
      continue-on-error: true

    - name: Create Policy Report
      if: failure()
      run: |
        echo "## ðŸš« Policy Enforcement Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Brand policy violations detected. Build blocked until resolved." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Failed Checks:" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.policy-lint.outcome }}" = "failure" ]; then
          echo "- âŒ **Comprehensive Policy Check**: Multiple violations detected" >> $GITHUB_STEP_SUMMARY
          echo "  - Brand Policy: MATADA/Î› usage violations" >> $GITHUB_STEP_SUMMARY
          echo "  - Tone Policy: Banned words, word count, or readability violations" >> $GITHUB_STEP_SUMMARY
          echo "  - Accessibility: WCAG 2.1 AA compliance issues" >> $GITHUB_STEP_SUMMARY
          echo "  - SVG Security: Render-proofing or CSP violations" >> $GITHUB_STEP_SUMMARY
          echo "  - Vendor Neutrality: Implied endorsements detected" >> $GITHUB_STEP_SUMMARY
          echo "  - International: False friends in supported locales" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Quick Fixes:" >> $GITHUB_STEP_SUMMARY
        echo "- Replace public 'MATADA' with 'Matriz'" >> $GITHUB_STEP_SUMMARY
        echo "- Add \`aria-label=\"Matriz\"\` to Î› elements" >> $GITHUB_STEP_SUMMARY
        echo "- Remove banned words: guaranteed, perfect, revolutionary, etc." >> $GITHUB_STEP_SUMMARY
        echo "- Limit poetic sections to â‰¤40 words" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ðŸ“š Documentation:** \`branding/BRAND_POLICY.md\`" >> $GITHUB_STEP_SUMMARY

    - name: Success Report
      if: success()
      run: |
        echo "## âœ… Policy Enforcement Passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "All brand, tone, and accessibility policies are compliant." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Validated:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Brand Policy**: Proper MATRIZ/Matriz usage" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Tone Policy**: No banned words, word count limits respected" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Accessibility**: WCAG 2.1 AA compliance for brand elements" >> $GITHUB_STEP_SUMMARY

    # Fail the job if policy linter failed
    - name: Check Policy Results
      if: steps.policy-lint.outcome == 'failure'
      run: |
        echo "âŒ Comprehensive policy enforcement failed. See job summary for details."
        exit 1

  brand-council-notification:
    needs: policy-enforcement
    runs-on: ubuntu-latest
    if: failure() && github.event_name == 'pull_request'

    steps:
    - name: Notify Brand Council
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo, number } = context.issue;

          await github.rest.issues.createComment({
            owner,
            repo,
            issue_number: number,
            body: `## ðŸš« Brand Policy Violation Detected

This PR contains brand policy violations that block the build process.

### Required Actions:
1. **Fix violations** listed in the CI job summary
2. **Run locally**: \`npm run lint:policy\` in \`lukhas_website/\`
3. **Re-push** when all violations are resolved

### Brand Guidelines:
- Use **"Matriz"** in body text, **"MÎ›TRIZ"** only in logos/headers
- Add \`aria-label="Matriz"\` to all Î› usage
- Avoid banned words: guaranteed, perfect, revolutionary, etc.
- Limit poetic content to â‰¤40 words

**ðŸ“š Full guidelines:** \`branding/BRAND_POLICY.md\`

*This is an automated message from the Brand Council enforcement system.*`
          });

# Weekly monitoring job
  weekly-brand-scan:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        cd lukhas_website
        npm ci

    - name: Full Repository Brand Scan
      run: |
        echo "ðŸ” Weekly brand compliance scan..."
        cd lukhas_website
        npm run lint:policy || true

    - name: Generate Compliance Report
      run: |
        echo "## ðŸ“Š Weekly Brand Compliance Report" >> weekly-report.md
        echo "**Scan Date:** $(date)" >> weekly-report.md
        echo "" >> weekly-report.md
        # Additional reporting logic here

    # In a real implementation, this would post to Slack or similar
