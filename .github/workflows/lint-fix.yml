name: Lint Fix (Directory)

on:
  workflow_dispatch:
    inputs:
      dir:
        description: "Directory to ruff --fix (e.g., lukhas, serve, tools)"
        required: true
      ref:
        description: "Branch or ref to run against (e.g., infra/lint-lukhas)"
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  ruff-fix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target ref
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
        with:
          fetch-depth: 0
          ref: ${{ inputs.ref }}

      - name: Setup Python
        uses: actions/setup-python@39cd14951b08e74b54015e9e001cdefcf80e669f
        with:
          python-version: '3.11'

      - name: Install ruff
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Run ruff --fix on input dir
        id: ruff
        run: |
          set -e
          echo "Fixing directory: ${{ inputs.dir }}"
          ruff check "${{ inputs.dir }}" --fix || true
          if git diff --quiet -- "${{ inputs.dir }}"; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.ruff.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "${{ inputs.dir }}"
          git commit -m "chore(lint:${{ inputs.dir }}): ruff auto-fixes (no logic changes)"
          git push origin "${{ inputs.ref }}"

