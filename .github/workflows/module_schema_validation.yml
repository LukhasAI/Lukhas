# LUKHAS Module Schema Validation Workflow
# Validates module schemas on every PR and commit

name: Module Schema Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'modules/*.yaml'
      - 'modules/schema_validator.json'
      - 'tools/module_schema_*.py'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'modules/*.yaml'
      - 'modules/schema_validator.json'
      - 'tools/module_schema_*.py'

jobs:
  validate-schemas:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
    
    - name: Set up Python
      uses: actions/setup-python@39cd14951b08e74b54015e9e001cdefcf80e669f
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install jsonschema pyyaml
    
    - name: Validate module schemas
      run: |
        python tools/module_schema_validator.py modules/schema_validator.json modules/
    
    - name: Check schema completeness
      run: |
        echo "Checking for missing schemas..."
        python -c "
        import os
        from pathlib import Path
        
        # Count Python modules
        module_dirs = ['candidate', 'lukhas', 'branding', 'matriz', 'products', 'tools']
        python_modules = []
        
        for module_dir in module_dirs:
            if os.path.exists(module_dir):
                for item in Path(module_dir).iterdir():
                    if item.is_dir() and not item.name.startswith('.'):
                        module_name = f'{module_dir}.{item.name}'
                        if any(Path(item).rglob('*.py')):
                            python_modules.append(module_name)
        
        # Count schema files
        schema_files = list(Path('modules').glob('*.yaml'))
        schema_files = [f for f in schema_files if f.name not in ['module_schema_template.yaml']]
        
        print(f'Python modules found: {len(python_modules)}')
        print(f'Schema files found: {len(schema_files)}')
        
        if len(schema_files) < len(python_modules):
            print('Warning: Some modules may be missing schemas')
        else:
            print('âœ… Schema coverage looks good')
        "
    
    - name: Generate validation report
      if: always()
      run: |
        echo "## Module Schema Validation Report" > schema_validation_report.md
        echo "- **Timestamp**: $(date)" >> schema_validation_report.md
        echo "- **Commit**: ${{ github.sha }}" >> schema_validation_report.md
        echo "- **Branch**: ${{ github.ref_name }}" >> schema_validation_report.md
        echo "" >> schema_validation_report.md
        
        schema_count=$(find modules -name "*.yaml" | wc -l)
        echo "- **Total Schemas**: $schema_count" >> schema_validation_report.md
        echo "- **Validation Status**: See job output above" >> schema_validation_report.md
    
    - name: Upload validation report
      if: always()
      uses: actions/upload-artifact@a8a3f3ad30e3422c9c7b888a15615d19a852ae32  # v3
      with:
        name: schema-validation-report
        path: schema_validation_report.md