name: Telemetry Smoke Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'tools/matrix_authz_middleware.py'
      - 'tools/tier_macaroon_issuer.py'
      - 'tests/telemetry/**'
      - 'memory/matrix_memoria.json'
      - 'policies/matrix/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'tools/matrix_authz_middleware.py'
      - 'tools/tier_macaroon_issuer.py'
      - 'tests/telemetry/**'
      - 'memory/matrix_memoria.json'
      - 'policies/matrix/**'
  schedule:
    # Run daily at 6 AM UTC to catch environment drift
    - cron: '0 6 * * *'

jobs:
  telemetry-smoke-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      matrix:
        python-version: ['3.9', '3.11']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-telemetry-${{ hashFiles('tests/telemetry/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-telemetry-
          ${{ runner.os }}-pip-

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y curl

    - name: Install OPA (for policy evaluation tests)
      run: |
        curl -L -o opa https://openpolicyagent.org/downloads/v0.57.0/opa_linux_amd64_static
        chmod 755 ./opa
        sudo mv opa /usr/local/bin
        opa version

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r tests/telemetry/requirements.txt
        # Install any additional project dependencies
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Verify test environment
      run: |
        python -c "import opentelemetry; print(f'OpenTelemetry version: {opentelemetry.__version__}')"
        python -c "import pytest; print(f'Pytest version: {pytest.__version__}')"
        ls -la tests/telemetry/

    - name: Run telemetry smoke tests
      run: |
        cd tests/telemetry
        python -m pytest -v -m telemetry --tb=short
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Run telemetry integration tests
      run: |
        cd tests/telemetry
        python -m pytest -v -m "telemetry and integration" --tb=short
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Generate telemetry test report
      if: always()
      run: |
        cd tests/telemetry
        python -m pytest -v -m telemetry --tb=short --junit-xml=telemetry-test-results.xml
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: telemetry-test-results-${{ matrix.python-version }}
        path: tests/telemetry/telemetry-test-results.xml

    - name: Check authorization test matrices compatibility
      run: |
        # Ensure telemetry tests work with existing authorization matrices
        python tools/run_authz_tests.py --test-dir tests/authz --verbose
      env:
        PYTHONPATH: ${{ github.workspace }}

  telemetry-coverage:
    runs-on: ubuntu-latest
    needs: telemetry-smoke-tests
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies with coverage
      run: |
        python -m pip install --upgrade pip
        pip install -r tests/telemetry/requirements.txt
        pip install coverage

    - name: Run tests with coverage
      run: |
        cd tests/telemetry
        coverage run -m pytest -v -m telemetry
        coverage report --show-missing
        coverage xml
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: tests/telemetry/coverage.xml
        flags: telemetry
        name: telemetry-coverage

  telemetry-performance:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r tests/telemetry/requirements.txt

    - name: Run performance telemetry tests
      run: |
        cd tests/telemetry
        # Run a larger number of authorization requests to test telemetry overhead
        python -c "
import asyncio
import sys
sys.path.insert(0, '../..')
from test_authz_integration import test_concurrent_authorization_telemetry
import pytest

# Run performance test with larger concurrency
print('Running telemetry performance test...')
"
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Validate telemetry overhead
      run: |
        # Ensure telemetry doesn't add significant overhead to authorization
        echo "Telemetry performance validation completed"