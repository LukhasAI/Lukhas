name: T4 Hardening

on:
  push:
    branches: [ main, trunk, develop ]
  pull_request:
    branches: [ main, trunk, develop ]

env:
  # Hermetic determinism for reproducible results
  PYTHONHASHSEED: "0"
  TZ: "UTC"
  LUKHAS_RNG_SEED: "42"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PIP_NO_PYTHON_VERSION_WARNING: "1"
  # strict emitter & short stress run for CI
  LUKHAS_STRICT_EMIT: "1"
  LUKHAS_STRESS_DURATION: "1.0"
  # lane canary by default unless CI_RELEASE=1
  LUKHAS_LANE: "experimental"
  # feature flags default-false check
  DISPATCH_ENABLED: "false"
  LEARNING_ENABLED: "false"
  # make pytest discover our config and markers
  PYTEST_ADDOPTS: "-q"

jobs:
  tests:
    name: T4 hardening (py${{ matrix.python-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        python-version: [ "3.9", "3.10", "3.11" ]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install system deps (if any)
        run: sudo apt-get update

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          # Install project with dev dependencies
          pip install -e .[dev]
          # Ensure additional test dependencies
          pip install pytest-asyncio pytest-json-report pytest-rerunfailures

          # Generate requirements.lock for toolchain pinning
          pip freeze > requirements-${{ matrix.python-version }}.lock

      - name: Show pytest & env
        run: |
          python -V
          pytest --version
          echo "PYTEST_ADDOPTS=$PYTEST_ADDOPTS"
          echo "LUKHAS_STRICT_EMIT=$LUKHAS_STRICT_EMIT"
          echo "LUKHAS_STRESS_DURATION=$LUKHAS_STRESS_DURATION"

      - name: Run audit (collection must be clean)
        run: |
          if [ -f scripts/audit_tests.py ]; then python scripts/audit_tests.py; else echo "No audit script found"; fi

      - name: Flake radar (catch intermittent failures)
        run: |
          echo "Running flake detection with rerun failures..."
          pytest tests/unit/metrics/ tests/capabilities/ -q -x --maxfail=1 -ra --reruns=1 --reruns-delay=1 -k 'not slow' | tee /tmp/flake_radar.log

          # Fail if any rerun was needed (treat as flaky)
          if grep -q "RERUN" /tmp/flake_radar.log; then
            echo "❌ Flaky test detected - rerun was needed"
            grep "RERUN" /tmp/flake_radar.log
            exit 1
          fi
          echo "✅ No flaky tests detected"

      - name: T4 unit contracts
        run: |
          mkdir -p reports
          echo "T4 unit contracts" | tee -a /tmp/t4_success.log
          pytest tests/unit/metrics/ -v --maxfail=1 --durations=10 --junitxml=reports/junit-unit.xml --json-report --json-report-file=reports/pytest-unit.json | tee -a /tmp/t4_success.log

          # Time-budget guardrail
          SUITE="Unit contracts"
          BUDGET_SEC=60
          ELAPSED=$(jq -r '.report.duration // empty' reports/pytest-unit.json 2>/dev/null || echo "")
          if [ -n "$ELAPSED" ]; then
            python - <<'PY'
import os,sys
elapsed=float(os.environ.get("ELAPSED","0") or 0)
budget=float(os.environ.get("BUDGET_SEC","0") or 0)
suite=os.environ.get("SUITE","suite")
if budget and elapsed>budget:
    print(f"❌ {suite}: elapsed {elapsed:.2f}s > budget {budget:.2f}s")
    sys.exit(1)
print(f"✅ {suite}: elapsed {elapsed:.2f}s within budget {budget:.2f}s")
PY
          fi

      - name: T4 capability suite
        run: |
          echo "T4 capability suite" | tee -a /tmp/t4_success.log
          pytest tests/capabilities/ -m capability -v --maxfail=1 --durations=10 --junitxml=reports/junit-capabilities.xml --json-report --json-report-file=reports/pytest-capabilities.json | tee -a /tmp/t4_success.log

          # Time-budget guardrail
          SUITE="Capabilities"
          BUDGET_SEC=120
          ELAPSED=$(jq -r '.report.duration // empty' reports/pytest-capabilities.json 2>/dev/null || echo "")
          if [ -n "$ELAPSED" ]; then
            python - <<'PY'
import os,sys
elapsed=float(os.environ.get("ELAPSED","0") or 0)
budget=float(os.environ.get("BUDGET_SEC","0") or 0)
suite=os.environ.get("SUITE","suite")
if budget and elapsed>budget:
    print(f"❌ {suite}: elapsed {elapsed:.2f}s > budget {budget:.2f}s")
    sys.exit(1)
print(f"✅ {suite}: elapsed {elapsed:.2f}s within budget {budget:.2f}s")
PY
          fi

      - name: Consciousness e2e (smoke)
        run: |
          echo "Consciousness e2e (smoke)" | tee -a /tmp/t4_success.log
          pytest tests/e2e/consciousness/test_consciousness_emergence.py -v -k "signal_cascade_prevention or network_coherence_emergence" \
            --maxfail=1 --durations=10 --junitxml=reports/junit-e2e-consciousness.xml --json-report --json-report-file=reports/pytest-e2e.json | tee -a /tmp/t4_success.log

          # Time-budget guardrail
          SUITE="E2E smoke"
          BUDGET_SEC=60
          ELAPSED=$(jq -r '.report.duration // empty' reports/pytest-e2e.json 2>/dev/null || echo "")
          if [ -n "$ELAPSED" ]; then
            python - <<'PY'
import os,sys
elapsed=float(os.environ.get("ELAPSED","0") or 0)
budget=float(os.environ.get("BUDGET_SEC","0") or 0)
suite=os.environ.get("SUITE","suite")
if budget and elapsed>budget:
    print(f"❌ {suite}: elapsed {elapsed:.2f}s > budget {budget:.2f}s")
    sys.exit(1)
print(f"✅ {suite}: elapsed {elapsed:.2f}s within budget {budget:.2f}s")
PY
          fi

      - name: Upload JUnit reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: t4-junit-${{ matrix.python-version }}
          path: reports/*.xml
          if-no-files-found: ignore

      - name: T4 success gate
        if: always()
        run: |
          set -euo pipefail
          LOG=/tmp/t4_success.log
          echo "=== SUCCESS VERIFICATION ==="
          grep -q "T4 unit contracts"    "$LOG"
          grep -q "T4 capability suite"   "$LOG"
          grep -q "Consciousness e2e (smoke)" "$LOG"

          # Ensure "slowest 10 durations" banner appeared for each suite/job
          grep -q "slowest 10 durations" "$LOG"

          echo "✅ T4 pipeline reached all suites with timing summaries"

          # Stability sentinel (catch intermittent slippage)
          # Check unrouted counter stayed flat
          grep -q "lukhas_router_no_rule_total.* rate.*0" "$LOG" || {
            echo "❌ Unrouted-signal rate nonzero"; exit 1; }

          # Check coherence hit target at least once
          grep -Eq "network_coherence[:=]\s*(0\.7[0-9]*|0\.[89]|1(\.0+)?)" "$LOG" || {
            echo "❌ Coherence never reached ≥0.70"; exit 1; }

          # Run performance budget checks
          python scripts/check_perf_budgets.py

          # Validate alert configurations
          python scripts/validate_alerts.py

          echo "✅ T4 Hardening validation complete for Python ${{ matrix.python-version }}"

      - name: Upload T4 artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: t4-artifacts-${{ matrix.python-version }}
          path: |
            /tmp/t4_success.log
            /tmp/flake_radar.log
            reports/pytest-*.json
            requirements-${{ matrix.python-version }}.lock
          if-no-files-found: ignore