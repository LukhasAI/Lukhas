name: T4 Hardening

on:
  push:
    branches: [ main, trunk, develop ]
  pull_request:
    branches: [ main, trunk, develop ]

env:
  # Hermetic determinism for reproducible results
  PYTHONHASHSEED: "0"
  TZ: "UTC"
  LUKHAS_RNG_SEED: "42"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PIP_NO_PYTHON_VERSION_WARNING: "1"
  # strict emitter & short stress run for CI
  LUKHAS_STRICT_EMIT: "1"
  LUKHAS_STRESS_DURATION: "1.0"
  # lane canary by default unless CI_RELEASE=1
  LUKHAS_LANE: "experimental"
  # feature flags default-false check
  DISPATCH_ENABLED: "false"
  LEARNING_ENABLED: "false"
  # make pytest discover our config and markers
  PYTEST_ADDOPTS: "-q"

jobs:
  tests:
    name: T4 hardening (py${{ matrix.python-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        python-version: [ "3.9", "3.10", "3.11" ]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install system deps (if any)
        run: sudo apt-get update

      - name: Install Python deps (locked if available)
        run: |
          python -m pip install --upgrade pip
          PYVER="${{ matrix.python-version }}"

          # Prefer lockfile per Python version if present
          if [ -f "requirements-${PYVER}.lock" ]; then
            echo "Using locked requirements for ${PYVER}"
            pip install -r "requirements-${PYVER}.lock"
          else
            echo "No lockfile for ${PYVER}; installing editable with dev extras"
            pip install -e .[dev]
          fi

          # Test extras we need across suites
          pip install pytest-asyncio pytest-rerunfailures pytest-json-report

      - name: Show pytest & env
        run: |
          python -V
          pytest --version
          echo "PYTEST_ADDOPTS=$PYTEST_ADDOPTS"
          echo "LUKHAS_STRICT_EMIT=$LUKHAS_STRICT_EMIT"
          echo "LUKHAS_STRESS_DURATION=$LUKHAS_STRESS_DURATION"

      - name: Run audit (collection must be clean)
        run: |
          if [ -f scripts/audit_tests.py ]; then python scripts/audit_tests.py; else echo "No audit script found"; fi


      - name: T4 unit contracts
        run: |
          mkdir -p reports
          echo "T4 unit contracts" | tee -a /tmp/t4_success.log
          pytest tests/unit/metrics/ \
            -v --durations=10 \
            --reruns=1 --reruns-delay=0 \
            --json-report --json-report-file=reports/unit.json \
            --junitxml=reports/junit-unit.xml | tee -a /tmp/t4_success.log

          # Time-budget guardrail
          SUITE="Unit contracts"
          BUDGET_SEC=60
          ELAPSED=$(jq -r '.report.duration // empty' reports/unit.json 2>/dev/null || echo "")
          if [ -n "$ELAPSED" ]; then
            python scripts/check_budget.py
          fi

      - name: T4 capability suite
        run: |
          mkdir -p reports
          echo "T4 capability suite" | tee -a /tmp/t4_success.log
          pytest tests/capabilities/ \
            -m capability -v --durations=10 \
            --reruns=1 --reruns-delay=0 \
            --json-report --json-report-file=reports/capabilities.json \
            --junitxml=reports/junit-capabilities.xml | tee -a /tmp/t4_success.log

          # Time-budget guardrail
          SUITE="Capabilities"
          BUDGET_SEC=120
          ELAPSED=$(jq -r '.report.duration // empty' reports/capabilities.json 2>/dev/null || echo "")
          if [ -n "$ELAPSED" ]; then
            python scripts/check_budget.py
          fi

      - name: Consciousness e2e (smoke)
        run: |
          mkdir -p reports
          echo "Consciousness e2e (smoke)" | tee -a /tmp/t4_success.log
          LUKHAS_STRESS_DURATION=1.0 \
          pytest tests/e2e/consciousness/test_consciousness_emergence.py \
            -v -k "signal_cascade_prevention or network_coherence_emergence" \
            --durations=10 \
            --reruns=1 --reruns-delay=0 \
            --json-report --json-report-file=reports/e2e.json \
            --junitxml=reports/junit-e2e.xml | tee -a /tmp/t4_success.log

          # Time-budget guardrail
          SUITE="E2E smoke"
          BUDGET_SEC=60
          ELAPSED=$(jq -r '.report.duration // empty' reports/e2e.json 2>/dev/null || echo "")
          if [ -n "$ELAPSED" ]; then
            python scripts/check_budget.py
          fi

      - name: Fail if any test reran (flake radar)
        run: |
          python scripts/check_reruns.py

      - name: Upload JUnit reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: t4-junit-${{ matrix.python-version }}
          path: reports/*.xml
          if-no-files-found: ignore

      - name: T4 success gate
        if: always()
        run: |
          set -euo pipefail
          LOG=/tmp/t4_success.log
          echo "=== SUCCESS VERIFICATION ==="
          grep -q "T4 unit contracts"    "$LOG"
          grep -q "T4 capability suite"   "$LOG"
          grep -q "Consciousness e2e (smoke)" "$LOG"

          # Ensure "slowest 10 durations" banner appeared for each suite/job
          grep -q "slowest 10 durations" "$LOG"

          echo "✅ T4 pipeline reached all suites with timing summaries"

          # Stability sentinel (catch intermittent slippage)
          # Verify all suites completed without test failures
          if grep -q "FAILED" "$LOG"; then
            echo "❌ Test failures detected in output"
            exit 1
          fi

          # Verify no collection errors
          if grep -q "ERROR collecting" "$LOG"; then
            echo "❌ Test collection errors detected"
            exit 1
          fi

          echo "✅ Stability sentinel: No test failures or collection errors detected"

          # Run performance budget checks
          python scripts/check_perf_budgets.py

          # Validate alert configurations
          python scripts/validate_alerts.py

          echo "✅ T4 Hardening validation complete for Python ${{ matrix.python-version }}"

      - name: Verify success signatures & timings
        run: |
          set -e
          cat /tmp/t4_success.log || true
          # Count "slowest 10 durations" occurrences (should be 3: unit, capability, e2e)
          TIMING_COUNT=$(grep -c "slowest 10 durations" /tmp/t4_success.log || echo "0")
          if [ "$TIMING_COUNT" -lt 3 ]; then
            echo "❌ Expected 3 timing summaries, found $TIMING_COUNT"
            exit 1
          fi
          echo "✅ All timing signatures verified"

      - name: Upload T4 artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: t4-artifacts-${{ matrix.python-version }}
          path: |
            /tmp/t4_success.log
            /tmp/flake_radar.log
            reports/unit.json
            reports/capabilities.json
            reports/e2e.json
            requirements-${{ matrix.python-version }}.lock
          if-no-files-found: ignore