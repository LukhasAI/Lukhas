# GitHub Copilot Tasks - Smoke Test Investigation

## Context
We've implemented 160 bridge module files for the LUKHAS project to support both import styles. However, smoke test collection errors increased from 139 to 215 after recent changes.

## Recent Changes
1. **Commit 0706c3685**: Created 160 bridge files (api/, bio/, core/, etc.)
2. **Commit 1a4eefe8d**: Cherry-picked improvements - added `labs.bridge` to candidates
3. **Commit 0e3035246**: Added AttributeError handling for incomplete labs modules

## Current Issue
- **Smoke tests**: 14/4182 collected, 215 collection errors
- **Main problems**:
  - DeprecationWarnings treated as errors
  - AttributeError handling may have exposed issues
  - FileNotFoundError in tools tests
  - Module import failures

## Tasks for Copilot

### Task 1: Create Investigation Worktree
```bash
git worktree add ../lukhas-smoke-investigation main
cd ../lukhas-smoke-investigation
source .venv/bin/activate || python3 -m venv .venv && source .venv/bin/activate
pip install -e .
```

### Task 2: Analyze Top 10 Collection Errors
Run smoke tests and identify the most common error patterns:
```bash
pytest --collect-only -m "smoke" 2>&1 | grep "ERROR" | head -20 > smoke_errors_sample.txt
```

Analyze and categorize errors:
1. DeprecationWarning as error
2. AttributeError in module imports
3. FileNotFoundError
4. RecursionError
5. Other patterns

### Task 3: Test Bridge Pattern Hypothesis
Check if removing `labs.bridge.*` from candidates reduces errors:

**Test A - Remove labs.bridge.adapters**:
```python
# In bridge/adapters/__init__.py
candidates=(
    "lukhas_website.bridge.adapters",
    "candidate.bridge.adapters",
    # "labs.bridge.adapters",  # COMMENTED OUT
)
```

**Test B - Keep it but improve error handling**:
Look at `_bridgeutils.py` line 38 and see if we can make it more fault-tolerant.

Run tests after each change:
```bash
pytest --collect-only -m "smoke" 2>&1 | grep -c "ERROR"
```

### Task 4: Fix DeprecationWarning Issue
Check consciousness/dream/expand/__init__.py deprecation:
```bash
pytest --collect-only tests/unit/dream/test_noise.py -W ignore::DeprecationWarning 2>&1
```

If this works, we need to configure pytest to not treat DeprecationWarning as error.

### Task 5: Investigate FileNotFoundError
```bash
pytest --collect-only tests/unit/tools/test_todo_tooling.py 2>&1
```

Check what file is missing and why.

### Task 6: Run Comparison Test
Compare error counts:
```bash
# Current main
pytest --collect-only -m "smoke" 2>&1 | grep -c "ERROR" > current_errors.txt

# After fixes
pytest --collect-only -m "smoke" 2>&1 | grep -c "ERROR" > fixed_errors.txt

diff current_errors.txt fixed_errors.txt
```

### Task 7: Document Findings
Create `SMOKE_TEST_INVESTIGATION.md` with:
- Error count breakdown by category
- Root causes identified
- Recommended fixes with priority
- Test results for each hypothesis

### Task 8: Cleanup
```bash
cd /Users/agi_dev/LOCAL-REPOS/Lukhas
git worktree remove ../lukhas-smoke-investigation
```

## Expected Deliverables
1. `smoke_errors_sample.txt` - Top 20 errors
2. `SMOKE_TEST_INVESTIGATION.md` - Analysis and recommendations
3. Error count comparison (before/after each fix)
4. Recommended changes (if any) in a patch file

## Success Criteria
- Understand why errors increased from 139 → 215
- Identify if `labs.bridge.*` addition caused the increase
- Propose concrete fixes to reduce error count
- All work done in worktree, main branch unchanged

## Reference Files
- `BRIDGE_PATTERN_GUIDE.md` - Documents correct bridge pattern
- `scripts/create_bridge_files.py` - Bridge file generator
- `_bridgeutils.py` - Bridge utility functions
- `bridge/adapters/__init__.py` - Example bridge with AttributeError handling

## Priority
**COMPLETED** ✅ - Investigation completed on November 3, 2025. See `SMOKE_TEST_INVESTIGATION.md` for full results.

## Results Summary
- **Bridge changes are NOT the cause** of increased errors (hypothesis rejected)
- **Root cause**: Missing dependencies + structural module gaps
- **Quick win**: Install PyJWT, hypothesis, psutil to reduce errors by 28 (6.4%)
- **Total errors**: 437 → 409 (28 error reduction achieved)
