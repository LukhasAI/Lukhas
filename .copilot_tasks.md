# GitHub Copilot Tasks

## ðŸ”’ PRIORITY: CI/CD Optimization - Week 1 Pilot (2025-11-10)

**Status**: âœ… Security Complete | ðŸ”„ Ready for Pilot Implementation

### Context
127 GitHub Actions workflows (24,708 lines) audited for security and cost optimization. Critical security fix applied, 30-40% CI cost reduction potential identified.

### Completed
- âœ… Security audit of all 127 workflows
- âœ… Fixed unknown hash `c14a0b9e` in 2 MATRIZ workflows
- âœ… Created verification tooling and comprehensive documentation
- âœ… Identified optimization opportunities (concurrency, path filters, retention)

### Week 1 Pilot Tasks

#### Task 1: Create Pilot Worktree
```bash
git worktree add ../Lukhas-ci-pilot-coverage-gates -b task/gha-optimize-pilot-coverage-gates
cd ../Lukhas-ci-pilot-coverage-gates
```

#### Task 2: Optimize coverage-gates.yml
Apply transformations to `.github/workflows/coverage-gates.yml`:
1. Convert hash to `@v4.1.8` tag (line 370)
2. Add concurrency controls (top-level)
3. Add path filters (trigger only on code changes)
4. Add `retention-days: 7` to artifacts
5. Standardize action versions (checkout@v4, setup-python@v5)

**Reference**: `docs/CI_OPTIMIZATION_FINDINGS_2025-11-10.md` section "Pilot Workflow Fix"

#### Task 3: Validate & Measure
```bash
# Validate YAML
python3 -c "import yaml; yaml.safe_load(open('.github/workflows/coverage-gates.yml'))"

# Create PR
gh pr create --title "ci(optimize): Week 1 pilot - coverage-gates workflow optimization" \
  --body "$(cat <<'EOF'
## Summary
- Convert download-artifact hash to v4.1.8 tag
- Add concurrency controls (cancel-in-progress)
- Add path filters (only code changes)
- Add retention-days: 7 to artifacts
- Standardize action versions

## Expected Impact
- 40-50% reduction in workflow triggers
- Cancel old runs on new pushes
- Storage cost reduction (7-day retention)

Reference: docs/CI_OPTIMIZATION_BRIEF_2025-11-10.md
EOF
)"
```

#### Task 4: Monitor Baseline
Track CI minutes before/after pilot:
```bash
# Check GitHub Actions usage dashboard
# Measure: coverage-gates.yml CI minutes (Week 0 vs Week 1)
```

### Documentation References
- **Executive Brief**: `docs/CI_OPTIMIZATION_BRIEF_2025-11-10.md`
- **Implementation Plan**: `docs/CI_OPTIMIZATION_FINDINGS_2025-11-10.md`
- **Complete Audit**: `docs/GITHUB_ACTIONS_REVIEW_2025-11-10.md`
- **Verification Script**: `scripts/ci/verify_download_artifact_hashes.sh`

---

## GitHub Copilot Tasks - Smoke Test Investigation

## Context
We've implemented 160 bridge module files for the LUKHAS project to support both import styles. However, smoke test collection errors increased from 139 to 215 after recent changes.

## Recent Changes
1. **Commit 0706c3685**: Created 160 bridge files (api/, bio/, core/, etc.)
2. **Commit 1a4eefe8d**: Cherry-picked improvements - added `labs.bridge` to candidates
3. **Commit 0e3035246**: Added AttributeError handling for incomplete labs modules

## Current Issue
- **Smoke tests**: 14/4182 collected, 215 collection errors
- **Main problems**:
  - DeprecationWarnings treated as errors
  - AttributeError handling may have exposed issues
  - FileNotFoundError in tools tests
  - Module import failures

## Tasks for Copilot

### Task 1: Create Investigation Worktree
```bash
git worktree add ../lukhas-smoke-investigation main
cd ../lukhas-smoke-investigation
source .venv/bin/activate || python3 -m venv .venv && source .venv/bin/activate
pip install -e .
```

### Task 2: Analyze Top 10 Collection Errors
Run smoke tests and identify the most common error patterns:
```bash
pytest --collect-only -m "smoke" 2>&1 | grep "ERROR" | head -20 > smoke_errors_sample.txt
```

Analyze and categorize errors:
1. DeprecationWarning as error
2. AttributeError in module imports
3. FileNotFoundError
4. RecursionError
5. Other patterns

### Task 3: Test Bridge Pattern Hypothesis
Check if removing `labs.bridge.*` from candidates reduces errors:

**Test A - Remove labs.bridge.adapters**:
```python
# In bridge/adapters/__init__.py
candidates=(
    "lukhas_website.bridge.adapters",
    "candidate.bridge.adapters",
    # "labs.bridge.adapters",  # COMMENTED OUT
)
```

**Test B - Keep it but improve error handling**:
Look at `_bridgeutils.py` line 38 and see if we can make it more fault-tolerant.

Run tests after each change:
```bash
pytest --collect-only -m "smoke" 2>&1 | grep -c "ERROR"
```

### Task 4: Fix DeprecationWarning Issue
Check consciousness/dream/expand/__init__.py deprecation:
```bash
pytest --collect-only tests/unit/dream/test_noise.py -W ignore::DeprecationWarning 2>&1
```

If this works, we need to configure pytest to not treat DeprecationWarning as error.

### Task 5: Investigate FileNotFoundError
```bash
pytest --collect-only tests/unit/tools/test_todo_tooling.py 2>&1
```

Check what file is missing and why.

### Task 6: Run Comparison Test
Compare error counts:
```bash
# Current main
pytest --collect-only -m "smoke" 2>&1 | grep -c "ERROR" > current_errors.txt

# After fixes
pytest --collect-only -m "smoke" 2>&1 | grep -c "ERROR" > fixed_errors.txt

diff current_errors.txt fixed_errors.txt
```

### Task 7: Document Findings
Create `SMOKE_TEST_INVESTIGATION.md` with:
- Error count breakdown by category
- Root causes identified
- Recommended fixes with priority
- Test results for each hypothesis

### Task 8: Cleanup
```bash
cd /Users/agi_dev/LOCAL-REPOS/Lukhas
git worktree remove ../lukhas-smoke-investigation
```

## Expected Deliverables
1. `smoke_errors_sample.txt` - Top 20 errors
2. `SMOKE_TEST_INVESTIGATION.md` - Analysis and recommendations
3. Error count comparison (before/after each fix)
4. Recommended changes (if any) in a patch file

## Success Criteria
- Understand why errors increased from 139 â†’ 215
- Identify if `labs.bridge.*` addition caused the increase
- Propose concrete fixes to reduce error count
- All work done in worktree, main branch unchanged

## Reference Files
- `BRIDGE_PATTERN_GUIDE.md` - Documents correct bridge pattern
- `scripts/create_bridge_files.py` - Bridge file generator
- `_bridgeutils.py` - Bridge utility functions
- `bridge/adapters/__init__.py` - Example bridge with AttributeError handling

## Priority
**COMPLETED** âœ… - Investigation completed on November 3, 2025. See `SMOKE_TEST_INVESTIGATION.md` for full results.

## Results Summary
- **Bridge changes are NOT the cause** of increased errors (hypothesis rejected)
- **Root cause**: Missing dependencies + structural module gaps
- **Quick win**: Install PyJWT, hypothesis, psutil to reduce errors by 28 (6.4%)
- **Total errors**: 437 â†’ 409 (28 error reduction achieved)
