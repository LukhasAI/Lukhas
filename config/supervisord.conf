# LUKHAS AI Supervisor Configuration
# Process management for production deployment

[unix_http_server]
file=/tmp/supervisor.sock
chmod=0700

[supervisord]
logfile=/app/logs/supervisord.log
logfile_maxbytes=50MB
logfile_backups=10
loglevel=info
pidfile=/tmp/supervisord.pid
nodaemon=false
silent=false
minfds=1024
minprocs=200

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///tmp/supervisor.sock

# Main LUKHAS AI Application
[program:lukhas-ai-main]
command=python -m gunicorn --config /app/config/gunicorn.conf.py lukhas.main:app
directory=/app
user=lukhas
numprocs=1
stdout_logfile=/app/logs/lukhas-ai-main.log
stderr_logfile=/app/logs/lukhas-ai-main-error.log
autostart=true
autorestart=true
startsecs=10
startretries=3
exitcodes=0,2
stopsignal=TERM
stopwaitsecs=10
stopasgroup=true
killasgroup=true
priority=100

# MATRIZ Cognitive Node Server
[program:matriz-node]
command=python -m matriz.run_api_server
directory=/app
user=lukhas
numprocs=1
stdout_logfile=/app/logs/matriz-node.log
stderr_logfile=/app/logs/matriz-node-error.log
autostart=true
autorestart=true
startsecs=10
startretries=3
exitcodes=0,2
stopsignal=TERM
stopwaitsecs=15
stopasgroup=true
killasgroup=true
priority=200

# Trinity Framework Guardian Process
[program:guardian-system]
command=python -m lukhas.governance.guardian.daemon
directory=/app
user=lukhas
numprocs=1
stdout_logfile=/app/logs/guardian-system.log
stderr_logfile=/app/logs/guardian-system-error.log
autostart=true
autorestart=true
startsecs=5
startretries=5
exitcodes=0,2
stopsignal=TERM
stopwaitsecs=30
stopasgroup=true
killasgroup=true
priority=50

# Background Memory Manager
[program:memory-manager]
command=python -m lukhas.memory.daemon
directory=/app
user=lukhas
numprocs=1
stdout_logfile=/app/logs/memory-manager.log
stderr_logfile=/app/logs/memory-manager-error.log
autostart=true
autorestart=true
startsecs=5
startretries=3
exitcodes=0,2
stopsignal=TERM
stopwaitsecs=20
stopasgroup=true
killasgroup=true
priority=75

# Consciousness Background Processor
[program:consciousness-processor]
command=python -m lukhas.consciousness.daemon
directory=/app
user=lukhas
numprocs=1
stdout_logfile=/app/logs/consciousness-processor.log
stderr_logfile=/app/logs/consciousness-processor-error.log
autostart=true
autorestart=true
startsecs=10
startretries=3
exitcodes=0,2
stopsignal=TERM
stopwaitsecs=25
stopasgroup=true
killasgroup=true
priority=80

# Health Check Monitor
[program:health-monitor]
command=python -m lukhas.monitoring.health_daemon
directory=/app
user=lukhas
numprocs=1
stdout_logfile=/app/logs/health-monitor.log
stderr_logfile=/app/logs/health-monitor-error.log
autostart=true
autorestart=true
startsecs=5
startretries=3
exitcodes=0,2
stopsignal=TERM
stopwaitsecs=10
stopasgroup=true
killasgroup=true
priority=25

# Log Rotation Process
[program:log-rotator]
command=python -m lukhas.monitoring.log_rotator
directory=/app
user=lukhas
numprocs=1
stdout_logfile=/app/logs/log-rotator.log
stderr_logfile=/app/logs/log-rotator-error.log
autostart=true
autorestart=unexpected
startsecs=5
startretries=3
exitcodes=0,2
stopsignal=TERM
stopwaitsecs=5
stopasgroup=true
killasgroup=true
priority=10

# Group definitions for easy management
[group:lukhas-core]
programs=lukhas-ai-main,guardian-system
priority=100

[group:lukhas-background]
programs=memory-manager,consciousness-processor
priority=200

[group:matriz-system]
programs=matriz-node
priority=300

[group:monitoring]
programs=health-monitor,log-rotator
priority=400

# Event listener for process monitoring
[eventlistener:process-monitor]
command=python -m lukhas.monitoring.process_monitor
directory=/app
user=lukhas
events=PROCESS_STATE
stdout_logfile=/app/logs/process-monitor.log
stderr_logfile=/app/logs/process-monitor-error.log
autostart=true
autorestart=true

# Include additional configuration files
[include]
files = /app/config/supervisor.d/*.conf