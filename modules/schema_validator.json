{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://lukhas.ai/schemas/module_schema.json",
  "title": "LUKHAS Module Schema Validator",
  "description": "JSON Schema for validating LUKHAS module metadata files",
  "type": "object",
  "required": ["identity", "ownership", "contracts", "dependencies", "runtime", "data_and_events", "security", "observability", "test_posture", "risk_and_change", "provenance"],
  "additionalProperties": false,
  "properties": {
    "identity": {
      "type": "object",
      "required": ["name", "layer", "summary", "status"],
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^(candidate|lukhas|products|tools)\\.[a-z_][a-z0-9_]*$",
          "description": "Full module path (lane.module)"
        },
        "layer": {
          "type": "string",
          "enum": ["foundational", "infrastructure", "application", "interface"],
          "description": "Architecture layer classification"
        },
        "summary": {
          "type": "string",
          "minLength": 10,
          "maxLength": 200,
          "description": "Brief module description"
        },
        "status": {
          "type": "string",
          "enum": ["active", "paused", "deprecated"],
          "description": "Current module status"
        },
        "tier": {
          "type": "integer",
          "minimum": 1,
          "maximum": 5,
          "description": "Criticality tier (1=most critical)"
        }
      }
    },
    "discovery": {
      "type": "object",
      "properties": {
        "import_patterns": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Common import patterns"
        },
        "import_aliases": {
          "type": "array", 
          "items": {"type": "string"},
          "description": "Common aliases used"
        },
        "file_patterns": {
          "type": "array",
          "items": {"type": "string"},
          "description": "File glob patterns for module"
        },
        "entry_points": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Main entry point files"
        }
      }
    },
    "ownership": {
      "type": "object",
      "required": ["owner", "lifecycle"],
      "properties": {
        "owner": {
          "type": "string",
          "pattern": "^@[a-zA-Z][a-zA-Z0-9_-]*$",
          "description": "Primary maintainer (@username)"
        },
        "escalation": {
          "type": "string",
          "pattern": "^@[a-zA-Z][a-zA-Z0-9_-]*$",
          "description": "Escalation contact"
        },
        "lifecycle": {
          "type": "string",
          "enum": ["experimental", "evolving", "stable", "deprecated"],
          "description": "Development lifecycle stage"
        },
        "last_review": {
          "type": "string",
          "format": "date-time",
          "description": "Last review timestamp (ISO 8601)"
        },
        "next_review": {
          "type": "string", 
          "format": "date-time",
          "description": "Next scheduled review"
        },
        "promotion_rules": {
          "type": "object",
          "properties": {
            "from_lane": {"type": "string"},
            "to_lane": {"type": "string"},
            "required_checks": {
              "type": "array",
              "items": {"type": "string"}
            },
            "min_coverage": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            },
            "min_uptime_days": {
              "type": "integer",
              "minimum": 0
            }
          }
        }
      }
    },
    "contracts": {
      "type": "object",
      "required": ["api"],
      "properties": {
        "api": {
          "type": "object",
          "required": ["surface", "version"],
          "properties": {
            "surface": {
              "type": "array",
              "items": {"type": "string"},
              "description": "Public API surface"
            },
            "version": {
              "type": "string",
              "pattern": "^v\\d+\\.\\d+(\\.\\d+)?$",
              "description": "API version (vX.Y.Z)"
            },
            "schema_version": {
              "type": "string",
              "pattern": "^\\d+\\.\\d+$",
              "description": "Schema format version"
            },
            "compatibility": {
              "type": "object",
              "properties": {
                "backward": {"type": "boolean"},
                "forward": {
                  "type": "string",
                  "enum": ["none", "patch", "minor", "major"]
                }
              }
            }
          }
        },
        "invariants": {
          "type": "array",
          "items": {"type": "string"},
          "description": "System invariants and guarantees"
        },
        "error_taxonomy": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["code", "retriable"],
            "properties": {
              "code": {"type": "string"},
              "retriable": {"type": "boolean"},
              "http_status": {"type": "integer"},
              "backoff": {"type": "string"}
            }
          }
        }
      }
    },
    "dependencies": {
      "type": "object",
      "required": ["internal", "external"],
      "properties": {
        "internal": {
          "type": "object",
          "properties": {
            "requires": {
              "type": "array",
              "items": {"type": "string"}
            },
            "provides": {
              "type": "array", 
              "items": {"type": "string"}
            },
            "circular_dependencies": {
              "type": "array",
              "items": {"type": "string"}
            },
            "weak_dependencies": {
              "type": "array",
              "items": {"type": "string"}
            }
          }
        },
        "external": {
          "type": "object",
          "properties": {
            "libs": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["name", "version", "license"],
                "properties": {
                  "name": {"type": "string"},
                  "version": {"type": "string"},
                  "license": {"type": "string"},
                  "purpose": {"type": "string"}
                }
              }
            },
            "services": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["name", "criticality"],
                "properties": {
                  "name": {"type": "string"},
                  "criticality": {
                    "type": "string", 
                    "enum": ["low", "medium", "high", "critical"]
                  },
                  "endpoint_env": {"type": "string"},
                  "fallback": {"type": "string"}
                }
              }
            }
          }
        },
        "coupling_metrics": {
          "type": "object",
          "properties": {
            "afferent": {"type": "integer", "minimum": 0},
            "efferent": {"type": "integer", "minimum": 0},
            "instability_index": {"type": "number", "minimum": 0, "maximum": 1},
            "abstractness": {"type": "number", "minimum": 0, "maximum": 1}
          }
        }
      }
    },
    "runtime": {
      "type": "object",
      "required": ["processes", "config", "resources"],
      "properties": {
        "processes": {
          "type": "object",
          "properties": {
            "entrypoints": {
              "type": "array",
              "items": {"type": "string"}
            },
            "concurrency_model": {
              "type": "string",
              "enum": ["thread", "async", "process", "hybrid"]
            },
            "scaling_policy": {
              "type": "string",
              "enum": ["horizontal", "vertical", "none"]
            }
          }
        },
        "config": {
          "type": "object",
          "properties": {
            "files": {
              "type": "array",
              "items": {"type": "string"}
            },
            "env_vars_required": {
              "type": "array",
              "items": {"type": "string"}
            },
            "env_vars_optional": {
              "type": "array",
              "items": {"type": "string"}
            },
            "feature_flags": {
              "type": "array", 
              "items": {"type": "string"}
            },
            "secrets": {
              "type": "array",
              "items": {"type": "string"}
            }
          }
        },
        "resources": {
          "type": "object",
          "properties": {
            "cpu_limit": {"type": "string"},
            "mem_limit": {"type": "string"},
            "disk_limit": {"type": "string"},
            "network_bandwidth": {"type": "string"}
          }
        }
      }
    },
    "data_and_events": {
      "type": "object",
      "properties": {
        "data_classes": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["name", "schema_ref"],
            "properties": {
              "name": {"type": "string"},
              "schema_ref": {"type": "string"},
              "description": {"type": "string"}
            }
          }
        },
        "emits": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["topic", "schema_ref"],
            "properties": {
              "topic": {"type": "string"},
              "schema_ref": {"type": "string"},
              "frequency": {
                "type": "string",
                "enum": ["low", "medium", "high"]
              },
              "retention": {"type": "string"}
            }
          }
        },
        "consumes": {
          "type": "array",
          "items": {
            "type": "object", 
            "required": ["topic", "schema_ref"],
            "properties": {
              "topic": {"type": "string"},
              "schema_ref": {"type": "string"},
              "required": {"type": "boolean"}
            }
          }
        },
        "pii": {
          "type": "object",
          "required": ["contains"],
          "properties": {
            "contains": {"type": "boolean"},
            "notes": {"type": "string"},
            "classification": {
              "type": "string",
              "enum": ["public", "internal", "confidential", "restricted"]
            }
          }
        }
      }
    },
    "security": {
      "type": "object",
      "required": ["secrets", "authz_model"],
      "properties": {
        "secrets": {
          "type": "object",
          "properties": {
            "sources": {
              "type": "array",
              "items": {"type": "string"}
            },
            "files": {
              "type": "array",
              "items": {"type": "string"}
            },
            "rotation_frequency": {"type": "string"}
          }
        },
        "authz_model": {"type": "string"},
        "authentication": {
          "type": "object",
          "properties": {
            "required": {"type": "boolean"},
            "methods": {
              "type": "array",
              "items": {"type": "string"}
            },
            "token_scope": {
              "type": "array", 
              "items": {"type": "string"}
            }
          }
        },
        "compliance": {
          "type": "object",
          "properties": {
            "data_classification": {
              "type": "string",
              "enum": ["public", "internal", "confidential", "restricted"]
            },
            "regulations": {
              "type": "array",
              "items": {"type": "string"}
            },
            "cve_watch": {
              "type": "array",
              "items": {"type": "string"}
            }
          }
        }
      }
    },
    "observability": {
      "type": "object",
      "required": ["logs", "metrics", "slos"],
      "properties": {
        "logs": {
          "type": "object",
          "properties": {
            "format": {
              "type": "string",
              "enum": ["structured_json", "plaintext"]
            },
            "level": {
              "type": "string", 
              "enum": ["debug", "info", "warn", "error"]
            },
            "destination": {
              "type": "string",
              "enum": ["stdout", "file", "syslog"]
            },
            "retention": {"type": "string"}
          }
        },
        "metrics": {
          "type": "object",
          "required": ["exporter", "key_metrics"],
          "properties": {
            "exporter": {
              "type": "string",
              "enum": ["prometheus", "datadog", "custom"]
            },
            "port": {"type": "integer"},
            "key_metrics": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["name", "target"],
                "properties": {
                  "name": {"type": "string"},
                  "target": {"type": "string"},
                  "alert_threshold": {"type": "string"},
                  "type": {"type": "string"}
                }
              }
            }
          }
        },
        "slos": {
          "type": "object",
          "properties": {
            "latency_p95_ms": {"type": "number"},
            "latency_p99_ms": {"type": "number"},
            "error_rate_pct": {"type": "number"},
            "availability_pct": {"type": "number"},
            "throughput_rps": {"type": "number"}
          }
        }
      }
    },
    "test_posture": {
      "type": "object",
      "required": ["coverage", "tests"],
      "properties": {
        "coverage": {
          "type": "object",
          "required": ["current"],
          "properties": {
            "current": {"type": "number", "minimum": 0, "maximum": 1},
            "target": {"type": "number", "minimum": 0, "maximum": 1},
            "threshold": {"type": "number", "minimum": 0, "maximum": 1}
          }
        },
        "tests": {
          "type": "object",
          "properties": {
            "unit": {"type": "integer", "minimum": 0},
            "integration": {"type": "integer", "minimum": 0},
            "e2e": {"type": "integer", "minimum": 0},
            "property": {"type": "integer", "minimum": 0},
            "smoke": {"type": "integer", "minimum": 0},
            "load": {"type": "integer", "minimum": 0},
            "chaos": {"type": "integer", "minimum": 0},
            "security": {"type": "integer", "minimum": 0}
          }
        },
        "quality_gates": {
          "type": "object",
          "properties": {
            "code_quality_score": {"type": "number", "minimum": 1, "maximum": 10},
            "technical_debt_ratio": {"type": "number", "minimum": 0, "maximum": 1},
            "cyclomatic_complexity": {"type": "integer", "minimum": 1},
            "duplicate_code_pct": {"type": "number", "minimum": 0, "maximum": 100}
          }
        }
      }
    },
    "risk_and_change": {
      "type": "object",
      "required": ["risks"],
      "properties": {
        "risks": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["id", "title", "likelihood", "impact"],
            "properties": {
              "id": {"type": "string"},
              "title": {"type": "string"},
              "likelihood": {
                "type": "string",
                "enum": ["low", "medium", "high"]
              },
              "impact": {
                "type": "string", 
                "enum": ["low", "medium", "high", "critical"]
              },
              "risk_score": {"type": "integer", "minimum": 1, "maximum": 25},
              "mitigation": {"type": "string"},
              "owner": {"type": "string"},
              "status": {
                "type": "string",
                "enum": ["open", "mitigated", "accepted", "closed"]
              }
            }
          }
        },
        "change_control": {
          "type": "object",
          "properties": {
            "change_approval_required": {"type": "boolean"},
            "approval_threshold": {
              "type": "string",
              "enum": ["patch", "minor", "major"]
            },
            "reviewers": {
              "type": "array",
              "items": {"type": "string"}
            },
            "automated_checks": {
              "type": "array", 
              "items": {"type": "string"}
            }
          }
        }
      }
    },
    "provenance": {
      "type": "object",
      "required": ["schema_version", "last_updated"],
      "properties": {
        "schema_version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+$"
        },
        "last_updated": {
          "type": "string",
          "format": "date-time"
        },
        "last_review": {
          "type": "string",
          "format": "date-time"
        },
        "source_paths": {
          "type": "array",
          "items": {"type": "string"}
        },
        "generated_by": {
          "type": "object",
          "properties": {
            "tool": {"type": "string"},
            "version": {"type": "string"},
            "args": {"type": "string"},
            "timestamp": {
              "type": "string",
              "format": "date-time"
            }
          }
        },
        "scope_hash": {"type": "string"},
        "contributors": {
          "type": "array",
          "items": {"type": "string"}
        },
        "validation": {
          "type": "object",
          "properties": {
            "schema_valid": {"type": "boolean"},
            "last_validated": {
              "type": "string",
              "format": "date-time"
            },
            "validator_version": {"type": "string"}
          }
        }
      }
    },
    "extensions": {
      "type": "object",
      "description": "Custom extensions for specific use cases",
      "additionalProperties": true
    }
  }
}