# Matrix Tracks Service Level Objectives (SLOs)
#
# These SLOs track the health and reliability of the Matrix Tracks system
# to ensure cultural adoption and prevent degradation of verification rigor.
#
# Monitored weekly and reported to the team via automated reports.

version: "1.0"
measurement_window: "7d"  # Weekly measurement window
confidence_interval: "95%"

slos:
  # SLO 1: Gate Infrastructure Reliability
  - name: "gate_flakiness_rate"
    description: "Percentage of CI runs that fail due to infrastructure issues (not code)"
    target: "<0.5%"
    measurement:
      numerator: "CI runs failed due to OSV scanner timeout, schema download failure, or tool installation error"
      denominator: "Total CI runs on matrix contract changes"
    severity: "high"
    owner: "platform-team"
    detection:
      - "OSV scanner returns non-zero exit code without finding vulnerabilities"
      - "jsonschema package installation failures"
      - "SBOM validation tool download timeouts"
      - "GitHub Actions infrastructure failures (workflow timeout, runner unavailability)"
    remediation:
      - "Improve OSV scanner fallback logic"
      - "Add retry logic for tool downloads"
      - "Pre-cache dependencies in container images"

  # SLO 2: Vulnerability Response Time
  - name: "osv_mean_time_to_green"
    description: "Mean time from High-severity vulnerability detection to fix deployment"
    target: "<48h"
    measurement:
      numerator: "Total hours from OSV scan detecting high-severity vulnerability to PR merged fixing it"
      denominator: "Number of high-severity vulnerabilities detected"
    severity: "high"
    owner: "security-team"
    detection:
      - "OSV scan reports high-severity vulnerabilities in SBOM"
      - "security.osv_high gate shows value > 0"
    remediation:
      - "Automated dependency update PRs"
      - "Security team notification alerts"
      - "Emergency gate bypass process for security fixes"
    exclusions:
      - "Vulnerabilities in development-only dependencies"
      - "False positive vulnerabilities (confirmed by security team)"

  # SLO 3: Telemetry Compliance
  - name: "telemetry_compliance_rate"
    description: "Percentage of PRs that emit all required OpenTelemetry semantic convention attributes"
    target: ">95%"
    measurement:
      numerator: "PRs passing telemetry smoke tests with all required semconv attributes"
      denominator: "Total PRs modifying code that should emit telemetry"
    severity: "medium"
    owner: "observability-team"
    detection:
      - "Telemetry smoke tests fail in CI"
      - "Missing required attributes: code.function, lukhas.module, otel.semconv.version"
      - "Incorrect attribute value formats"
    remediation:
      - "Improve telemetry fixture generation"
      - "Add pre-commit hooks for telemetry validation"
      - "Developer education on semconv requirements"

# Additional tracking metrics (not SLOs, but monitored)
metrics:
  - name: "track_adoption_velocity"
    description: "Rate of modules adopting new Matrix Tracks"
    measurement: "New track adoptions per month"
    target: "informational"

  - name: "demo_parity_drift"
    description: "Percentage of demos that fail parity checks with production tools"
    measurement: "Demo failures / Total demo runs"
    target: "informational"

  - name: "gate_false_positive_rate"
    description: "Percentage of gate failures that are overridden by human judgment"
    measurement: "Gate overrides / Total gate failures"
    target: "informational"

  - name: "contract_schema_evolution_rate"
    description: "Frequency of breaking changes to matrix schema"
    measurement: "Schema version updates per quarter"
    target: "informational"

# Alerting configuration
alerts:
  - slo: "gate_flakiness_rate"
    threshold: "0.3%"  # Alert before SLO violation
    channels: ["#matrix-alerts", "@platform-team"]
    frequency: "immediate"

  - slo: "osv_mean_time_to_green"
    threshold: "36h"  # Alert before SLO violation
    channels: ["#security-alerts", "@security-team"]
    frequency: "immediate"

  - slo: "telemetry_compliance_rate"
    threshold: "90%"  # Alert before SLO violation
    channels: ["#observability", "@observability-team"]
    frequency: "daily"

# Reporting schedule
reporting:
  weekly:
    - slo_summary_report
    - track_adoption_scoreboard
    - gate_failure_analysis
  monthly:
    - slo_trend_analysis
    - cultural_health_metrics
    - remediation_effectiveness_review

# Cultural health indicators
cultural_health:
  indicators:
    - name: "developer_net_promoter_score"
      description: "How likely are developers to recommend Matrix Tracks to other teams?"
      measurement: "Monthly NPS survey"
      target: ">7/10"

    - name: "pr_velocity_impact"
      description: "Change in median PR time-to-merge after Matrix Tracks adoption"
      measurement: "Median PR merge time (before vs after adoption)"
      target: "<20% increase"

    - name: "security_incident_reduction"
      description: "Reduction in security incidents in modules with full track adoption"
      measurement: "Security incidents per module per quarter"
      target: ">50% reduction"

# Success criteria for track maturity phases
maturity_phases:
  report_only:
    criteria:
      - "Track generates reports without failing CI"
      - "Data collection stable for 30 days"
      - "Team familiar with track concepts"

  soft_gate:
    criteria:
      - "Track violations generate warnings, not failures"
      - "Warning rate <5% over 30 days"
      - "Team has remediation runbook"

  hard_gate:
    criteria:
      - "Track violations block merges"
      - "False positive rate <1% over 90 days"
      - "Emergency bypass process documented"