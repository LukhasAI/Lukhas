# Jules-06: API Gateway & External Services Test Specification
agent_id: "Jules-06"
priority: "MEDIUM"
tier: "tier3"
estimated_tests: 15

# Module Assignment
modules:
  primary:
    - "candidate/bridge/api_gateway/unified_api_gateway.py"
    - "candidate/bridge/api/"
    - "candidate/bridge/external_adapters/"
    - "candidate/bridge/adapters/"
  
  supporting:
    - "candidate/bridge/authentication/"
    - "candidate/bridge/rate_limiting/"
    - "candidate/bridge/service_discovery/"

# Test Requirements
tests:
  api_gateway:
    - name: "test_request_routing"
      description: "Test API request routing and path matching"
      input: {"request": "object", "routing_rules": "array", "service_map": "object"}
      expected: {"route_matched": "bool", "target_service": "string", "routing_params": "object"}
      tags: ["tier3", "api_gateway", "routing"]
    
    - name: "test_rate_limiting"
      description: "Test API rate limiting and throttling"
      input: {"client_id": "string", "request_rate": "number", "rate_limits": "object"}
      expected: {"request_allowed": "bool", "remaining_quota": "number", "reset_time": "datetime"}
      tags: ["tier3", "api_gateway", "rate_limiting"]
    
    - name: "test_api_versioning"
      description: "Test API version management and compatibility"
      input: {"api_version": "string", "endpoint": "string", "compatibility_matrix": "object"}
      expected: {"version_supported": "bool", "compatibility_mode": "string", "deprecation_warning": "bool"}
      tags: ["tier3", "api_gateway", "versioning"]

  external_adapters:
    - name: "test_gmail_adapter"
      description: "Test Gmail API adapter functionality"
      input: {"gmail_request": "object", "oauth_credentials": "object", "operation": "string"}
      expected: {"operation_success": "bool", "response_data": "object", "rate_limit_remaining": "number"}
      tags: ["tier3", "adapters", "gmail"]
    
    - name: "test_dropbox_adapter"
      description: "Test Dropbox API adapter functionality"
      input: {"dropbox_request": "object", "auth_token": "string", "file_operation": "string"}
      expected: {"operation_success": "bool", "file_metadata": "object", "sync_status": "string"}
      tags: ["tier3", "adapters", "dropbox"]
    
    - name: "test_oauth_integration"
      description: "Test OAuth2/OIDC integration flows"
      input: {"oauth_provider": "string", "auth_request": "object", "callback_url": "string"}
      expected: {"auth_success": "bool", "access_token": "string", "token_expires": "datetime"}
      tags: ["tier3", "oauth", "authentication"]

  service_integration:
    - name: "test_service_discovery"
      description: "Test dynamic service discovery mechanisms"
      input: {"service_name": "string", "discovery_config": "object", "health_check": "bool"}
      expected: {"service_found": "bool", "service_endpoints": "array", "health_status": "string"}
      tags: ["tier3", "service_discovery", "integration"]
    
    - name: "test_circuit_breaker_patterns"
      description: "Test circuit breaker fault tolerance patterns"
      input: {"service_health": "object", "failure_threshold": "number", "recovery_timeout": "number"}
      expected: {"circuit_state": "string", "requests_blocked": "bool", "recovery_attempted": "bool"}
      tags: ["tier3", "circuit_breaker", "resilience"]
    
    - name: "test_retry_mechanisms"
      description: "Test intelligent retry strategies for external calls"
      input: {"failed_request": "object", "retry_policy": "object", "backoff_strategy": "string"}
      expected: {"retry_attempted": "bool", "backoff_delay": "number", "max_retries_reached": "bool"}
      tags: ["tier3", "retry", "resilience"]

  security_features:
    - name: "test_api_authentication"
      description: "Test API gateway authentication mechanisms"
      input: {"auth_method": "string", "credentials": "object", "protected_resource": "string"}
      expected: {"auth_successful": "bool", "user_identity": "object", "permissions": "array"}
      tags: ["tier3", "security", "authentication"]
    
    - name: "test_request_validation"
      description: "Test request validation and sanitization"
      input: {"request_payload": "object", "validation_schema": "object", "sanitization_rules": "array"}
      expected: {"validation_passed": "bool", "sanitized_payload": "object", "violations": "array"}
      tags: ["tier3", "security", "validation"]

# Performance Requirements
performance:
  request_routing: "< 10ms p95"
  external_api_calls: "< 2s p95"
  rate_limiting: "< 5ms p95"
  service_discovery: "< 50ms p95"

# Quality Requirements
quality:
  api_availability: "> 99.9%"
  external_adapter_reliability: "> 95%"
  security_validation: "> 99%"

# Coverage Targets
coverage:
  line_coverage: 80%
  branch_coverage: 75%
  api_endpoints: 90%

# Dependencies
dependencies:
  - "pytest"
  - "pytest-asyncio"
  - "aiohttp"
  - "fastapi"
  - "requests"
  - "oauthlib"
  - "responses"

# Test Environment
environment:
  mock_services: "wiremock"
  oauth_provider: "mock_oauth"
  external_apis: "mocked"
  rate_limiter: "redis_mock"

# Success Criteria
success_criteria:
  - "All API gateway features tested"
  - "External adapter integration verified"
  - "Security mechanisms validated"
  - "Performance targets achieved"
  - "Fault tolerance proven"

# Deliverables
deliverables:
  - "tests/unit/bridge/api_gateway/"
  - "tests/integration/bridge/adapters/"
  - "tests/performance/api_gateway/"
  - "API gateway performance report"
  - "External service integration validation"

# --- T4 Determinism & Policy (added) ---
determinism:
  env:
    TZ: "UTC"
    PYTHONHASHSEED: "0"
    NUMBA_DISABLE_JIT: "1"
  pytest:
    addopts: ["-q", "-ra", "-s", "--maxfail=1", "--strict-markers", "--durations=10"]
    markers_enforced: true  # tests without explicit tier/owner are rejected
  flake_policy:
    quarantine_marker: "quarantine"
    fail_if_quarantine_fails_twice: true

# --- T4 API Gateway Invariants (added) ---
invariants:
  deterministic_routing: true        # same inputs → same target service
  idempotent_retries: true           # safe retries on network errors
  schema_validation_required: true   # request/response validated against OpenAPI
  pii_never_in_logs: true
  authz_must_precede_routing: true   # authorization checked before forwarding
  rate_limit_clock: "monotonic"      # rate limiting uses monotonic time source

# --- T4 Golden Artifacts & Contracts (added) ---
goldens:
  openapi_spec: "AUDIT/API/openapi.yaml"
  contracts_dir: "tests/golden/tier1/api_gateway/"
  required_files:
    - "contract_route_resolution.json"     # input route → expected target
    - "contract_rate_limit_headers.json"   # shape for X-RateLimit-* headers
    - "contract_oauth_tokens.json"         # token response minimal shape
  validators:
    - name: "api_contract_validator"
      module: "tools/tests/validators/api_contract_validator.py"
      ensures:
        - "status in {200,201,202,204,400,401,403,404,429,500}"
        - "no PII in logs or error payloads"

# --- T4 Acceptance Gates (added) ---
acceptance_gates:
  - name: "lane_integrity"
    check: "lint-imports"
    must_pass: true
  - name: "ruff_syntax"
    check: "python3 -m ruff check --select E9,F63,F7,F82 lukhas candidate"
    must_pass: true
  - name: "gateway_tier3_suite"
    check: "TZ=UTC PYTHONHASHSEED=0 pytest -m 'tier3 and api_gateway and not quarantine' -q"
    must_pass: true
  - name: "openapi_contracts"
    check: "python3 tools/tests/validators/api_contract_validator.py --spec AUDIT/API/openapi.yaml --goldens tests/golden/tier1/api_gateway"
    must_pass: true
  - name: "perf_budget"
    check: "python3 tools/tests/perf_budget.py --suite api-gateway --max-seconds 90"
    must_pass: false

# --- T4 Runbook (added) ---
runbook:
  quick_checks:
    - "make test-fast"
    - "PYTHONHASHSEED=0 TZ=UTC pytest -m 'api_gateway and tier3' -q"
  local_debug:
    - "pytest tests -k 'api_gateway or adapters' -vv --maxfail=1"
    - "uvicorn serve.main:app --reload & sleep 2 && curl -sf http://localhost:8000/healthz"
  contract_smoke:
    - "python3 tools/tests/validators/api_contract_validator.py --spec AUDIT/API/openapi.yaml --one-shot"

# --- T4 Ownership & Escalation (added) ---
ownership:
  codeowners:
    - path: "candidate/bridge/api_gateway/"
      owners: ["@LukhasAI/bridge"]
    - path: "lukhas/core/observability/"
      owners: ["@LukhasAI/observability"]
  escalation:
    pager: "#matriz-oncall"
    docs: "AUDIT/SYSTEM_MAP.md#api-gateway"

# --- T4 Risks & Out-of-Scope (added) ---
risks:
  - "Ambiguous routing rules causing non-determinism"
  - "Third-party OAuth quirks introducing flaky flows"
  - "Rate limiter time-source drift under load"
out_of_scope:
  - "Real provider load testing"
  - "End-to-end browser UI flows (covered by E2E team)"

# --- T4 Agent Prompts (added) ---
agent_prompts:
  jules06_system_prompt: |
    You own API gateway & adapters tests. Enforce invariants: deterministic routing, schema validation, idempotent retries, no-PII logs.
    Prefer contract/golden tests using the OpenAPI spec. Minimize mocks; simulate failures deterministically.
  jules06_task_prompt: |
    Implement tests listed under `tests:` ensuring golden validators pass and acceptance gates remain green.
    If behavior diverges from the OpenAPI spec, open an issue tagged `api-gateway:contract-gap` with evidence.

# --- T4 Metadata (added) ---
metadata:
  schema_version: 1
  last_updated_by: "T4-lens"
  last_updated_at: "{{AUTO-UPDATE-ON-COMMIT}}"