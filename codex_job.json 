

{
  "jobName": "LUKHΛS Codex Batch Worker",
  "version": "2025-09-18T00:00:00Z",
  "repoRoot": ".",
  "description": "Sandboxed, repo-wide chores for the 0.01% Surgeon plan. Codex should create only boilerplate/scaffolding and non-risky adapters, then open a draft PR with logs and artifacts.",
  "environment": {
    "LUKHAS_EXPERIMENTAL": "1",
    "LUKHAS_LANE": "candidate",
    "ENFORCE_ETHICS_DSL": "0",
    "ENABLE_LLM_GUARDRAIL": "1"
  },
  "acceptanceGates": {
    "driftDeltaMax": 0.02,
    "latencyOverheadP95Max": 0.05,
    "containmentIsolationMin": 0.997,
    "requirePolicyLedger": true
  },
  "refusePatterns": [
    "import glyph",
    "from glyph",
    "candidate.core.common.glyph"
  ],
  "writeScopes": [
    "core/**",
    "candidate/**",
    "oneiric_core/**",
    "identity/**",
    "ethics/**",
    "monitoring/**",
    "docs/**",
    "dashboards/**",
    "tools/**",
    "Makefile"
  ],
  "safetyPolicy": {
    "requireHumanApproval": true,
    "maxFilesPerTask": 12,
    "oneFeaturePerPR": true,
    "disallowWritesOutsideScopes": true
  },
  "artifacts": {
    "baseDir": "codex_artifacts/",
    "testLog": "codex_artifacts/test.log",
    "sloReport": "artifacts/slo/slo_report.json",
    "chaosReport": "artifacts/chaos/fold_fuzz_report.json",
    "matrizReport": "artifacts/matriz/convergence_failures.json",
    "policyLedgerGlob": "var/policy_ledger/*.ndjson"
  },
  "preFlight": [
    "uv pip install -r requirements.txt || pip install -r requirements.txt",
    "pytest -q -k smoke || true"
  ],
  "postFlight": [
    "pytest -q | tee codex_artifacts/test.log"
  ],
  "tasks": [
    {
      "id": "oneiric-drift-dream-cli",
      "source": ".copilot_tasks.md §5 (18) Drift Dream Test",
      "summary": "Scaffold CLI tool to probe symbol drift via dream generation.",
      "creates": [
        "oneiric_core/tools/drift_dream_test.py",
        "docs/oneiric/DRIFT_DREAM_TEST.md"
      ],
      "edits": [
        "Makefile"
      ],
      "instructions": [
        "Create CLI `oneiric_core/tools/drift_dream_test.py` with argparse: --symbol, --user, --seed, --recursive.",
        "Call existing Oneiric API functions if present; otherwise stub with TODOs and clear docstrings.",
        "Emit a JSON report to stdout and write to codex_artifacts/dream_drift_report.json.",
        "Update Makefile with target `oneiric-drift-test` that runs the CLI with example args."
      ],
      "commands": [
        "python oneiric_core/tools/drift_dream_test.py --symbol LOYALTY --user demo --seed 7 || true",
        "pytest -q oneiric_core/tests || true"
      ],
      "doneWhen": [
        "CLI runs without import errors.",
        "Report file exists with keys: symbol, driftDelta, top_symbols, user."
      ]
    },
    {
      "id": "collapse-simulator-cli",
      "source": ".copilot_tasks.md §6 (3) Post-collapse TraceRepair + compound simulator",
      "summary": "Add a small CLI to simulate collapse + repair across memory/ethical/identity scenarios.",
      "creates": [
        "lukhas/tools/collapse_simulator.py",
        "docs/collapse/COLLAPSE_SIMULATOR.md"
      ],
      "instructions": [
        "Implement CLI with subcommands: memory, ethical, identity.",
        "Each subcommand should call the TraceRepairEngine hook if available, else print a stub notice.",
        "Accept --iterations and --noise arguments; write results to codex_artifacts/collapse_simulator.json."
      ],
      "commands": [
        "python lukhas/tools/collapse_simulator.py memory --iterations 5 --noise 0.1 || true"
      ],
      "doneWhen": [
        "Simulator runs and writes a JSON summary with fields: scenario, iterations, repairsInvoked."
      ]
    },
    {
      "id": "dashboards-policy-panels",
      "source": ".copilot_tasks.md §2 (Governance metrics)",
      "summary": "Append Grafana panels for policy denials and promotion success rate.",
      "edits": [
        "dashboards/lukhas_ops.json",
        "docs/ops/observability.md"
      ],
      "instructions": [
        "If dashboards/lukhas_ops.json does not exist, create a minimal dashboard JSON with a single row named 'Governance'.",
        "Add two panels: (1) policy denials/min using rate(lukhas_replay_policy_denials_total[5m]); (2) promotion success rate: rate(lukhas_promotion_success_total[5m]) / rate(lukhas_promotion_attempts_total[5m]).",
        "Include a templating variable 'lane' to filter by LUKHAS_LANE."
      ],
      "commands": [
        "echo 'validate dashboards manually or via your existing linter'",
        "pytest -q tests/policy/test_ledger.py || true"
      ],
      "doneWhen": [
        "JSON contains two panels with the described PromQL expressions.",
        "Docs mention how to import the dashboard and the required Prometheus metrics."
      ]
    },
    {
      "id": "llm-guardrail-scaffold",
      "source": ".copilot_tasks.md §3 (23) LLM Guardrail",
      "summary": "Create minimal guardrail wrapper and tests skeleton; no business logic changes.",
      "creates": [
        "core/bridge/llm_guardrail.py",
        "tests/bridge/test_llm_guardrail.py",
        "docs/bridge/LLM_GUARDRAIL.md"
      ],
      "instructions": [
        "Implement function call_llm(prompt: str, schema: dict) -> dict that validates a candidate JSON using jsonschema; on failure, return {'_rejected': True, 'reason': 'schema'} without calling any model.",
        "Provide a stub injection point for the actual LLM call guarded by ENABLE_LLM_GUARDRAIL.",
        "Write a minimal test that passes a bad payload and asserts _rejected=True."
      ],
      "commands": [
        "pytest -q tests/bridge/test_llm_guardrail.py"
      ],
      "doneWhen": [
        "Test passes locally and guardrail module imports without side effects."
      ]
    }
  ],
  "pullRequest": {
    "titlePrefix": "[Codex] ",
    "base": "main",
    "labels": ["codex", "batch", "scaffolding"],
    "draft": true,
    "bodyTemplate": "This PR was generated from codex.job.json task '{{TASK_ID}}'. It includes only scaffolding/boilerplate as per writeScopes and refuses legacy glyph imports. See codex_artifacts/test.log for test output."
  }
}